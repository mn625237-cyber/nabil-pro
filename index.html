<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0f1e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Nabil Pro">
<title>Nabil Pro ğŸ›µ</title>
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
/* ============================================================
   DESIGN SYSTEM
   ============================================================ */
:root {
  --bg: #0a0f1e;
  --bg2: #111827;
  --bg3: #1a2236;
  --card: rgba(17,24,39,0.95);
  --card-border: rgba(255,255,255,0.07);
  --text: #f1f5f9;
  --text2: #94a3b8;
  --text3: #64748b;
  --primary: #f97316;
  --primary-dark: #c2410c;
  --primary-glow: rgba(249,115,22,0.2);
  --success: #22c55e;
  --success-bg: rgba(34,197,94,0.1);
  --danger: #ef4444;
  --danger-bg: rgba(239,68,68,0.1);
  --visa: #818cf8;
  --cash: #22c55e;
  --radius: 18px;
  --radius-sm: 12px;
  --shadow: 0 8px 32px rgba(0,0,0,0.5);
  --nav-h: 68px;
  --header-h: 62px;
}
[data-theme="light"] {
  --bg: #f1f5f9;
  --bg2: #ffffff;
  --bg3: #e2e8f0;
  --card: #ffffff;
  --card-border: rgba(0,0,0,0.06);
  --text: #0f172a;
  --text2: #475569;
  --text3: #94a3b8;
  --shadow: 0 4px 20px rgba(0,0,0,0.1);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { font-family:'Cairo',sans-serif; background:var(--bg); color:var(--text); height:100dvh; overflow:hidden; }
input,textarea,select { font-family:'Cairo',sans-serif; }

/* ============================================================
   SCREEN MANAGEMENT
   ============================================================ */
.screen { display:none; width:100%; height:100dvh; position:fixed; inset:0; z-index:10; }
.screen.active { display:flex; }

/* ============================================================
   OFFLINE SCREEN
   ============================================================ */
#offlineScreen {
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:var(--bg);
  gap:20px;
  padding:40px;
}
.offline-icon {
  width:100px; height:100px;
  background:rgba(239,68,68,0.1);
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:48px;
  animation: pulse-red 2s infinite;
}
@keyframes pulse-red {
  0%,100% { box-shadow:0 0 0 0 rgba(239,68,68,0.3); }
  50% { box-shadow:0 0 0 20px rgba(239,68,68,0); }
}
.offline-title { font-size:22px; font-weight:700; color:var(--text); }
.offline-sub { font-size:14px; color:var(--text2); text-align:center; line-height:1.6; }
.offline-btn {
  background:var(--primary); color:#fff; border:none;
  padding:14px 32px; border-radius:50px; font-size:15px;
  font-weight:700; font-family:'Cairo',sans-serif; cursor:pointer;
  margin-top:10px;
}

/* ============================================================
   LOADING SCREEN
   ============================================================ */
#loadingScreen {
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:var(--bg);
  gap:16px;
}
.loading-logo {
  width:80px; height:80px;
  background:var(--primary-glow);
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:38px;
  animation: spin-glow 2s linear infinite;
}
@keyframes spin-glow {
  0%,100% { box-shadow:0 0 20px var(--primary-glow); transform:scale(1); }
  50% { box-shadow:0 0 40px var(--primary-glow); transform:scale(1.05); }
}
.loading-text { font-size:13px; color:var(--text2); }
.loading-bar {
  width:160px; height:3px;
  background:var(--bg3);
  border-radius:10px;
  overflow:hidden;
}
.loading-bar-fill {
  height:100%;
  background:var(--primary);
  border-radius:10px;
  animation:loading-anim 1.5s ease-in-out infinite;
}
@keyframes loading-anim {
  0% { width:0%; margin-right:100%; }
  50% { width:60%; margin-right:40%; }
  100% { width:0%; margin-right:0%; margin-left:100%; }
}

/* ============================================================
   AUTH SCREEN
   ============================================================ */
#authScreen {
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:var(--bg);
  padding:24px;
}
.auth-card {
  width:100%;
  max-width:380px;
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:24px;
  padding:32px 24px;
  box-shadow:var(--shadow);
}
.auth-logo {
  width:70px; height:70px;
  background:var(--primary-glow);
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:34px;
  margin:0 auto 16px;
}
.auth-title { text-align:center; font-size:22px; font-weight:900; margin-bottom:4px; }
.auth-sub { text-align:center; font-size:13px; color:var(--text2); margin-bottom:28px; }

.auth-step { display:none; flex-direction:column; gap:16px; }
.auth-step.active { display:flex; }

.input-group { display:flex; flex-direction:column; gap:6px; }
.input-label { font-size:13px; font-weight:600; color:var(--text2); }
.input-row {
  display:flex;
  background:var(--bg3);
  border:1px solid var(--card-border);
  border-radius:14px;
  overflow:hidden;
  transition:border-color .2s;
}
.input-row:focus-within { border-color:var(--primary); }
.input-prefix {
  padding:0 14px;
  display:flex; align-items:center;
  font-size:15px; font-weight:600;
  color:var(--text2);
  border-left:1px solid var(--card-border);
}
.input-row input {
  flex:1;
  background:transparent;
  border:none; outline:none;
  padding:14px 16px;
  font-size:16px;
  color:var(--text);
  direction:ltr;
  text-align:right;
}
.otp-input {
  background:var(--bg3);
  border:1px solid var(--card-border);
  border-radius:14px;
  padding:16px;
  font-size:24px;
  font-weight:700;
  text-align:center;
  color:var(--text);
  width:100%;
  letter-spacing:8px;
  direction:ltr;
  outline:none;
  transition:border-color .2s;
}
.otp-input:focus { border-color:var(--primary); }

.auth-btn {
  background:var(--primary);
  color:#fff; border:none;
  padding:16px;
  border-radius:14px;
  font-size:16px; font-weight:700;
  font-family:'Cairo',sans-serif;
  cursor:pointer;
  transition:opacity .2s, transform .1s;
  display:flex; align-items:center; justify-content:center; gap:8px;
}
.auth-btn:active { transform:scale(0.98); }
.auth-btn:disabled { opacity:0.5; cursor:default; }
.auth-btn.secondary {
  background:transparent;
  color:var(--text2);
  border:1px solid var(--card-border);
  font-size:14px;
}

.otp-timer { text-align:center; font-size:13px; color:var(--text3); }
.otp-timer span { color:var(--primary); font-weight:700; }
#recaptcha-container { margin:0 auto; }

/* ============================================================
   DRIVER APP
   ============================================================ */
#driverApp {
  flex-direction:column;
  background:var(--bg);
  overflow:hidden;
}

/* Header */
.header {
  height:var(--header-h);
  background:var(--card);
  border-bottom:1px solid var(--card-border);
  display:flex; align-items:center;
  padding:0 16px;
  gap:10px;
  position:relative;
  z-index:100;
  flex-shrink:0;
}
.header-logo { font-size:26px; }
.header-title { font-size:18px; font-weight:900; color:var(--primary); flex:1; }
.icon-btn {
  width:40px; height:40px;
  background:var(--bg3);
  border:none; border-radius:12px;
  font-size:18px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition:background .2s;
  color:var(--text);
}
.icon-btn:active { background:var(--primary-glow); }

/* Status bar */
.status-bar {
  padding:6px 16px;
  font-size:12px;
  font-weight:600;
  display:flex; align-items:center; gap:6px;
  flex-shrink:0;
}
.status-dot {
  width:7px; height:7px;
  border-radius:50%;
  background:var(--success);
  animation: pulse-dot 2s infinite;
}
.status-dot.error { background:var(--danger); animation:none; }
@keyframes pulse-dot {
  0%,100% { opacity:1; } 50% { opacity:0.4; }
}
.status-bar.ok { background:rgba(34,197,94,0.08); color:var(--success); }
.status-bar.err { background:rgba(239,68,68,0.08); color:var(--danger); }

/* Page system */
.pages-wrapper {
  display:flex;
  flex:1;
  overflow:hidden;
  transition:transform 0.35s cubic-bezier(0.4,0,0.2,1);
  width:400%;
}
.page { width:25%; flex-shrink:0; overflow-y:auto; padding:16px; padding-bottom:calc(var(--nav-h) + 16px); }

/* Bottom Nav */
.bottom-nav {
  height:var(--nav-h);
  background:var(--card);
  border-top:1px solid var(--card-border);
  display:flex;
  position:fixed; bottom:0; left:0; right:0;
  z-index:100;
  padding-bottom:env(safe-area-inset-bottom);
}
.nav-item {
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  gap:3px; border:none; background:transparent;
  cursor:pointer; color:var(--text3);
  font-size:10px; font-weight:600;
  font-family:'Cairo',sans-serif;
  transition:color .2s;
  padding:8px 0;
}
.nav-item.active { color:var(--primary); }
.nav-item .nav-icon { font-size:22px; }
.nav-item .nav-plus {
  width:48px; height:48px;
  background:var(--primary);
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:26px; color:#fff;
  box-shadow:0 4px 16px var(--primary-glow);
  margin-top:-8px;
}

/* Welcome card */
.welcome {
  background:linear-gradient(135deg,#1a0a00,#2d1500);
  border:1px solid rgba(249,115,22,0.2);
  border-radius:var(--radius);
  padding:20px;
  position:relative;
  overflow:hidden;
  margin-bottom:16px;
}
.welcome::before {
  content:'ğŸ›µ';
  position:absolute; left:16px; bottom:-8px;
  font-size:72px; opacity:0.08;
}
.welcome-greeting { font-size:13px; color:rgba(249,115,22,0.7); margin-bottom:2px; }
.welcome-name { font-size:20px; font-weight:900; color:#fff; margin-bottom:4px; }
.welcome-time { font-size:28px; font-weight:900; color:var(--primary); }

/* Stats */
.stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
.stat-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  padding:14px;
  position:relative;
  overflow:hidden;
}
.stat-card::after {
  content:'';
  position:absolute; bottom:0; left:0; right:0; height:3px;
}
.stat-card.c1::after { background:var(--success); }
.stat-card.c2::after { background:var(--primary); }
.stat-card.c3::after { background:var(--visa); }
.stat-card.c4::after { background:#f59e0b; }
.stat-icon { font-size:22px; margin-bottom:6px; }
.stat-label { font-size:11px; color:var(--text2); margin-bottom:4px; }
.stat-val { font-size:20px; font-weight:900; }
.stat-card.c1 .stat-val { color:var(--success); }
.stat-card.c2 .stat-val { color:var(--primary); }
.stat-card.c3 .stat-val { color:var(--visa); }
.stat-card.c4 .stat-val { color:#f59e0b; }

/* Section */
.section-title {
  font-size:14px; font-weight:700;
  color:var(--text2); margin-bottom:12px;
  display:flex; align-items:center; gap:6px;
}

/* Report rows */
.report-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  margin-bottom:8px;
  overflow:hidden;
}
.report-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 16px;
  cursor:pointer;
}
.report-rest { font-size:15px; font-weight:700; }
.report-count { font-size:12px; color:var(--text2); }
.report-delivery { font-size:15px; font-weight:700; color:var(--success); }
.report-body { padding:0 16px 14px; display:none; }
.report-body.open { display:block; }
.report-detail { display:flex; justify-content:space-between; font-size:12px; color:var(--text2); padding:3px 0; }

/* Add order page */
.form-section { margin-bottom:16px; }
.form-label {
  font-size:13px; font-weight:600;
  color:var(--text2); margin-bottom:8px;
  display:flex; align-items:center; gap:6px;
}
.form-input {
  width:100%; background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  padding:14px 16px;
  font-size:15px; color:var(--text);
  font-family:'Cairo',sans-serif;
  outline:none;
  transition:border-color .2s;
}
.form-input:focus { border-color:var(--primary); }
.input-with-voice { position:relative; }
.voice-btn {
  position:absolute; left:12px; top:50%; transform:translateY(-50%);
  background:var(--bg3); border:none; border-radius:8px;
  width:32px; height:32px; font-size:16px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
}
.voice-btn.active { background:var(--danger); animation:pulse-red 1s infinite; }

.rest-chips { display:flex; flex-wrap:wrap; gap:8px; }
.rest-chip {
  padding:8px 16px;
  background:var(--bg3);
  border:1px solid var(--card-border);
  border-radius:50px;
  font-size:13px; font-weight:600;
  cursor:pointer; color:var(--text2);
  font-family:'Cairo',sans-serif;
  transition:all .2s;
}
.rest-chip.active {
  background:var(--primary-glow);
  border-color:var(--primary);
  color:var(--primary);
}
.rest-chip.add-chip {
  background:transparent;
  border-style:dashed;
  color:var(--text3);
}

.payment-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.pay-opt {
  padding:14px;
  background:var(--bg3);
  border:2px solid transparent;
  border-radius:var(--radius-sm);
  text-align:center; cursor:pointer;
  transition:all .2s;
}
.pay-opt.active-cash { border-color:var(--cash); background:rgba(34,197,94,0.1); }
.pay-opt.active-visa { border-color:var(--visa); background:rgba(129,140,248,0.1); }
.pay-opt-icon { font-size:24px; margin-bottom:4px; }
.pay-opt-label { font-size:13px; font-weight:700; }
.pay-opt-note { font-size:11px; color:var(--text3); margin-top:2px; }

.submit-btn {
  width:100%; background:var(--primary); color:#fff;
  border:none; padding:18px;
  border-radius:var(--radius-sm);
  font-size:17px; font-weight:900;
  font-family:'Cairo',sans-serif;
  cursor:pointer; margin-top:8px;
  transition:opacity .2s, transform .1s;
}
.submit-btn:active { transform:scale(0.98); }

/* Order cards */
.filter-row { display:flex; gap:8px; margin-bottom:14px; overflow-x:auto; padding-bottom:4px; }
.filter-chip {
  padding:6px 14px;
  background:var(--bg3);
  border:1px solid var(--card-border);
  border-radius:50px;
  font-size:12px; font-weight:600;
  cursor:pointer; color:var(--text2);
  white-space:nowrap;
  font-family:'Cairo',sans-serif;
  transition:all .2s;
}
.filter-chip.active { background:var(--primary-glow); border-color:var(--primary); color:var(--primary); }

.order-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  padding:14px;
  margin-bottom:10px;
  position:relative;
  overflow:hidden;
}
.order-card::before {
  content:'';
  position:absolute; top:0; right:0; bottom:0; width:4px;
}
.order-card.cash::before { background:var(--cash); }
.order-card.visa::before { background:var(--visa); }

.order-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.order-rest { font-size:15px; font-weight:700; }
.order-time { font-size:11px; color:var(--text3); }
.order-body { display:flex; justify-content:space-between; align-items:center; }
.order-details { font-size:12px; color:var(--text2); line-height:1.8; }
.order-amount { text-align:left; }
.order-delivery { font-size:18px; font-weight:900; color:var(--success); }
.order-total { font-size:11px; color:var(--text3); }
.order-actions { display:flex; gap:6px; margin-top:10px; padding-top:10px; border-top:1px solid var(--card-border); }
.action-btn {
  flex:1; padding:8px;
  border-radius:10px; border:none;
  font-size:12px; font-weight:700;
  font-family:'Cairo',sans-serif;
  cursor:pointer;
}
.action-btn.edit { background:rgba(249,115,22,0.1); color:var(--primary); }
.action-btn.delete { background:var(--danger-bg); color:var(--danger); }

/* Settings */
.settings-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  overflow:hidden;
  margin-bottom:16px;
}
.settings-row {
  display:flex; align-items:center; gap:14px;
  padding:16px; border-bottom:1px solid var(--card-border);
  cursor:pointer;
}
.settings-row:last-child { border-bottom:none; }
.settings-icon { font-size:20px; width:32px; text-align:center; }
.settings-label { flex:1; font-size:14px; font-weight:600; }
.settings-val { font-size:13px; color:var(--text2); }
.toggle {
  width:44px; height:24px;
  background:var(--bg3); border-radius:50px;
  position:relative; cursor:pointer; transition:background .2s;
}
.toggle::after {
  content:'';
  position:absolute; top:2px; right:2px;
  width:20px; height:20px;
  background:#fff; border-radius:50%;
  transition:transform .2s;
}
.toggle.on { background:var(--primary); }
.toggle.on::after { transform:translateX(-20px); }

/* Empty state */
.empty-state { text-align:center; padding:48px 16px; color:var(--text3); }
.empty-icon { font-size:48px; margin-bottom:12px; opacity:0.5; }
.empty-text { font-size:14px; }

/* Toast */
.toast {
  position:fixed; bottom:calc(var(--nav-h) + 16px); left:50%;
  transform:translateX(-50%) translateY(20px);
  background:rgba(30,40,60,0.95);
  color:#fff; padding:12px 20px;
  border-radius:50px; font-size:14px; font-weight:600;
  z-index:9999; white-space:nowrap;
  opacity:0; transition:all .3s;
  backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,0.1);
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* Modal */
.modal-overlay {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.7);
  z-index:500; display:none;
  align-items:flex-end; justify-content:center;
  backdrop-filter:blur(4px);
}
.modal-overlay.show { display:flex; }
.modal {
  background:var(--bg2);
  border-radius:24px 24px 0 0;
  padding:24px;
  width:100%; max-height:80dvh;
  overflow-y:auto;
  animation:slide-up .3s ease;
}
@keyframes slide-up { from { transform:translateY(100%); } to { transform:translateY(0); } }
.modal-title { font-size:18px; font-weight:900; margin-bottom:20px; }
.modal-actions { display:flex; gap:10px; margin-top:20px; }
.modal-btn {
  flex:1; padding:14px;
  border-radius:var(--radius-sm);
  border:none; font-size:15px; font-weight:700;
  font-family:'Cairo',sans-serif; cursor:pointer;
}
.modal-btn.confirm { background:var(--primary); color:#fff; }
.modal-btn.cancel { background:var(--bg3); color:var(--text); }
.modal-btn.danger { background:var(--danger); color:#fff; }

/* ============================================================
   MANAGER APP
   ============================================================ */
#managerApp {
  flex-direction:column;
  background:var(--bg);
  overflow:hidden;
}

.mgr-header {
  background:var(--card);
  border-bottom:1px solid var(--card-border);
  padding:0 16px;
  height:var(--header-h);
  display:flex; align-items:center; gap:12px;
  flex-shrink:0;
  z-index:100;
}
.mgr-header-title { font-size:17px; font-weight:900; flex:1; }
.mgr-badge {
  background:var(--primary-glow);
  color:var(--primary);
  padding:4px 10px;
  border-radius:50px;
  font-size:11px; font-weight:700;
}

.mgr-tabs {
  display:flex;
  background:var(--card);
  border-bottom:1px solid var(--card-border);
  flex-shrink:0;
  overflow-x:auto;
}
.mgr-tab {
  flex:1; padding:12px 8px;
  border:none; background:transparent;
  font-family:'Cairo',sans-serif;
  font-size:12px; font-weight:700;
  color:var(--text3); cursor:pointer;
  border-bottom:2px solid transparent;
  white-space:nowrap;
  transition:all .2s;
  min-width:70px;
}
.mgr-tab.active { color:var(--primary); border-bottom-color:var(--primary); }

.mgr-content {
  flex:1; overflow-y:auto;
  padding:16px;
  padding-bottom:24px;
}

.mgr-tab-panel { display:none; }
.mgr-tab-panel.active { display:block; }

/* Manager Stats */
.mgr-stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px; }
.mgr-stat {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  padding:16px;
}
.mgr-stat-icon { font-size:24px; margin-bottom:8px; }
.mgr-stat-label { font-size:11px; color:var(--text2); margin-bottom:4px; }
.mgr-stat-val { font-size:22px; font-weight:900; color:var(--primary); }

/* Driver list */
.search-bar {
  display:flex;
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  overflow:hidden;
  margin-bottom:14px;
}
.search-bar input {
  flex:1; background:transparent; border:none; outline:none;
  padding:12px 16px; font-size:14px; color:var(--text);
  font-family:'Cairo',sans-serif;
}
.search-bar span { padding:0 14px; display:flex; align-items:center; font-size:18px; color:var(--text3); }

.driver-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  padding:14px;
  margin-bottom:10px;
  display:flex; align-items:center; gap:12px;
  cursor:pointer;
  transition:border-color .2s;
}
.driver-card:active { border-color:var(--primary); }
.driver-avatar {
  width:46px; height:46px;
  background:var(--primary-glow);
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:20px; font-weight:900;
  color:var(--primary);
  flex-shrink:0;
}
.driver-info { flex:1; }
.driver-name { font-size:15px; font-weight:700; margin-bottom:2px; }
.driver-phone { font-size:12px; color:var(--text2); direction:ltr; text-align:right; }
.driver-stats-row { display:flex; gap:10px; margin-top:6px; }
.driver-mini-stat { font-size:11px; color:var(--text3); }
.driver-mini-stat span { color:var(--success); font-weight:700; }
.driver-online-dot {
  width:10px; height:10px;
  border-radius:50%;
  background:var(--bg3);
  flex-shrink:0;
}
.driver-online-dot.online { background:var(--success); box-shadow:0 0 6px rgba(34,197,94,0.5); }

/* Add driver btn */
.add-btn {
  width:100%; padding:14px;
  background:transparent;
  border:2px dashed var(--card-border);
  border-radius:var(--radius-sm);
  color:var(--text2); font-size:14px; font-weight:600;
  font-family:'Cairo',sans-serif; cursor:pointer;
  display:flex; align-items:center; justify-content:center; gap:8px;
  margin-bottom:16px;
  transition:all .2s;
}
.add-btn:hover { border-color:var(--primary); color:var(--primary); }

/* Manager order card */
.mgr-order-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  padding:12px;
  margin-bottom:8px;
  display:flex; align-items:center; gap:10px;
}
.mgr-order-body { flex:1; }
.mgr-order-rest { font-size:14px; font-weight:700; }
.mgr-order-driver { font-size:12px; color:var(--text2); }
.mgr-order-time { font-size:11px; color:var(--text3); }
.mgr-order-amount { font-size:16px; font-weight:900; color:var(--success); }

/* Restaurant manager */
.rest-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  padding:14px;
  margin-bottom:8px;
  display:flex; align-items:center; gap:12px;
}
.rest-name-big { flex:1; font-size:15px; font-weight:700; }
.rest-delete-btn {
  background:var(--danger-bg); color:var(--danger);
  border:none; border-radius:10px;
  padding:8px 14px; font-size:13px; font-weight:700;
  font-family:'Cairo',sans-serif; cursor:pointer;
}

/* Driver detail modal */
.driver-detail-overlay {
  position:fixed; inset:0;
  background:var(--bg);
  z-index:200;
  display:none;
  flex-direction:column;
  overflow:hidden;
}
.driver-detail-overlay.show { display:flex; }
.driver-detail-header {
  padding:16px;
  background:var(--card);
  border-bottom:1px solid var(--card-border);
  display:flex; align-items:center; gap:12px;
}
.back-btn {
  width:40px; height:40px;
  background:var(--bg3); border:none; border-radius:12px;
  font-size:20px; cursor:pointer; display:flex;
  align-items:center; justify-content:center;
  color:var(--text);
}
.driver-detail-content { flex:1; overflow-y:auto; padding:16px; }
.driver-detail-stats { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:16px; }
.driver-detail-stat {
  background:var(--card); border:1px solid var(--card-border);
  border-radius:var(--radius-sm); padding:12px; text-align:center;
}
.dds-val { font-size:18px; font-weight:900; color:var(--primary); }
.dds-label { font-size:10px; color:var(--text2); margin-top:2px; }

/* Report page */
.date-filter {
  display:flex; gap:8px; margin-bottom:14px;
  flex-wrap:wrap;
}
.date-btn {
  padding:6px 14px;
  background:var(--bg3); border:1px solid var(--card-border);
  border-radius:50px; font-size:12px; font-weight:600;
  font-family:'Cairo',sans-serif; cursor:pointer; color:var(--text2);
  transition:all .2s;
}
.date-btn.active { background:var(--primary-glow); border-color:var(--primary); color:var(--primary); }

.report-row {
  background:var(--card); border:1px solid var(--card-border);
  border-radius:var(--radius-sm); padding:14px;
  margin-bottom:8px;
  display:flex; align-items:center; gap:12px;
}
.report-driver-name { font-size:14px; font-weight:700; flex:1; }
.report-driver-orders { font-size:12px; color:var(--text2); }
.report-driver-income { font-size:16px; font-weight:900; color:var(--success); }

/* Scrollbar */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--bg3); border-radius:4px; }
</style>
</head>
<body>

<!-- ============================================================
     OFFLINE SCREEN
     ============================================================ -->
<div class="screen" id="offlineScreen">
  <div class="offline-icon">ğŸ“¡</div>
  <div class="offline-title">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</div>
  <div class="offline-sub">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙÙ‚Ø· Ù„Ø¶Ù…Ø§Ù† Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙÙŠ Ø§Ù„ÙƒÙ„Ø§ÙˆØ¯</div>
  <button class="offline-btn" onclick="checkOnline()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
</div>

<!-- ============================================================
     LOADING SCREEN
     ============================================================ -->
<div class="screen active" id="loadingScreen">
  <div class="loading-logo">ğŸ›µ</div>
  <div style="font-size:20px;font-weight:900;color:var(--primary);">Nabil Pro</div>
  <div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
</div>

<!-- ============================================================
     AUTH SCREEN
     ============================================================ -->
<div class="screen" id="authScreen">
  <div class="auth-card">
    <div class="auth-logo">ğŸ›µ</div>
    <div class="auth-title">Nabil Pro</div>
    <div class="auth-sub">ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</div>

    <!-- Login -->
    <div class="auth-step active" id="authStep1">
      <div class="input-group">
        <div class="input-label">ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</div>
        <div class="input-row">
          <div class="input-prefix">ğŸ‡ªğŸ‡¬</div>
          <input type="tel" id="phoneInput" placeholder="01xxxxxxxxx" maxlength="11"
            oninput="this.value=this.value.replace(/\D/g,'')" inputmode="numeric">
        </div>
      </div>
      <div class="input-group">
        <div class="input-label">ğŸ”‘ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ (6 Ø£Ø±Ù‚Ø§Ù…)</div>
        <input type="tel" class="otp-input" id="pinInput" placeholder="â€¢ â€¢ â€¢ â€¢ â€¢ â€¢"
          maxlength="6" inputmode="numeric" oninput="this.value=this.value.replace(/\D/g,'')">
      </div>
      <div style="font-size:12px;color:var(--text3);text-align:center;padding:4px 0;">
        ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙŠØ¬ÙŠÙ„Ùƒ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ±
      </div>
      <button class="auth-btn" id="loginBtn" onclick="doLogin()">
        ğŸš€ Ø¯Ø®ÙˆÙ„
      </button>
    </div>
  </div>
</div>

<!-- ============================================================
     DRIVER APP
     ============================================================ -->
<div class="screen" id="driverApp">
  <div class="header">
    <span class="header-logo">ğŸ›µ</span>
    <span class="header-title">Nabil Pro</span>
    <button class="icon-btn" onclick="toggleTheme()" id="themeBtn">ğŸŒ™</button>
    <button class="icon-btn" onclick="confirmLogout()">ğŸšª</button>
  </div>

  <div class="status-bar ok" id="driverStatus">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Firebase Ù…ØªØµÙ„ â€¢ 0 Ø£ÙˆØ±Ø¯Ø±</span>
  </div>

  <div class="pages-wrapper" id="pagesWrapper">

    <!-- Page 0: Home -->
    <div class="page" id="homePage">
      <div class="welcome">
        <div class="welcome-greeting" id="greeting">ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ğŸ‘‹</div>
        <div class="welcome-name" id="driverNameDisplay">Ù…Ù†Ø¯ÙˆØ¨</div>
        <div class="welcome-time" id="clockDisplay">00:00 Øµ</div>
      </div>

      <div class="stats-grid">
        <div class="stat-card c1">
          <div class="stat-icon">ğŸ“¦</div>
          <div class="stat-label">Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="stat-val" id="statOrders">0</div>
        </div>
        <div class="stat-card c2">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-label">Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØªÙˆØµÙŠÙ„</div>
          <div class="stat-val" id="statDelivery">Ø¬ 0</div>
        </div>
        <div class="stat-card c3">
          <div class="stat-icon">ğŸ’³</div>
          <div class="stat-label">ÙÙŠØ²Ø§ (Ø£ÙƒØ³Ø¨)</div>
          <div class="stat-val" id="statVisa">Ø¬ 0</div>
        </div>
        <div class="stat-card c4">
          <div class="stat-icon">ğŸ’µ</div>
          <div class="stat-label">ØªØ­ØµÙŠÙ„ ÙƒØ§Ø´</div>
          <div class="stat-val" id="statCash">Ø¬ 0</div>
        </div>
      </div>

      <div class="section-title">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØª</div>
      <div id="shiftReport"><div class="empty-state"><div class="empty-icon">ğŸ•</div><div class="empty-text">Ù„Ø§ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯</div></div></div>
    </div>

    <!-- Page 1: Records -->
    <div class="page" id="recordsPage">
      <div class="filter-row" id="filterRow">
        <button class="filter-chip active" data-filter="all" onclick="setFilter(this,'all')">Ø§Ù„ÙƒÙ„</button>
        <button class="filter-chip" data-filter="today" onclick="setFilter(this,'today')">Ø§Ù„ÙŠÙˆÙ…</button>
        <button class="filter-chip" data-filter="week" onclick="setFilter(this,'week')">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
        <button class="filter-chip" data-filter="cash" onclick="setFilter(this,'cash')">ÙƒØ§Ø´</button>
        <button class="filter-chip" data-filter="visa" onclick="setFilter(this,'visa')">ÙÙŠØ²Ø§</button>
      </div>
      <div id="ordersList"><div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª</div></div></div>
    </div>

    <!-- Page 2: Add Order -->
    <div class="page" id="addPage">
      <div class="form-section">
        <div class="form-label">ğŸª Ø§Ù„Ù…Ø·Ø¹Ù…</div>
        <div class="rest-chips" id="restChips"></div>
      </div>
      <div class="form-section">
        <div class="form-label">ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
        <div class="input-with-voice">
          <input class="form-input" id="addressInput" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙƒØ§Ù…Ù„Ø§Ù‹..." style="padding-left:52px;" maxlength="200">
          <button class="voice-btn" id="voiceAddress" onclick="startVoice('addressInput','voiceAddress')">ğŸ¤</button>
        </div>
      </div>
      <div class="form-section">
        <div class="form-label">ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
        <input class="form-input" id="phoneOrderInput" placeholder="01xxxxxxxxx" type="tel" inputmode="numeric">
      </div>
      <div class="form-section">
        <div class="form-label">ğŸ’° Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø± (Ù„Ù„Ù…Ø·Ø¹Ù…)</div>
        <div class="input-with-voice">
          <input class="form-input" id="restAmountInput" type="number" placeholder="0" style="padding-left:52px;" inputmode="decimal">
          <button class="voice-btn" id="voiceAmount" onclick="startVoice('restAmountInput','voiceAmount')">ğŸ¤</button>
        </div>
      </div>
      <div class="form-section">
        <div class="form-label">ğŸ›µ ØªÙˆØµÙŠÙ„</div>
        <input class="form-input" id="deliveryInput" type="number" placeholder="0" inputmode="decimal">
      </div>
      <div class="form-section">
        <div class="form-label">ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
        <div class="payment-row">
          <div class="pay-opt" id="payCash" onclick="selectPayment('cash')">
            <div class="pay-opt-icon">ğŸ’µ</div>
            <div class="pay-opt-label">ÙƒØ§Ø´</div>
            <div class="pay-opt-note">Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
          </div>
          <div class="pay-opt" id="payVisa" onclick="selectPayment('visa')">
            <div class="pay-opt-icon">ğŸ’³</div>
            <div class="pay-opt-label">ÙÙŠØ²Ø§</div>
            <div class="pay-opt-note">Ø£Ù†Øª Ø¨ØªÙƒØ³Ø¨</div>
          </div>
        </div>
      </div>
      <button class="submit-btn" onclick="addOrder()">âœ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</button>
    </div>

    <!-- Page 3: Settings -->
    <div class="page" id="settingsPage">
      <div class="section-title">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
      <div class="settings-card">
        <div class="settings-row" onclick="editDriverName()">
          <span class="settings-icon">ğŸ‘¤</span>
          <span class="settings-label">Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</span>
          <span class="settings-val" id="settingsNameVal">â€”</span>
        </div>
        <div class="settings-row" onclick="cycleTheme()">
          <span class="settings-icon">ğŸ¨</span>
          <span class="settings-label">Ø§Ù„Ù…Ø¸Ù‡Ø±</span>
          <span class="settings-val" id="themeVal">Ø¯Ø§ÙƒÙ†</span>
        </div>
      </div>

      <div class="section-title">ğŸª Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</div>
      <div id="restSettingsList"></div>
      <button class="add-btn" onclick="addRestaurant()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø·Ø¹Ù…</button>

      <div class="section-title">ğŸ“± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
      <div class="settings-card">
        <div class="settings-row">
          <span class="settings-icon">ğŸ“</span>
          <span class="settings-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</span>
          <span class="settings-val" id="settingsPhone" dir="ltr">â€”</span>
        </div>
        <div class="settings-row" onclick="confirmLogout()">
          <span class="settings-icon">ğŸšª</span>
          <span class="settings-label" style="color:var(--danger)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
        </div>
      </div>
    </div>

  </div><!-- end pages-wrapper -->

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <button class="nav-item active" id="nav0" onclick="goPage(0)">
      <span class="nav-icon">ğŸ </span>
      <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </button>
    <button class="nav-item" id="nav1" onclick="goPage(1)">
      <span class="nav-icon">ğŸ“‹</span>
      <span>Ø§Ù„Ø³Ø¬Ù„Ø§Øª</span>
    </button>
    <button class="nav-item" id="nav2" onclick="goPage(2)">
      <div class="nav-plus">ï¼‹</div>
    </button>
    <button class="nav-item" id="nav3" onclick="goPage(3)">
      <span class="nav-icon">âš™ï¸</span>
      <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
    </button>
  </div>
</div><!-- end driverApp -->

<!-- ============================================================
     MANAGER APP
     ============================================================ -->
<div class="screen" id="managerApp">
  <div class="mgr-header">
    <span style="font-size:24px;">ğŸ“Š</span>
    <span class="mgr-header-title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
    <span class="mgr-badge" id="managerBadge">Ù…Ø¯ÙŠØ±</span>
    <button class="icon-btn" onclick="toggleTheme()">ğŸŒ™</button>
    <button class="icon-btn" onclick="confirmLogout()">ğŸšª</button>
  </div>

  <div class="mgr-tabs">
    <button class="mgr-tab active" onclick="mgrTab(0,this)">ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</button>
    <button class="mgr-tab" onclick="mgrTab(1,this)">ğŸ‘¥ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</button>
    <button class="mgr-tab" onclick="mgrTab(2,this)">ğŸª Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</button>
    <button class="mgr-tab" onclick="mgrTab(3,this)">ğŸ“ˆ ØªÙ‚Ø§Ø±ÙŠØ±</button>
  </div>

  <div class="mgr-content">

    <!-- Overview Tab -->
    <div class="mgr-tab-panel active" id="mgrPanel0">
      <div class="mgr-stats">
        <div class="mgr-stat">
          <div class="mgr-stat-icon">ğŸ‘¥</div>
          <div class="mgr-stat-label">Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ø§Ù„Ù†Ø´Ø·ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="mgr-stat-val" id="mgrStatDrivers">0</div>
        </div>
        <div class="mgr-stat">
          <div class="mgr-stat-icon">ğŸ“¦</div>
          <div class="mgr-stat-label">Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="mgr-stat-val" id="mgrStatOrders">0</div>
        </div>
        <div class="mgr-stat">
          <div class="mgr-stat-icon">ğŸ’°</div>
          <div class="mgr-stat-label">Ø¯Ø®Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="mgr-stat-val" id="mgrStatDelivery">0</div>
        </div>
        <div class="mgr-stat">
          <div class="mgr-stat-icon">ğŸ’³</div>
          <div class="mgr-stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="mgr-stat-val" id="mgrStatCash">0</div>
        </div>
      </div>
      <div class="section-title">ğŸ”´ Ø¢Ø®Ø± Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</div>
      <div id="mgrRecentOrders"><div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Ù„Ø§ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø¨Ø¹Ø¯</div></div></div>
    </div>

    <!-- Drivers Tab -->
    <div class="mgr-tab-panel" id="mgrPanel1">
      <div class="search-bar">
        <span>ğŸ”</span>
        <input type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù…..." id="driverSearch" oninput="filterDrivers()">
      </div>
      <button class="add-btn" onclick="showAddDriverModal()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ Ø¬Ø¯ÙŠØ¯</button>
      <div id="driversList"></div>
    </div>

    <!-- Restaurants Tab -->
    <div class="mgr-tab-panel" id="mgrPanel2">
      <button class="add-btn" onclick="showAddRestModal()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø·Ø¹Ù…</button>
      <div id="mgrRestsList"></div>
    </div>

    <!-- Reports Tab -->
    <div class="mgr-tab-panel" id="mgrPanel3">
      <div class="date-filter">
        <button class="date-btn active" onclick="setReportPeriod('today',this)">Ø§Ù„ÙŠÙˆÙ…</button>
        <button class="date-btn" onclick="setReportPeriod('week',this)">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
        <button class="date-btn" onclick="setReportPeriod('month',this)">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
      </div>
      <div id="reportsContent"></div>
    </div>

  </div>
</div><!-- end managerApp -->

<!-- Driver Detail (Manager view) -->
<div class="driver-detail-overlay" id="driverDetailOverlay">
  <div class="driver-detail-header">
    <button class="back-btn" onclick="closeDriverDetail()">â†</button>
    <div>
      <div style="font-size:17px;font-weight:900;" id="detailDriverName">â€”</div>
      <div style="font-size:12px;color:var(--text2);" id="detailDriverPhone" dir="ltr">â€”</div>
    </div>
    <div style="flex:1;"></div>
    <button class="icon-btn" style="background:rgba(129,140,248,0.1);color:var(--visa);margin-left:6px;" onclick="toggleDriverRole()" id="roleBtn">ğŸ‘‘</button>
    <button class="icon-btn" style="background:var(--danger-bg);color:var(--danger);" onclick="removeDriver()">ğŸ—‘</button>
  </div>
  <div class="driver-detail-content">
    <div class="driver-detail-stats">
      <div class="driver-detail-stat">
        <div class="dds-val" id="detailOrders">0</div>
        <div class="dds-label">Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
      </div>
      <div class="driver-detail-stat">
        <div class="dds-val" id="detailDelivery">0</div>
        <div class="dds-label">Ø¯Ø®Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„</div>
      </div>
      <div class="driver-detail-stat">
        <div class="dds-val" id="detailTotal">0</div>
        <div class="dds-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´</div>
      </div>
    </div>
    <div class="section-title">ğŸ“‹ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
    <div id="detailOrdersList"></div>
  </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalBox">
    <div class="modal-title" id="modalTitle">ØªØ£ÙƒÙŠØ¯</div>
    <div id="modalBody"></div>
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// SECURITY: Sanitize user input to prevent XSS
// ============================================================
function sanitize(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// ============================================================
// FIREBASE CONFIG
// ============================================================
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyAikfw9vS3PJQgaWl6SrpcOSG34B5vyXPc",
  authDomain:        "nabil-pro.firebaseapp.com",
  projectId:         "nabil-pro",
  storageBucket:     "nabil-pro.firebasestorage.app",
  messagingSenderId: "82099030853",
  appId:             "1:82099030853:web:89de9eabad2cc53817cc2c"
};

let auth, db;

// ============================================================
// STATE
// ============================================================
let currentUser   = null;
let userProfile   = null;
let ordersCache   = [];
let restaurantsCache = [];
let allDrivers    = [];
let allOrders     = [];
let currentFilter = 'all';
let selectedRest  = null;
let selectedPayment = null;
let currentPage   = 0;
let themeMode     = 'dark';
let recognizer    = null;
let editingOrderId = null;
let selectedDriverUid = null;
let reportPeriod  = 'today';
let ordersUnsubscribe = null;
let allOrdersUnsubscribe = null;

// Firestore refs (set after auth)
let ordersRef, restaurantsRef, usersRef, settingsRef;

// ============================================================
// NETWORK
// ============================================================
function checkOnline() {
  if (navigator.onLine) {
    showScreen('loadingScreen');
    initApp();
  } else {
    showScreen('offlineScreen');
  }
}
window.addEventListener('online', () => { if (!currentUser) checkOnline(); });
window.addEventListener('offline', () => {
  if (!currentUser) showScreen('offlineScreen');
});

// ============================================================
// SCREEN
// ============================================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ============================================================
// INIT
// ============================================================
async function initApp() {
  if (!navigator.onLine) { showScreen('offlineScreen'); return; }
  showScreen('loadingScreen');

  // Init Firebase here so SDKs are guaranteed loaded
  if (!auth) {
    firebase.initializeApp(FIREBASE_CONFIG);
    auth = firebase.auth();
    db   = firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  }

  if (!window.authListenerSet) {
    auth.onAuthStateChanged(async user => {
      if (user) {
        currentUser = user;
        await loadUserProfile(user.uid);
      } else {
        showScreen('authScreen');
      }
    });
    window.authListenerSet = true;
  }
}

async function loadUserProfile(uid) {
  try {
    usersRef = db.collection('users');
    const doc = await usersRef.doc(uid).get();
    if (doc.exists) {
      userProfile = doc.data();
    } else {
      // New user - create as driver
      const email = currentUser.email || '';
      // Extract phone from email (format: 01xxx@nabilpro.app)
      const phone = email.replace('@nabilpro.app','');
      userProfile = {
        uid, phone, email, role: 'driver',
        name: 'Ù…Ù†Ø¯ÙˆØ¨ Ø¯Ù„ÙŠÙØ±ÙŠ',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await usersRef.doc(uid).set(userProfile);
    }

    if (userProfile.role === 'manager') {
      initManagerApp();
    } else {
      initDriverApp();
    }
  } catch(e) {
    showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    showScreen('authScreen');
  }
}

// ============================================================
// EMAIL/PIN AUTH
// phone number â†’ email: 01012345678@nabilpro.app
// PIN (6 digits) â†’ password
// ============================================================
function phoneToEmail(phone) {
  // Normalize: always store with leading 0
  let p = phone.replace(/\D/g,'');
  if (!p.startsWith('0')) p = '0' + p;
  return p + '@nabilpro.app';
}

async function doLogin() {
  const phone = document.getElementById('phoneInput').value.trim();
  const pin   = document.getElementById('pinInput').value.trim();
  if (phone.length < 10) { showToast('Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„'); return; }
  if (pin.length !== 6)  { showToast('ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ 6 Ø£Ø±Ù‚Ø§Ù…'); return; }

  const btn = document.getElementById('loginBtn');
  btn.disabled = true;
  btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...';

  const email = phoneToEmail(phone);

  try {
    const result = await auth.signInWithEmailAndPassword(email, pin);
    currentUser = result.user;
    showScreen('loadingScreen');
    loadUserProfile(currentUser.uid);
  } catch(err) {
    btn.disabled = false;
    btn.innerHTML = 'ğŸš€ Ø¯Ø®ÙˆÙ„';
    if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password') {
      showToast('âŒ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­');
    } else {
      showToast('Ø®Ø·Ø£: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„');
    }
  }
}

function confirmLogout() {
  showModal('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', '<p style="color:var(--text2);font-size:14px;">Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ</p>',
    [{ label: 'Ø®Ø±ÙˆØ¬', cls: 'danger', action: doLogout },
     { label: 'Ø¥Ù„ØºØ§Ø¡', cls: 'cancel', action: closeModal }]);
}

async function doLogout() {
  closeModal();

  if (ordersUnsubscribe) { ordersUnsubscribe(); ordersUnsubscribe = null; }
  if (allOrdersUnsubscribe) { allOrdersUnsubscribe(); allOrdersUnsubscribe = null; }

  try { await auth.signOut(); } catch(e) {}

  // ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ Ù„Ù„Ø­Ø§Ù„Ø©
  currentUser = null;
  userProfile = null;
  ordersCache = [];
  restaurantsCache = [];
  allDrivers = [];
  allOrders = [];
  selectedRest = null;
  selectedPayment = null;
  editingOrderId = null;
  selectedDriverUid = null;

  // ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
  const ph = document.getElementById('phoneInput');
  const pin = document.getElementById('pinInput');
  if (ph) ph.value = '';
  if (pin) pin.value = '';

  showScreen('authScreen');
}

// ============================================================
// DRIVER APP INIT
// ============================================================
function initDriverApp() {
  const uid = currentUser.uid;
  ordersRef = db.collection('orders');
  restaurantsRef = db.collection('restaurants');
  settingsRef = db.collection('users').doc(uid);

  // Update last seen
  db.collection('users').doc(uid).update({
    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
    online: true
  }).catch(() => {});

  // Apply saved theme
  themeMode = userProfile.themeMode || 'dark';
  applyTheme(themeMode);

  // Set name in UI
  const name = userProfile.name || 'Ù…Ù†Ø¯ÙˆØ¨ Ø¯Ù„ÙŠÙØ±ÙŠ';
  document.getElementById('driverNameDisplay').textContent = name;
  document.getElementById('settingsNameVal').textContent = name;
  document.getElementById('settingsPhone').textContent = userProfile.phone || 'â€”';

  updateClock();
  setInterval(updateClock, 30000);

  loadRestaurantsDriver();
  listenToDriverOrders();
  showScreen('driverApp');
}

// ============================================================
// DRIVER: RESTAURANTS
// ============================================================
async function loadRestaurantsDriver() {
  const snap = await restaurantsRef.orderBy('name').get();
  restaurantsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderRestChips();
  renderRestSettings();
}

function renderRestChips() {
  const active = restaurantsCache.filter(r => r.active !== false);
  const html = active.map(r =>
    `<button class="rest-chip ${selectedRest === r.id ? 'active' : ''}" onclick="selectRest('${r.id}')">${sanitize(r.name)}</button>`
  ).join('');
  document.getElementById('restChips').innerHTML = html + `<button class="rest-chip add-chip" onclick="addRestaurantFromOrder()">ï¼‹ Ø¬Ø¯ÙŠØ¯</button>`;
}

function selectRest(id) {
  selectedRest = selectedRest === id ? null : id;
  renderRestChips();
}

function renderRestSettings() {
  const el = document.getElementById('restSettingsList');
  if (!restaurantsCache.length) { el.innerHTML = '<div class="empty-state"><div class="empty-text">Ù„Ø§ Ù…Ø·Ø§Ø¹Ù… Ø¨Ø¹Ø¯</div></div>'; return; }
  el.innerHTML = restaurantsCache.map(r => `
    <div class="rest-card">
      <span style="font-size:20px;">ğŸª</span>
      <span class="rest-name-big">${sanitize(r.name)}</span>
      <button class="rest-delete-btn" onclick="deleteRestaurant('${sanitize(r.id)}','${sanitize(r.name)}')">Ø­Ø°Ù</button>
    </div>`).join('');
}

async function addRestaurant() {
  const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:');
  if (!name) return;
  await restaurantsRef.add({ name: name.trim(), active: true, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ' + name);
  loadRestaurantsDriver();
}

async function addRestaurantFromOrder() {
  const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…:');
  if (!name) return;
  const docRef = await restaurantsRef.add({ name: name.trim(), active: true, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  await loadRestaurantsDriver();
  selectedRest = docRef.id;
  renderRestChips();
}

async function deleteRestaurant(id, name) {
  // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ù„Ù„Ù…Ø·Ø¹Ù…
  const ordersSnap = await ordersRef.where('restId','==',id).limit(1).get();
  if (!ordersSnap.empty) {
    showModal('ØªÙ†Ø¨ÙŠÙ‡', `<p style="color:var(--text2);font-size:14px;">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù "${sanitize(name)}" Ù„Ø£Ù† Ù„Ø¯ÙŠÙ‡ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©.</p>`,
      [{ label: 'Ø­Ø³Ù†Ø§Ù‹', cls: 'cancel', action: closeModal }]);
    return;
  }
  showModal('Ø­Ø°Ù Ø§Ù„Ù…Ø·Ø¹Ù…', `<p style="color:var(--text2);font-size:14px;">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù "${sanitize(name)}"ØŸ</p>`,
    [{ label: 'Ø­Ø°Ù', cls: 'danger', action: async () => {
        await restaurantsRef.doc(id).delete();
        if (selectedRest === id) selectedRest = null;
        closeModal();
        showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        loadRestaurantsDriver();
    }},
    { label: 'Ø¥Ù„ØºØ§Ø¡', cls: 'cancel', action: closeModal }]);
}

// ============================================================
// DRIVER: ORDERS
// ============================================================
function listenToDriverOrders() {
  if (ordersUnsubscribe) ordersUnsubscribe();
  ordersUnsubscribe = ordersRef
    .where('driverId', '==', currentUser.uid)
    .orderBy('timestamp', 'desc')
    .onSnapshot(snap => {
      ordersCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      updateDriverStats();
      renderShiftReport();
      renderOrdersList();
      updateStatusBar();
    }, err => {
      document.getElementById('driverStatus').className = 'status-bar err';
      document.getElementById('statusDot').className = 'status-dot error';
      document.getElementById('statusText').textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©';
    });
}

function getTodayOrders() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  return ordersCache.filter(o => {
    if (!o.timestamp) return false;
    const t = o.timestamp.toDate ? o.timestamp.toDate() : new Date(o.timestamp);
    return t >= start;
  });
}

function updateDriverStats() {
  const today = getTodayOrders();
  const totalDelivery = today.reduce((s,o) => s + (o.delivery || 0), 0);
  const visaOrders = today.filter(o => o.payment === 'visa');
  const totalVisa = visaOrders.reduce((s,o) => s + (o.total || 0), 0);
  const cashOrders = today.filter(o => o.payment === 'cash');
  const totalCash = cashOrders.reduce((s,o) => s + (o.total || 0), 0);

  document.getElementById('statOrders').textContent = today.length;
  document.getElementById('statDelivery').textContent = 'Ø¬ ' + totalDelivery;
  document.getElementById('statVisa').textContent = 'Ø¬ ' + totalVisa;
  document.getElementById('statCash').textContent = 'Ø¬ ' + totalCash;
}

function updateStatusBar() {
  const today = getTodayOrders();
  document.getElementById('driverStatus').className = 'status-bar ok';
  document.getElementById('statusDot').className = 'status-dot';
  document.getElementById('statusText').textContent = `Firebase ğŸ”¥ Ù…ØªØµÙ„ â€¢ ${today.length} Ø£ÙˆØ±Ø¯Ø± Ø§Ù„ÙŠÙˆÙ…`;
}

function renderShiftReport() {
  const today = getTodayOrders();
  if (!today.length) {
    document.getElementById('shiftReport').innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ•</div><div class="empty-text">Ù„Ø§ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯</div></div>';
    return;
  }
  const byRest = {};
  today.forEach(o => {
    if (!byRest[o.restName]) byRest[o.restName] = { orders:0, delivery:0, cash:0, visa:0 };
    byRest[o.restName].orders++;
    byRest[o.restName].delivery += o.delivery || 0;
    if (o.payment === 'cash') byRest[o.restName].cash += o.total || 0;
    if (o.payment === 'visa') byRest[o.restName].visa += o.total || 0;
  });
  document.getElementById('shiftReport').innerHTML = Object.entries(byRest).map(([name, d]) => `
    <div class="report-card">
      <div class="report-header" onclick="this.nextElementSibling.classList.toggle('open')">
        <div>
          <div class="report-rest">${name}</div>
          <div class="report-count">${d.orders} Ø£ÙˆØ±Ø¯Ø±</div>
        </div>
        <div class="report-delivery">Ø¬ ${d.delivery}</div>
      </div>
      <div class="report-body">
        <div class="report-detail"><span>ÙƒØ§Ø´</span><span>Ø¬ ${d.cash}</span></div>
        <div class="report-detail"><span>ÙÙŠØ²Ø§</span><span>Ø¬ ${d.visa}</span></div>
        <div class="report-detail"><span>ØªÙˆØµÙŠÙ„</span><span>Ø¬ ${d.delivery}</span></div>
      </div>
    </div>`).join('');
}

function renderOrdersList() {
  const now = new Date();
  const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const weekStart = new Date(now); weekStart.setDate(now.getDate() - 7);

  let list = [...ordersCache];
  if (currentFilter === 'today') list = list.filter(o => {
    const t = o.timestamp?.toDate?.() || new Date(o.timestamp);
    return t >= todayStart;
  });
  else if (currentFilter === 'week') list = list.filter(o => {
    const t = o.timestamp?.toDate?.() || new Date(o.timestamp);
    return t >= weekStart;
  });
  else if (currentFilter === 'cash') list = list.filter(o => o.payment === 'cash');
  else if (currentFilter === 'visa') list = list.filter(o => o.payment === 'visa');

  if (!list.length) {
    document.getElementById('ordersList').innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª</div></div>';
    return;
  }
  document.getElementById('ordersList').innerHTML = list.map(o => {
    const t = o.timestamp?.toDate?.() || (o.timestamp ? new Date(o.timestamp) : new Date());
    const timeStr = t.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
    const dateStr = t.toLocaleDateString('ar-EG', {day:'2-digit', month:'2-digit'});
    return `<div class="order-card ${o.payment || 'cash'}">
      <div class="order-head">
        <span class="order-rest">${sanitize(o.restName || 'â€”')}</span>
        <span class="order-time">${dateStr} ${timeStr}</span>
      </div>
      <div class="order-body">
        <div class="order-details">
          ${o.address ? 'ğŸ“ ' + sanitize(o.address) + '<br>' : ''}
          ${o.phone ? 'ğŸ“ ' + o.phone + '<br>' : ''}
          ğŸ’³ ${o.payment === 'visa' ? 'ÙÙŠØ²Ø§' : 'ÙƒØ§Ø´'}
        </div>
        <div class="order-amount">
          <div class="order-delivery">Ø¬ ${o.delivery || 0}</div>
          <div class="order-total">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¬ ${o.total || 0}</div>
        </div>
      </div>
      <div class="order-actions">
        <button class="action-btn edit" onclick="editOrder('${o.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="action-btn delete" onclick="deleteOrder('${o.id}')">ğŸ—‘ Ø­Ø°Ù</button>
      </div>
    </div>`;
  }).join('');
}

function setFilter(el, filter) {
  currentFilter = filter;
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderOrdersList();
}

// ============================================================
// ADD ORDER
// ============================================================
function selectPayment(type) {
  selectedPayment = type;
  document.getElementById('payCash').className = 'pay-opt' + (type === 'cash' ? ' active-cash' : '');
  document.getElementById('payVisa').className = 'pay-opt' + (type === 'visa' ? ' active-visa' : '');
}

async function addOrder() {
  if (!selectedRest) { showToast('Ø§Ø®ØªØ± Ø§Ù„Ù…Ø·Ø¹Ù… Ø£ÙˆÙ„Ø§Ù‹'); return; }
  const submitBtn = document.querySelector('.submit-btn');
  if (submitBtn) { submitBtn.disabled = true; submitBtn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...'; }
  const address  = document.getElementById('addressInput').value.trim();
  const phone    = document.getElementById('phoneOrderInput').value.trim();
  const restAmt  = parseFloat(document.getElementById('restAmountInput').value) || 0;
  const delivery = parseFloat(document.getElementById('deliveryInput').value) || 0;
  if (!address)   { showToast('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'); return; }
  if (!selectedPayment) { showToast('Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹'); return; }
  if (restAmt < 0) { showToast('Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); return; }
  if (delivery < 0) { showToast('Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); return; }

  const rest = restaurantsCache.find(r => r.id === selectedRest);
  const total = restAmt + delivery;

  const orderData = {
    driverId: currentUser.uid,
    driverName: userProfile.name || 'Ù…Ù†Ø¯ÙˆØ¨',
    restId: selectedRest,
    restName: rest?.name || 'â€”',
    restAmount: restAmt,
    delivery,
    total,
    payment: selectedPayment,
    address,
    phone,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  if (editingOrderId) {
    await ordersRef.doc(editingOrderId).update(orderData);
    editingOrderId = null;
    showToast('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±');
  } else {
    await ordersRef.add(orderData);
    showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±');
  }

  if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = 'âœ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±'; }
  // Reset form
  document.getElementById('addressInput').value = '';
  document.getElementById('phoneOrderInput').value = '';
  document.getElementById('restAmountInput').value = '';
  document.getElementById('deliveryInput').value = '';
  selectedRest = null;
  selectedPayment = null;
  renderRestChips();
  document.getElementById('payCash').className = 'pay-opt';
  document.getElementById('payVisa').className = 'pay-opt';
  goPage(0);
}

async function editOrder(id) {
  const o = ordersCache.find(x => x.id === id);
  if (!o) return;
  editingOrderId = id;
  selectedRest = o.restId;
  selectedPayment = o.payment;
  document.getElementById('addressInput').value = o.address || '';
  document.getElementById('phoneOrderInput').value = o.phone || '';
  document.getElementById('restAmountInput').value = o.restAmount || '';
  document.getElementById('deliveryInput').value = o.delivery || '';
  renderRestChips();
  selectPayment(o.payment);
  goPage(2);
  showToast('ğŸ“ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„...');
}

async function deleteOrder(id) {
  showModal('Ø­Ø°Ù Ø§Ù„Ø£ÙˆØ±Ø¯Ø±', '<p style="color:var(--text2);font-size:14px;">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ</p>',
    [{ label: 'Ø­Ø°Ù', cls: 'danger', action: async () => {
        await ordersRef.doc(id).delete();
        closeModal(); showToast('ğŸ—‘ ØªÙ… Ø§Ù„Ø­Ø°Ù');
    }},
    { label: 'Ø¥Ù„ØºØ§Ø¡', cls: 'cancel', action: closeModal }]);
}

// ============================================================
// NAVIGATION
// ============================================================
function goPage(n) {
  currentPage = n;
  document.getElementById('pagesWrapper').style.transform = `translateX(${n * 25}%)`;
  document.querySelectorAll('.nav-item').forEach((el, i) => el.classList.toggle('active', i === n));
}

// ============================================================
// SETTINGS
// ============================================================
function editDriverName() {
  showModal('ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…', `<input class="form-input" id="newNameInput" value="${userProfile.name || ''}" placeholder="Ø§Ø³Ù…Ùƒ...">`,
    [{ label: 'Ø­ÙØ¸', cls: 'confirm', action: async () => {
        const name = document.getElementById('newNameInput').value.trim() || 'Ù…Ù†Ø¯ÙˆØ¨ Ø¯Ù„ÙŠÙØ±ÙŠ';
        userProfile.name = name;
        await db.collection('users').doc(currentUser.uid).update({ name });
        document.getElementById('driverNameDisplay').textContent = name;
        document.getElementById('settingsNameVal').textContent = name;
        closeModal(); showToast('âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…');
    }},
    { label: 'Ø¥Ù„ØºØ§Ø¡', cls: 'cancel', action: closeModal }]);
}

function cycleTheme() {
  themeMode = themeMode === 'dark' ? 'light' : 'dark';
  applyTheme(themeMode);
  db.collection('users').doc(currentUser.uid).update({ themeMode });
}

function toggleTheme() { cycleTheme(); }

function applyTheme(mode) {
  document.body.dataset.theme = mode === 'light' ? 'light' : '';
  document.getElementById('themeVal') && (document.getElementById('themeVal').textContent = mode === 'light' ? 'ÙØ§ØªØ­' : 'Ø¯Ø§ÙƒÙ†');
  const btn = document.getElementById('themeBtn');
  if (btn) btn.textContent = mode === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
}

// ============================================================
// CLOCK
// ============================================================
function updateClock() {
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes();
  const isAM = h < 12;
  const h12 = h % 12 || 12;
  const mStr = String(m).padStart(2, '0');
  document.getElementById('clockDisplay').textContent = `${h12}:${mStr} ${isAM ? 'Øµ' : 'Ù…'}`;
  const g = document.getElementById('greeting');
  if (h < 12) g.textContent = 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ğŸ‘‹';
  else if (h < 17) g.textContent = 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ù†ÙˆØ± ğŸ’ª';
  else g.textContent = 'Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ù‡ Ø´ØºØ§Ù„ ğŸ”¥';
}

// ============================================================
// VOICE INPUT
// ============================================================
function startVoice(inputId, btnId) {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    showToast('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØª'); return;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (recognizer) { recognizer.stop(); recognizer = null; document.getElementById(btnId).classList.remove('active'); return; }
  recognizer = new SR();
  recognizer.lang = 'ar-EG';
  recognizer.interimResults = false;
  document.getElementById(btnId).classList.add('active');
  recognizer.onresult = e => { document.getElementById(inputId).value = e.results[0][0].transcript; };
  recognizer.onend = () => { document.getElementById(btnId).classList.remove('active'); recognizer = null; };
  recognizer.start();
}

// ============================================================
// MANAGER APP
// ============================================================
function initManagerApp() {
  themeMode = userProfile.themeMode || 'dark';
  applyTheme(themeMode);
  document.getElementById('managerBadge').textContent = userProfile.name || 'Ù…Ø¯ÙŠØ±';
  showScreen('managerApp');
  listenAllOrders();
  loadAllDrivers();
  loadMgrRestaurants();
}

function listenAllOrders() {
  if (allOrdersUnsubscribe) allOrdersUnsubscribe();
  const todayStart = new Date();
  todayStart.setHours(0,0,0,0);

  allOrdersUnsubscribe = db.collection('orders')
    .orderBy('timestamp', 'desc')
    .onSnapshot(snap => {
      allOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      updateMgrOverview();
      renderMgrRecentOrders();
      renderMgrReports();
    }, () => {});
}

function updateMgrOverview() {
  const todayStart = new Date();
  todayStart.setHours(0,0,0,0);
  const today = allOrders.filter(o => {
    if (!o.timestamp) return false;
    const t = o.timestamp.toDate ? o.timestamp.toDate() : new Date(o.timestamp);
    return t >= todayStart;
  });
  const driverIds = [...new Set(today.map(o => o.driverId))];
  const totalDelivery = today.reduce((s,o) => s + (o.delivery||0), 0);
  const totalCash = today.filter(o => o.payment === 'cash').reduce((s,o) => s + (o.total||0), 0);

  document.getElementById('mgrStatDrivers').textContent = driverIds.length;
  document.getElementById('mgrStatOrders').textContent = today.length;
  document.getElementById('mgrStatDelivery').textContent = 'Ø¬ ' + totalDelivery;
  document.getElementById('mgrStatCash').textContent = 'Ø¬ ' + totalCash;
}

function renderMgrRecentOrders() {
  const recent = allOrders.slice(0, 20);
  if (!recent.length) {
    document.getElementById('mgrRecentOrders').innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">Ù„Ø§ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø¨Ø¹Ø¯</div></div>';
    return;
  }
  document.getElementById('mgrRecentOrders').innerHTML = recent.map(o => {
    const t = o.timestamp?.toDate?.() || new Date();
    const timeStr = t.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
    return `<div class="mgr-order-card">
      <span style="font-size:20px;">${o.payment === 'visa' ? 'ğŸ’³' : 'ğŸ’µ'}</span>
      <div class="mgr-order-body">
        <div class="mgr-order-rest">${o.restName || 'â€”'}</div>
        <div class="mgr-order-driver">ğŸ‘¤ ${o.driverName || 'â€”'} â€¢ ${o.address || ''}</div>
        <div class="mgr-order-time">â° ${timeStr}</div>
      </div>
      <div class="mgr-order-amount">Ø¬ ${o.delivery || 0}</div>
    </div>`;
  }).join('');
}

// ============================================================
// MANAGER: DRIVERS
// ============================================================
async function loadAllDrivers() {
  const snap = await db.collection('users').where('role','==','driver').get();
  allDrivers = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
  renderDriversList();
}

function renderDriversList(filter = '') {
  let list = allDrivers;
  if (filter) {
    const q = filter.toLowerCase();
    list = list.filter(d => (d.name||'').includes(q) || (d.phone||'').includes(q));
  }
  if (!list.length) {
    document.getElementById('driversList').innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-text">Ù„Ø§ Ù…Ù†Ø§Ø¯ÙŠØ¨ Ø¨Ø¹Ø¯</div></div>';
    return;
  }
  const todayStart = new Date(); todayStart.setHours(0,0,0,0);

  document.getElementById('driversList').innerHTML = list.map(d => {
    const driverOrders = allOrders.filter(o => o.driverId === d.uid);
    const todayOrders = driverOrders.filter(o => {
      if (!o.timestamp) return false;
      const t = o.timestamp.toDate ? o.timestamp.toDate() : new Date(o.timestamp);
      return t >= todayStart;
    });
    const todayDelivery = todayOrders.reduce((s,o) => s + (o.delivery||0), 0);
    const initials = (d.name||'Ù…').charAt(0);
    const isOnline = d.lastSeen && ((new Date() - (d.lastSeen.toDate ? d.lastSeen.toDate() : new Date(d.lastSeen))) < 300000);
    return `<div class="driver-card" onclick="showDriverDetail('${d.uid}')">
      <div class="driver-avatar">${initials}</div>
      <div class="driver-info">
        <div class="driver-name">${sanitize(d.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…')}</div>
        <div class="driver-phone">${sanitize(d.phone || 'â€”')}</div>
        <div class="driver-stats-row">
          <span class="driver-mini-stat">Ø§Ù„ÙŠÙˆÙ…: <span>${todayOrders.length} Ø£ÙˆØ±Ø¯Ø± â€¢ Ø¬ ${todayDelivery}</span></span>
        </div>
      </div>
      <div class="driver-online-dot ${isOnline ? 'online' : ''}"></div>
    </div>`;
  }).join('');
}

function filterDrivers() {
  const q = document.getElementById('driverSearch').value.trim();
  renderDriversList(q);
}

function showAddDriverModal() {
  showModal('Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ Ø¬Ø¯ÙŠØ¯', `
    <div class="input-group" style="margin-bottom:12px;">
      <div class="input-label">ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…</div>
      <input class="form-input" id="newDriverName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨">
    </div>
    <div class="input-group" style="margin-bottom:12px;">
      <div class="input-label">ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</div>
      <input class="form-input" type="tel" id="newDriverPhone" placeholder="01xxxxxxxxx" inputmode="numeric">
    </div>
    <div class="input-group" style="margin-bottom:8px;">
      <div class="input-label">ğŸ”‘ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ (6 Ø£Ø±Ù‚Ø§Ù…)</div>
      <input class="form-input" type="tel" id="newDriverPin" placeholder="Ù…Ø«Ø§Ù„: 123456" maxlength="6" inputmode="numeric">
    </div>
    <div style="font-size:11px;color:var(--text3);padding:4px 0;">Ø§Ø¨Ø¹Øª Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„ÙƒÙˆØ¯ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø¹Ø´Ø§Ù† ÙŠØ¯Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>`,
    [{ label: 'Ø¥Ø¶Ø§ÙØ© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨', cls: 'confirm', action: addDriver },
     { label: 'Ø¥Ù„ØºØ§Ø¡', cls: 'cancel', action: closeModal }]);
}

async function addDriver() {
  const name  = document.getElementById('newDriverName').value.trim();
  const phone = document.getElementById('newDriverPhone').value.trim();
  const pin   = document.getElementById('newDriverPin').value.trim();
  if (!name)          { showToast('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…'); return; }
  if (phone.length < 10) { showToast('Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­'); return; }
  if (pin.length !== 6)  { showToast('Ø§Ù„ÙƒÙˆØ¯ Ù„Ø§Ø²Ù… 6 Ø£Ø±Ù‚Ø§Ù…'); return; }

  const btn = document.getElementById('mBtn0');
  btn.disabled = true;
  btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';

  // Normalize phone
  let p = phone.replace(/\D/g,'');
  if (!p.startsWith('0')) p = '0' + p;
  const email = p + '@nabilpro.app';

  try {
    // Create Firebase Auth account using secondary app (so manager stays logged in)
    let secondaryApp;
    try {
      secondaryApp = firebase.app('secondary');
    } catch(e) {
      secondaryApp = firebase.initializeApp(FIREBASE_CONFIG, 'secondary');
    }
    const secondaryAuth = secondaryApp.auth();
    const result = await secondaryAuth.createUserWithEmailAndPassword(email, pin);
    const uid = result.user.uid;
    await secondaryAuth.signOut();

    // Save to Firestore
    await db.collection('users').doc(uid).set({
      uid, name, phone: p, email, role: 'driver',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: currentUser.uid
    });

    allDrivers.push({ uid, name, phone: p, role: 'driver' });
    renderDriversList();
    closeModal();
    showToast(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ${name} - ÙƒÙˆØ¯: ${pin}`);
  } catch(err) {
    btn.disabled = false;
    btn.textContent = 'Ø¥Ø¶Ø§ÙØ© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
    if (err.code === 'auth/email-already-in-use') {
      showToast('âŒ Ø§Ù„Ø±Ù‚Ù… Ø¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
    } else {
      showToast('Ø®Ø·Ø£: ' + err.message);
    }
  }
}

function showDriverDetail(uid) {
  selectedDriverUid = uid;
  const driver = allDrivers.find(d => d.uid === uid);
  if (!driver) return;

  document.getElementById('detailDriverName').textContent = driver.name || 'â€”';
  document.getElementById('detailDriverPhone').textContent = driver.phone || 'â€”';

  const todayStart = new Date(); todayStart.setHours(0,0,0,0);
  const dOrders = allOrders.filter(o => o.driverId === uid);
  const todayOrders = dOrders.filter(o => {
    const t = o.timestamp?.toDate?.() || new Date(o.timestamp);
    return t >= todayStart;
  });
  const todayDelivery = todayOrders.reduce((s,o) => s + (o.delivery||0), 0);
  const todayCash = todayOrders.filter(o => o.payment==='cash').reduce((s,o) => s + (o.total||0), 0);

  document.getElementById('detailOrders').textContent = todayOrders.length;
  document.getElementById('detailDelivery').textContent = 'Ø¬ ' + todayDelivery;
  document.getElementById('detailTotal').textContent = 'Ø¬ ' + todayCash;

  document.getElementById('detailOrdersList').innerHTML = todayOrders.length
    ? todayOrders.map(o => {
        const t = o.timestamp?.toDate?.() || new Date();
        const timeStr = t.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
        return `<div class="mgr-order-card">
          <span style="font-size:20px;">${o.payment==='visa'?'ğŸ’³':'ğŸ’µ'}</span>
          <div class="mgr-order-body">
            <div class="mgr-order-rest">${o.restName||'â€”'}</div>
            <div class="mgr-order-driver">ğŸ“ ${o.address||'â€”'}</div>
            <div class="mgr-order-time">â° ${timeStr}</div>
          </div>
          <div class="mgr-order-amount">Ø¬ ${o.delivery||0}</div>
        </div>`;
      }).join('')
    : '<div class="empty-state"><div class="empty-text">Ù„Ø§ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div></div>';

  document.getElementById('driverDetailOverlay').classList.add('show');
}

function closeDriverDetail() {
  document.getElementById('driverDetailOverlay').classList.remove('show');
  selectedDriverUid = null;
}

async function toggleDriverRole() {
  if (!selectedDriverUid) return;
  const driver = allDrivers.find(d => d.uid === selectedDriverUid);
  if (!driver) return;
  const newRole = driver.role === 'manager' ? 'driver' : 'manager';
  const label = newRole === 'manager' ? 'ØªØ±Ù‚ÙŠØ© Ù„Ù…Ø¯ÙŠØ±' : 'ØªØ­ÙˆÙŠÙ„ Ù„Ù…Ù†Ø¯ÙˆØ¨';
  showModal(label, `<p style="color:var(--text2);font-size:14px;">${label} "${driver.name}"ØŸ</p>`,
    [{ label: label, cls: 'confirm', action: async () => {
        await db.collection('users').doc(selectedDriverUid).update({ role: newRole });
        driver.role = newRole;
        renderDriversList();
        closeModal();
        showToast('âœ… ØªÙ… ' + label);
        document.getElementById('roleBtn').textContent = newRole === 'manager' ? 'ğŸ‘¤' : 'ğŸ‘‘';
    }},
    { label: 'Ø¥Ù„ØºØ§Ø¡', cls: 'cancel', action: closeModal }]);
}

async function changeDriverPin() {
  if (!selectedDriverUid) return;
  const driver = allDrivers.find(d => d.uid === selectedDriverUid);
  showModal('ØªØºÙŠÙŠØ± ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„', `
    <div class="input-group">
      <div class="input-label">ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ (6 Ø£Ø±Ù‚Ø§Ù…)</div>
      <input class="form-input" type="tel" id="newPinInput" placeholder="123456" maxlength="6" inputmode="numeric">
    </div>
    <div style="font-size:11px;color:var(--text3);margin-top:8px;">Ø§Ø¨Ø¹Øª Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</div>`,
    [{ label: 'Ø­ÙØ¸', cls: 'confirm', action: async () => {
        const newPin = document.getElementById('newPinInput').value.trim();
        if (newPin.length !== 6) { showToast('Ø§Ù„ÙƒÙˆØ¯ Ù„Ø§Ø²Ù… 6 Ø£Ø±Ù‚Ø§Ù…'); return; }
        // Update via Firestore (driver must re-login with new pin)
        await db.collection('users').doc(selectedDriverUid).update({ pinChanged: true, newPin });
        closeModal();
        showToast('âœ… Ø³ÙŠØ·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯');
    }},
    { label: 'Ø¥Ù„ØºØ§Ø¡', cls: 'cancel', action: closeModal }]);
}

async function removeDriver() {
  if (!selectedDriverUid) return;
  const driver = allDrivers.find(d => d.uid === selectedDriverUid);
  showModal('Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨', `<p style="color:var(--text2);font-size:14px;">Ø­Ø°Ù ${driver?.name || 'Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨'} Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ</p>`,
    [{ label: 'Ø­Ø°Ù', cls: 'danger', action: async () => {
        await db.collection('users').doc(selectedDriverUid).delete();
        allDrivers = allDrivers.filter(d => d.uid !== selectedDriverUid);
        renderDriversList();
        closeModal();
        closeDriverDetail();
        showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
    }},
    { label: 'Ø¥Ù„ØºØ§Ø¡', cls: 'cancel', action: closeModal }]);
}

// ============================================================
// MANAGER: RESTAURANTS
// ============================================================
async function loadMgrRestaurants() {
  const snap = await db.collection('restaurants').orderBy('name').get();
  const rests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  document.getElementById('mgrRestsList').innerHTML = rests.length
    ? rests.map(r => `<div class="rest-card">
        <span style="font-size:22px;">ğŸª</span>
        <span class="rest-name-big">${sanitize(r.name)}</span>
        <button class="rest-delete-btn" onclick="deleteMgrRest('${sanitize(r.id)}','${sanitize(r.name)}')">Ø­Ø°Ù</button>
      </div>`).join('')
    : '<div class="empty-state"><div class="empty-text">Ù„Ø§ Ù…Ø·Ø§Ø¹Ù… Ø¨Ø¹Ø¯</div></div>';
}

function showAddRestModal() {
  showModal('Ø¥Ø¶Ø§ÙØ© Ù…Ø·Ø¹Ù…', `<input class="form-input" id="newRestName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…">`,
    [{ label: 'Ø¥Ø¶Ø§ÙØ©', cls: 'confirm', action: async () => {
        const name = document.getElementById('newRestName').value.trim();
        if (!name) return;
        await db.collection('restaurants').add({ name, active: true, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        closeModal(); showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ' + name);
        loadMgrRestaurants();
    }},
    { label: 'Ø¥Ù„ØºØ§Ø¡', cls: 'cancel', action: closeModal }]);
}

async function deleteMgrRest(id, name) {
  // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ù„Ù„Ù…Ø·Ø¹Ù…
  const snap = await db.collection('orders').where('restId','==',id).limit(1).get();
  if (!snap.empty) {
    showModal('ØªÙ†Ø¨ÙŠÙ‡', `<p style="color:var(--text2);font-size:14px;">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù "${sanitize(name)}" Ù„Ø£Ù† Ù„Ø¯ÙŠÙ‡ Ø£ÙˆØ±Ø¯Ø±Ø§Øª.</p>`,
      [{ label: 'Ø­Ø³Ù†Ø§Ù‹', cls: 'cancel', action: closeModal }]);
    return;
  }
  showModal('Ø­Ø°Ù Ø§Ù„Ù…Ø·Ø¹Ù…', `<p style="color:var(--text2);">Ø­Ø°Ù ${sanitize(name)}ØŸ</p>`,
    [{ label: 'Ø­Ø°Ù', cls: 'danger', action: async () => {
        await db.collection('restaurants').doc(id).delete();
        closeModal(); showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        loadMgrRestaurants();
    }},
    { label: 'Ø¥Ù„ØºØ§Ø¡', cls: 'cancel', action: closeModal }]);
}

// ============================================================
// MANAGER: REPORTS
// ============================================================
function mgrTab(n, el) {
  document.querySelectorAll('.mgr-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.mgr-tab-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('mgrPanel' + n).classList.add('active');
  if (n === 1) renderDriversList();
  if (n === 2) loadMgrRestaurants();
  if (n === 3) renderMgrReports();
}

function setReportPeriod(p, el) {
  reportPeriod = p;
  document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderMgrReports();
}

function renderMgrReports() {
  const now = new Date();
  let startDate;
  if (reportPeriod === 'today') { startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); }
  else if (reportPeriod === 'week') { startDate = new Date(now); startDate.setDate(now.getDate() - 7); }
  else { startDate = new Date(now.getFullYear(), now.getMonth(), 1); }

  const filtered = allOrders.filter(o => {
    const t = o.timestamp?.toDate?.() || new Date(o.timestamp);
    return t >= startDate;
  });

  // Group by driver
  const byDriver = {};
  filtered.forEach(o => {
    if (!byDriver[o.driverId]) byDriver[o.driverId] = { name: o.driverName || 'â€”', orders:0, delivery:0, cash:0 };
    byDriver[o.driverId].orders++;
    byDriver[o.driverId].delivery += o.delivery || 0;
    if (o.payment === 'cash') byDriver[o.driverId].cash += o.total || 0;
  });

  const entries = Object.entries(byDriver).sort((a,b) => b[1].delivery - a[1].delivery);
  const totalDelivery = filtered.reduce((s,o) => s + (o.delivery||0), 0);

  document.getElementById('reportsContent').innerHTML = `
    <div class="mgr-stat" style="margin-bottom:14px;">
      <div class="mgr-stat-icon">ğŸ“Š</div>
      <div class="mgr-stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„</div>
      <div class="mgr-stat-val">Ø¬ ${totalDelivery}</div>
    </div>
    ${entries.map(([uid, d]) => `
      <div class="report-row">
        <div>
          <div class="report-driver-name">${d.name}</div>
          <div class="report-driver-orders">${d.orders} Ø£ÙˆØ±Ø¯Ø±</div>
        </div>
        <div class="report-driver-income">Ø¬ ${d.delivery}</div>
      </div>`).join('') || '<div class="empty-state"><div class="empty-text">Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª</div></div>'}`;
}

// ============================================================
// MODAL
// ============================================================
function showModal(title, bodyHTML, buttons) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = bodyHTML;
  document.getElementById('modalActions').innerHTML = buttons.map((b,i) =>
    `<button class="modal-btn ${b.cls}" id="mBtn${i}">${b.label}</button>`).join('');
  buttons.forEach((b,i) => document.getElementById('mBtn'+i).onclick = b.action);
  document.getElementById('modalOverlay').classList.add('show');
}
function closeModal() { document.getElementById('modalOverlay').classList.remove('show'); }
document.getElementById('modalOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// ============================================================
// TOAST
// ============================================================
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

// ============================================================
// START
// ============================================================
window.addEventListener("load", initApp);
</script>
</body>
</html>
