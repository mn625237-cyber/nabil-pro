<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0f1e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Nabil Pro">
<title>Nabil Pro üõµ</title>
<link id="manifest-link" rel="manifest">
<script>
// Inline manifest - no external file needed
const ICON_192 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAIAAADdvvtQAAAEqklEQVR4nO3VTapcZwxFUbdDwL00M5eMyTP0rNxzIFAxGPu9d/VzJJ0Nu13UlRb6Pv3x+W+ix32S/wNaHYAoFIAoFIDe6Os/f8r/w+R8Af0rIzf5F0lyAZTOBVL/dRmQBI0bpoOA5FasJN0BJJfhKWk9ILkDc0lbAcm3jqStgORrhtFWQPLVwmgrIPk6YbQVkHyFE5JvYSUg+dqmJd/IGkDyVU1Ovp3pgOQbmp98R0MByRezK/m+ZgGS7+NXffvyl/w/TDakB6TFkZUtIzGgvWJGeTIFdAyNFpMXIAc3EkkWgNzcNEs6DsicTg+js4Cg08boICDoNDO6Awg6hxmVA4KOnNFiQNAZwmglIPQ4GKoCBJ2BjBwByfc3ITtA0BnLaAEg9FgZSgaEHjdDmYCgs4jROEDo8TQ0BZB8Hxu7Awg9toYSAKHH2VAUEHomJDSkBCSf+6VWAkLPqCSGngNCz8D6DQkAyad8ux2AOD9jaz5CTwChZ3idhloBySfr01xA6NlSjyEAnW0iIPTsqsFQByD5HJ0bBIjzs7HqI1QOSD5BGgEIPaurMwQgi8SA0HOgIkMAckkGCD1nqjAEIKPWAJJPin5VNyDOz7HSj1A+IPmM6PcBiEL1AULP1RINAcixoYDkc6H3Vw6I83O7rCMEINPGAZJPhD5aISDOj0MpRwhAvg0CJJ8FPQtAFKoEEO+XT/FXDEDWjQAknwJFAhCFAhCFAhCFSgb00Z8D0PYebDwTkPz7KR6AKBSAKBSAKBSAKBSAKBSAKBSAKBSAKBSAKBSAKBSAKFQaIPTY9tgQF4h4wigWgCgUgCgUgCgUgCgUgCgUgCgUgCgUgCgUgCgUgCiUEhCGtvdg478DxBFyK6IHQAQgigUgCqUHhKG9Pdg1gOj/SgDxivkU1AMg96YAwtDG4u8XgKwrBMQr5lBcTyYgDO0q5fwAyLdyQLxit0vRkwwIQ1vKOj8AMq0JEIZOlqgHQI5NB4ShyT1b6HNAHKFj5eqpAoShmaWfHwB5pQGEoRtV6AGQUUpAGNpekR4AuaQHhKG91enpAIShjXpKAHGENlaqpwkQhnbpKQSEoUU16AHQ5YYCwtCKevR0A8LQcD1NgDA0uU49zwHxkI2tU48GEIYG6hEAwtC0+vVEAWFoThI9YkAYmqBHDAhD8oR6cgBhyFZPGiAMeeoZBAhDzXrGAcKQoZ5kQCmGYFRNJ1FPPiAMWekpAYQhHz1VgLIMwSiRToWeBYAwlDjJTYByDXkyyh1g0ZYLAWHovJ5yQOmGHBilT6x0v+WAKgxdZVQxqOrldgCC0Uk63YCKDG1nVDSTtp22AqoztJFR3Sg6F9oNqNTQFkalE2jepgBQtaGxkhq+un+VGkBtjCZI6vlM1RKVgNoM9WNq/i7hBsWA+g0VeRJ+hXZ9ekByRm8ik/+HmXRmAZpsaGbyfY0DBKNddIYCwtAiPUMBwWgFnemAYDSczg5A5ozkkz8CyJCRfNoHAZkwkk/4OKDDjORTNQJ0SZJ8htaAXskdWLl5dQfQK7kMBzevDgJ6Jbdy2M2ry4B+DDRFuQD6Obik5AvondnKeGcAolAAolAAolDfAYOGVRpMJjD1AAAAAElFTkSuQmCC";
const ICON_512 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAIAAAB7GkOtAAAT4ElEQVR4nO3ZTa4dyXVGUbcvDLjnpufiMXmGmpV6lkChimKRj+8nM3dEnAWsAfDdjPNtlPQfr//6HwAG+o/8XwBAQgAAhhIAgKEEAGAoAQAYSgAAhhIAgKEEAGAoAQAYSgAAhhIARvvb//5n/m+AigCwsX/M9wry3wE+RwBYXb7v2sCpBICF5HutCowiAGTyIV5H/i2YSQB4Tr6zu8i/FEMIAPfKx3R3+RfkYALAxfLFPFv+fTmJAHCBfBZnyr87uxMAPi9fQL7JXwKbEgA+Jh873pa/EDYiALxLvmt8VP5mWJ8A8JZ8xfi6/BWxLAHgJ/LN4g75u2I1AsCf8oXiGflLYxECgN2fK397tARgrnx9WEf+GkkIwET53LCm/GXyMAEYJN8XdpG/VZ4hACPkg8KO8nfL3QTgcPmIsLv8DXMfAThTvhqcJ3/VXE4ATpPPBGfLXzgXEoBz5NPAHPlr5xICcIJ8Dpgpf/l8kQDsLZ8AyK+ATxOAXeVnD9/LL4JPEID95KcOv5JfBx8iADvJzxveI78U3kkA9pCfNHxUfjX8lgCsLj9j+Ir8gniDAKwrP124Sn5N/JQArCg/V7hDfln8QACWk18p3Ce/L74nAAvJjxOekd8a3wjAEvKDhOfld4cA9PI7hEp+fcMJQCk/P1hBfoljCUAjPzlYTX6VAwlAIL80WFN+m9MIwKPyA4P15Xc6hwA8J78r/urv//ff+b+Bv8qvdQgBeEJ+Tmf7x4hX8r/9bPnlHk8Abpdf0THCoReGSn6/ZxOAG+XHs7V8xCVhHfktn0oA7pLfzF7ygZaExeUXfSQBuEV+LVvIJ3gd+bfYQn7X5xGAi+VHsrJ8Z3eRf6mV5Td+EgG4Un4ba8r3dF/5t1tTfunHEIBr5Cexmnw6z5N/09XkV38AAbhAfgnryFdygvwrryO//d0JwFflN5DLB3Gy/Ovn8gXYmgB8Sf76Q/n28b38PYTyHdiXAHxS/uhD+djxK/nbCOWbsCMB+Iz8rSfydeP98teSyJdhOwLwYfkrf1i+ZXxF/n4elu/DXgTgY/L3/aR8vLhK/paelK/ERgTgvfJn/Zh8rbhP/roeky/GFgTgXfLX/Ix8nnhG/tKeke/G+gTg9/J3/IB8knhe/uoekK/H4gTgN/IXfLd8hmjlL/Bu+YasTADekr/d++S7w2ryN3mffEmWJQC/lL/am+RDw8ry93mTfE/WJAA/kT/Wm+Tjwi7yt3qTfFtWIwA/yt/oHfJBYUf5u71DvjBLEYB/k7/Oy+Ujwu7yN3y5fGfWIQB/yt/l5fLt4Az5S75cvjaLEIB/yV/ktfLJ4Dz5q75WvjkrEIB/yt/ihfKZ4Gz5C79Qvjw5AThn/fNpYI78tV8l35/W9ADk7+8q+SIwTf7mr5KvUGh0APKXd4l8CJgsf/+XyLeoMjcA+Zv7uvz44Zv8Fr4uX6TE0ADkr+3r8puH7+UX8XX5Lj1vYgDyd/ZF+anDr+TXoQEfMi4A+Quz/pwtvxENeL9ZAcjflulniPxeNOA9BgUgf1XWn1Hyq9GA35oSgPw9mX5myi9IA94wIgD5S7L+TJbfkQb8yvkByN+Q9Yf8mjTgpw4PQP56TD/8Ib8sDfiBACwnv1K4T35fAvC9kwOQvxvrD3+VX5kG/OHYAOQvxvTDG/KL04DXqQHI34r1h9/K704DDgxA/kqsP7xTfn3DG3BaAPL3Yfrho/JLHNuAowKQvwzrD5+T3+PMBgiA9Ycl5FcpABvL34T1hy/Kb3NaAw4JQP4arD9cIr/QUQ04IQD5O7D+cKH8Tuc0YPsA5C/A9MMd8pud0AABsP6wqPxyBWBp+be3/nCr/H7PbsDGAci/uvWHB+RXfHADdg1A/r2tPzwmv+VTG7BlAPIvbf3hYflFH9kAAbD+sIf8rgWgl39j6w+V/LoPa8BmAci/rvWHVn7jJzVAAKw/bCa/dAGw/tYfMvm9n9GAbQKQf1HrD0vJr/6ABuwRgPxbWn9YUH77uzdAAKw/bCxfAAGw/kAm34F9G7B6APLvZ/1hffkabNoAAbD+cIJ8EwRgyvoLAKwm34QdG7BuAPJvZv1hL/kybNcAAbD+cI58HwTA+gOZfCU2asCKAci/k/WHreVbsUsDBMD6w4HyxRAA6w9k8t1YvwECIABwpnw3BMD6A5l8PRZvwEIByL+K9Yfz5BuycgMEwPrD4fIlEYD91l8A4Az5kizbAAGw/nC+fE8EwPoDmXxVFmxAH4D8G1h/GCLfltUaIAACAFPk2yIA1h/I5AuzVAMEwPrDLPnOCID1BzL52izSAAEQABgnX5vpAch/cesPk+Wbs0IDBMD6w1D58gwNQP5bCwCQL0/eAAGw/jBXvj/jApD/ytYf+EO+QmEDBKB/f0AoX6FBAch/X+sP/CDfoqoBcwOQvzlgHfkinR+A/JcVAOCn8kVKGjA0APlrA1aT79LJAch/UwEA3pDv0vMNmBiA/J0Ba8rX6cwA5L+m9QfeI9+oJxsgAAB/yjfqtADkv6P1B94vX6rHGiAAAP8mX6pzApD/gtYf+Kh8r55pgAAA/CjfKwGw/kAmX63tA5D/dtYf+LR8u+5ugAAA/Fy+XRsHIP/VrD/wRfmC3doAAQD4pXzBtgxA/ntZf+AS+Y7d1wABAHhLvmMCYP2BTL5mOwUg/6UEALhQvmY3NeDYAOQvBjhJvml7BCD/jQQAuFy+aXc0QAAAfi/fNAGw/kAmX7bVA5D/OgIA3CRftssbcGAA8lcCnCrfNwEQAKCR79u6Ach/F+sP3C1fuQsbIAAAH5CvnABYfyCTb91yAch/EQEAnpFv3VUNEACAj8m3TgCsP5DJF2+hAOS/hQAAT8oX75IGHBKA/DUA0+S7JwACADTy3VsiAPmvIADA8/Ld+3oDTghA/g6AmfL1EwABABr5+sUByP9+AQAq+fp9sQHbByB/AcBk+QYKAEAj38C5Aci/PcDQAOTpyz88QL6EAgDQyJdwYgDyrw7wzbgA5NHLPznAN/keCgBAI99DAQBo5Hs4KwD59wb43qAA5LnLPzbA9/JVFACARr6KUwKQf2mAvxIAAQCGEgABAIYaEYD2jxQAYE35Np4fgPwbA/yKAAgAMJQACAAw1OEBsP4Ab9ioAQIAcCUBEABgKAEQAGAoARAAYKhjA2D9AX5rlwYIAMDFBEAAgKEEQACAoQTA+gNzCYAAAEOdFoDw7xEAYC/tYAoAQEYABAAYSgAEABhKAKw/MJcACAAwlAAIADDUOQEI/xIBAHbUzqYAAGQEQACAoQTA+gNzCYAAAEMJgAAAQwmAAABDCYAAAEMJgAAAQ50QgPBvEABgX+14CgBARgCsPzCXAAgAMJQACAAwlAAIADCUAAgAMJQACAAwlAAIADCUAAgAMJQACAAwlAAIADCUAAgAMJQACAAwlAAIADCUAAgAMJQACAAwlAAIADCUAAgAMJQACAAwlAAIADCUAAgAMNTeAbD+AF+xbAP8FwDAjZZdfwEAuJcACAAwlAAIADCUAAgAMJQACAAwlAAIADCUAAgAMJQACAAwlAAIADCUAAgAMJQACAAwlAAIADCUAAgAMJQACAAwlAAIADCUAAgAMJQACAAwlAAIADCUAAgAMJQAaAAwUTueAgCQOSEA/lcggE9Yef0FAOBGAiAAwFACIADAUAIgAMBQAiAAwFACoAHARO1sCgBARgAEABjqnAD4vwEAPmTx9RcAgLsIgAAAQwmABgATtYMpAAAZARAAYCgBEABgqNMC0DYg/5wA77f++gsAwC0EQAOAidqpFACAjAAIADCUAAgAMNSZAdAAgLftsv4CAHAxARAAYCgBEABgKAEQAGCokwOgAQC/stH6CwDAlQRAAIChBEADgInybXwiAHkD8s8M8Fd7rb8AAFxGAAQAGEoANACYKF9FAQBo5Kv4XADyBuQfG+B7263/xgHQAGAd+R4KAEAj30MBAGjke/h0APIG5J8c4Jsd13/vAGgAsIJ8CQUAoJEvYROAvAH5hwfYdP23D4AGAK18AwUAoJFv4OgAaABQydcvDsAKDcgfATBTvn5fXG8BAPikfP0EQAOAQL57SwRghQbkTwGYJt+9r0+3AAB8Rr57AqABQCBfvIUCsEID8gcBzJEv3iW7fU4ANAB4Rr51AiAAQCPfuuUCsEID8mcBTJBv3VWjfVQANAC4W75yAiAAQCNfuUUDoAHA2fJ9u3D9BQDgA/J9EwANAAL5sq0egEUakD8U4Dz5sl27/scGQAOAa+WbJgACADTyTdsjAIs0IH8uwEnyTbt8/U8OgAYAV8nXbKcALNKA/NEAZ8jX7I71PzwAGgB8Xb5jAiAAQCPfsf0CoAHAAfIFu2/9BQDgLfmC7RoADQC2lm/XresvAAC/lG/X3gHQAGBT+Wrdvf6DAqABwPvleyUAAgA08r06JAAaAOwlX6pn1l8AAH6UL9VRAdAAYBf5Rj22/gIA8G/yjTowABoArC9fpyfXf2gANAD4q3yXTg7AUg3InxqwmnyXHl7/uQHQAOB7+SKdH4ClGpA/OGAd+SI9v/6jA6ABwDf5Fk0JgAYAS8lXqFp/ARAAmC5foVkB0ABgEfn+hOsvABoAc+XLMzQAqzUgf4jA8/LladdfADQAhso3Z3QANACo5GuzwvoLgADARPnaCIAGAIF8ZxZZfwHQAJglXxgB0AAgkG/LUusvAAIAg+TbIgAaAATyVVlt/VcJgAYAt8r3ZMH1FwANgPPlSyIAWzYgf7jA1+VLsub6C4AGwOHyDREADQAC+XqsvP7LBUADgKvku7H4+guAAMCx8t0QAA0AAvlirL/+AqABcKB8KwRAA4BAvhK7rP+6AdAA4BPyfdho/QVAA+Ac+TIIgAYAgXwTtlv/1QOwcgPy5w58L9+E7dZfADQATpCvgQBoABDId2DT9d8jABoA/Eq+APuuvwBoAGwsv30B0AANgEB+9buv/04B0ADgD/m9H7D+mwVAA4C/W38BWFZ+G3C2/MYFQAM0AAL5dZ+0/lsGQANgpvyuD1t/AdAA2EN+0QKwkPxLawA8Jr/lI9d/4wBoAAyRX/Gp6793ADQAjpff78Hrv30ANAAOll/u2esvABoAi8pvVgD2kL8AGYAL5Xc6ZP1fZwTgpQFwivxC56z/65gAvDQA9pff5qj1f50UgJcGwM7yq5y2/i8B0ABYQX6PAnCC/GVoAHxUfokz1/91XgBeuzVABpgsv77J6/86MgAvDYAd5Hc3fP1fpwbgpQGwtvzirP/r4AC8NmyADDBBfmXW/w8nB+ClAbCY/L6s//cEYEX5lcId8ssSgB8cHoDXtg2QAU6SX5P1/6nzA/DSAEjld2T9f2VEAF4aAJH8gqz/G6YE4LVzA2SAHeVXY/1/a1AAXhoAT8nvxfq/x6wAvDZvgAywvvxGrP/7jQvASwPgNvl1WP8PmRiA1/4N+JsMsJj8Ir4u36XnDQ3ASwPgOvktfF2+SIm5AXgd0YC/yQCp/P1fIt+iyugAvE5pwN9kgMflb/4q+QqFpgfgpQHwcflrv0q+Py0B+Kf8FV4onwbOlr/wC+XLkxOAf8nf4rXymeA8+au+Vr45KxCAP+Uv8nL5ZHCG/CVfLl+bRQjAv8nf5eXy7WB3+Ru+XL4z6xCAH+Wv8w75iLCj/N3eIV+YpQjAT+Rv9Cb5oLCL/K3eJN+W1QjAL+WP9Sb5uLCy/H3eJN+TNQnAW/JXe598aFhN/ibvky/JsgTgN/K3e7d8d2jlL/Bu+YasTAB+L3/BD8hniOflr+4B+XosTgDeJX/Hz8gniWfkL+0Z+W6sTwDeK3/Nj8nnifvkr+sx+WJsQQA+Jn/WT8rXiqvkb+lJ+UpsRAA+LH/fD8vHi6/I38/D8n3YiwB8Rv7KE/mW8X75a0nky7AdAfik/K2H8nXjV/K3Eco3YUcC8CX5ow/lY8f38vcQyndgXwLwVfnrz+XbN1n+9XP5AmxNAC6Q38A68kGcIP/K68hvf3cCcI38ElaTr+R58m+6mvzqDyAAV8pPYk35dO4r/3Zryi/9GAJwsfw2Vpbv6S7yL7Wy/MZPIgC3yI9kC/nOriP/FlvI7/o8AnCX/Fr2kk+w0V9cftFHEoAb5TeztXygzf068ls+lQDcLj+eY+Qjbu6fl9/v2QTgCfkVnc3Qnyq/3OMJwHPyc+KvjPia8msdQgAeld8VrC+/0zkEIJAfGKwpv81pBKCRXxqsJr/KgQSglJ8crCC/xLEEoJefH1Ty6xtOAJaQ3yE8L787BGAh+UHCM/Jb4xsBWE5+nHCf/L74ngCsKL9SuEN+WfxAANaVnytcJb8mfkoAVpefLnxFfkG8QQD2kJ8xfFR+NfyWAOwkP2l4j/xSeCcB2E9+3vAr+XXwIQKwq/zU4Xv5RfAJArC3/OwhvwI+TQBOkE8AM+Uvny8SgHPkc8Ac+WvnEgJwmnwaOFv+wrmQAJwpnwnOk79qLicAh8tXg93lb5j7CMAI+Yiwo/zdcjcBGCQfFHaRv1WeIQAT5fvCmvKXycMEYK58blhH/hpJCABKMFf+9mgJAH/K94hn5C+NRQgAP5EvFHfI3xWrEQDekm8WX5e/IpYlALxLvmJ8VP5mWJ8A8DH5rvG2/IWwEQHg8/Kx45v8JbApAeAC+QLOlH93dicAXCyfxbPl35eTCAD3yhdzd/kX5GACwHPyMd1F/qUYQgDI5Du7jvxbMJMAsJB8iM09owgAq8v32tZzKgFgY/m+W3m2JgCMZr6ZTAAAhhIAgKEEAGAoAQAYSgAAhhIAgKEEAGAoAQAYSgAAhhIAgKH+H3SLG20HmOyFAAAAAElFTkSuQmCC";
const manifestData = {
  name: "Nabil Pro",
  short_name: "Nabil Pro",
  description: "ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ŸàÿµŸäŸÑ",
  start_url: "./",
  display: "standalone",
  background_color: "#0a0f1e",
  theme_color: "#f97316",
  orientation: "portrait",
  lang: "ar",
  icons: [
    { src: ICON_192, sizes: "192x192", type: "image/png", purpose: "any maskable" },
    { src: ICON_512, sizes: "512x512", type: "image/png", purpose: "any maskable" }
  ]
};
const blob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(blob);
document.getElementById('manifest-link').href = manifestURL;
</script>

<script>
// ============================================================
// FCM Push Notifications ‚Äî Firebase Cloud Messaging
// ============================================================

const VAPID_KEY = 'BKX2GMWVcMyv2iKtOGYlUncelQya3PQV-gdJATLpVsB9OuhcqszVLE8ObleVs3eo0oykGAA7DNpQukV077keZz0';

let swRegistration = null;
let fcmToken       = null;

// ÿ™ÿ≥ÿ¨ŸäŸÑ Service Worker
async function registerSW() {
  if (!('serviceWorker' in navigator)) return;
  try {
    swRegistration = await navigator.serviceWorker.register('./sw.js');
    console.log('‚úÖ SW registered');
  } catch(err) {
    console.warn('SW registration failed:', err);
  }
}

// ÿßÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ Ÿàÿ≥ÿ¨ŸÑ ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿπŸÜÿØ FCM
async function subscribeFCM() {
  if (!swRegistration) return;
  if (!currentUser) return;

  try {
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') return;

    // ÿßÿ¥ÿ™ÿ±ŸÉ ŸÅŸä FCM ŸàÿÆÿØ ÿßŸÑŸÄ Token
    const messaging = firebase.messaging();
    fcmToken = await messaging.getToken({
      vapidKey: VAPID_KEY,
      serviceWorkerRegistration: swRegistration
    });

    if (fcmToken) {
      // ÿßÿ≠ŸÅÿ∏ ÿßŸÑŸÄ Token ŸÅŸä Firestore
      await db.collection('fcm_tokens').doc(currentUser.uid).set({
        token:     fcmToken,
        uid:       currentUser.uid,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      console.log('‚úÖ FCM token saved');
    }

    // ŸÑŸà ÿßŸÑŸÄ Token ÿßÿ™ÿ∫Ÿäÿ±
    messaging.onTokenRefresh(async () => {
      const newToken = await messaging.getToken({ vapidKey: VAPID_KEY });
      await db.collection('fcm_tokens').doc(currentUser.uid).set({
        token: newToken, uid: currentUser.uid,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    // ÿßÿ≥ÿ™ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÑŸÖÿß ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÖŸÅÿ™Ÿàÿ≠
    messaging.onMessage(payload => {
      const title = payload.notification?.title || 'Nabil Pro';
      const body  = payload.notification?.body  || '';
      showToast(`üîî ${title}: ${body}`);
      // ÿßŸáÿ™ÿ≤ÿßÿ≤
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    });

  } catch(err) {
    console.warn('FCM subscription failed:', err);
  }
}

// ŸÖÿ¥ ŸÖÿ≠ÿ™ÿßÿ¨ sendPushNotification ‚Äî Render ÿ®Ÿäÿ™ŸÉŸÑŸÖ ÿ®ŸäÿπŸÖŸÑ ÿØŸá
function sendPushNotification() {} // placeholder

function subscribeToNtfy() {} // placeholder

// ÿßÿ®ÿØÿ£
window.addEventListener('load', () => {
  registerSW();
});
</script>
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAIAAADdvvtQAAAEqklEQVR4nO3VTapcZwxFUbdDwL00M5eMyTP0rNxzIFAxGPu9d/VzJJ0Nu13UlRb6Pv3x+W+ix32S/wNaHYAoFIAoFIDe6Os/f8r/w+R8Af0rIzf5F0lyAZTOBVL/dRmQBI0bpoOA5FasJN0BJJfhKWk9ILkDc0lbAcm3jqStgORrhtFWQPLVwmgrIPk6YbQVkHyFE5JvYSUg+dqmJd/IGkDyVU1Ovp3pgOQbmp98R0MByRezK/m+ZgGS7+NXffvyl/w/TDakB6TFkZUtIzGgvWJGeTIFdAyNFpMXIAc3EkkWgNzcNEs6DsicTg+js4Cg08boICDoNDO6Awg6hxmVA4KOnNFiQNAZwmglIPQ4GKoCBJ2BjBwByfc3ITtA0BnLaAEg9FgZSgaEHjdDmYCgs4jROEDo8TQ0BZB8Hxu7Awg9toYSAKHH2VAUEHomJDSkBCSf+6VWAkLPqCSGngNCz8D6DQkAyad8ux2AOD9jaz5CTwChZ3idhloBySfr01xA6NlSjyEAnW0iIPTsqsFQByD5HJ0bBIjzs7HqI1QOSD5BGgEIPaurMwQgi8SA0HOgIkMAckkGCD1nqjAEIKPWAJJPin5VNyDOz7HSj1A+IPmM6PcBiEL1AULP1RINAcixoYDkc6H3Vw6I83O7rCMEINPGAZJPhD5aISDOj0MpRwhAvg0CJJ8FPQtAFKoEEO+XT/FXDEDWjQAknwJFAhCFAhCFAhCFSgb00Z8D0PYebDwTkPz7KR6AKBSAKBSAKBSAKBSAKBSAKBSAKBSAKBSAKBSAKBSAKFQaIPTY9tgQF4h4wigWgCgUgCgUgCgUgCgUgCgUgCgUgCgUgCgUgCgUgCiUEhCGtvdg478DxBFyK6IHQAQgigUgCqUHhKG9Pdg1gOj/SgDxivkU1AMg96YAwtDG4u8XgKwrBMQr5lBcTyYgDO0q5fwAyLdyQLxit0vRkwwIQ1vKOj8AMq0JEIZOlqgHQI5NB4ShyT1b6HNAHKFj5eqpAoShmaWfHwB5pQGEoRtV6AGQUUpAGNpekR4AuaQHhKG91enpAIShjXpKAHGENlaqpwkQhnbpKQSEoUU16AHQ5YYCwtCKevR0A8LQcD1NgDA0uU49zwHxkI2tU48GEIYG6hEAwtC0+vVEAWFoThI9YkAYmqBHDAhD8oR6cgBhyFZPGiAMeeoZBAhDzXrGAcKQoZ5kQCmGYFRNJ1FPPiAMWekpAYQhHz1VgLIMwSiRToWeBYAwlDjJTYByDXkyyh1g0ZYLAWHovJ5yQOmGHBilT6x0v+WAKgxdZVQxqOrldgCC0Uk63YCKDG1nVDSTtp22AqoztJFR3Sg6F9oNqNTQFkalE2jepgBQtaGxkhq+un+VGkBtjCZI6vlM1RKVgNoM9WNq/i7hBsWA+g0VeRJ+hXZ9ekByRm8ik/+HmXRmAZpsaGbyfY0DBKNddIYCwtAiPUMBwWgFnemAYDSczg5A5ozkkz8CyJCRfNoHAZkwkk/4OKDDjORTNQJ0SZJ8htaAXskdWLl5dQfQK7kMBzevDgJ6Jbdy2M2ry4B+DDRFuQD6Obik5AvondnKeGcAolAAolAAolDfAYOGVRpMJjD1AAAAAElFTkSuQmCC">
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAIAAADdvvtQAAAEqklEQVR4nO3VTapcZwxFUbdDwL00M5eMyTP0rNxzIFAxGPu9d/VzJJ0Nu13UlRb6Pv3x+W+ix32S/wNaHYAoFIAoFIDe6Os/f8r/w+R8Af0rIzf5F0lyAZTOBVL/dRmQBI0bpoOA5FasJN0BJJfhKWk9ILkDc0lbAcm3jqStgORrhtFWQPLVwmgrIPk6YbQVkHyFE5JvYSUg+dqmJd/IGkDyVU1Ovp3pgOQbmp98R0MByRezK/m+ZgGS7+NXffvyl/w/TDakB6TFkZUtIzGgvWJGeTIFdAyNFpMXIAc3EkkWgNzcNEs6DsicTg+js4Cg08boICDoNDO6Awg6hxmVA4KOnNFiQNAZwmglIPQ4GKoCBJ2BjBwByfc3ITtA0BnLaAEg9FgZSgaEHjdDmYCgs4jROEDo8TQ0BZB8Hxu7Awg9toYSAKHH2VAUEHomJDSkBCSf+6VWAkLPqCSGngNCz8D6DQkAyad8ux2AOD9jaz5CTwChZ3idhloBySfr01xA6NlSjyEAnW0iIPTsqsFQByD5HJ0bBIjzs7HqI1QOSD5BGgEIPaurMwQgi8SA0HOgIkMAckkGCD1nqjAEIKPWAJJPin5VNyDOz7HSj1A+IPmM6PcBiEL1AULP1RINAcixoYDkc6H3Vw6I83O7rCMEINPGAZJPhD5aISDOj0MpRwhAvg0CJJ8FPQtAFKoEEO+XT/FXDEDWjQAknwJFAhCFAhCFAhCFSgb00Z8D0PYebDwTkPz7KR6AKBSAKBSAKBSAKBSAKBSAKBSAKBSAKBSAKBSAKBSAKFQaIPTY9tgQF4h4wigWgCgUgCgUgCgUgCgUgCgUgCgUgCgUgCgUgCgUgCiUEhCGtvdg478DxBFyK6IHQAQgigUgCqUHhKG9Pdg1gOj/SgDxivkU1AMg96YAwtDG4u8XgKwrBMQr5lBcTyYgDO0q5fwAyLdyQLxit0vRkwwIQ1vKOj8AMq0JEIZOlqgHQI5NB4ShyT1b6HNAHKFj5eqpAoShmaWfHwB5pQGEoRtV6AGQUUpAGNpekR4AuaQHhKG91enpAIShjXpKAHGENlaqpwkQhnbpKQSEoUU16AHQ5YYCwtCKevR0A8LQcD1NgDA0uU49zwHxkI2tU48GEIYG6hEAwtC0+vVEAWFoThI9YkAYmqBHDAhD8oR6cgBhyFZPGiAMeeoZBAhDzXrGAcKQoZ5kQCmGYFRNJ1FPPiAMWekpAYQhHz1VgLIMwSiRToWeBYAwlDjJTYByDXkyyh1g0ZYLAWHovJ5yQOmGHBilT6x0v+WAKgxdZVQxqOrldgCC0Uk63YCKDG1nVDSTtp22AqoztJFR3Sg6F9oNqNTQFkalE2jepgBQtaGxkhq+un+VGkBtjCZI6vlM1RKVgNoM9WNq/i7hBsWA+g0VeRJ+hXZ9ekByRm8ik/+HmXRmAZpsaGbyfY0DBKNddIYCwtAiPUMBwWgFnemAYDSczg5A5ozkkz8CyJCRfNoHAZkwkk/4OKDDjORTNQJ0SZJ8htaAXskdWLl5dQfQK7kMBzevDgJ6Jbdy2M2ry4B+DDRFuQD6Obik5AvondnKeGcAolAAolAAolDfAYOGVRpMJjD1AAAAAElFTkSuQmCC">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js"></script>

<style>
/* ============================================================
   DESIGN SYSTEM
   ============================================================ */
:root {
  --bg: #0a0f1e;
  --bg2: #111827;
  --bg3: #1a2236;
  --card: rgba(17,24,39,0.95);
  --card-border: rgba(255,255,255,0.07);
  --text: #f1f5f9;
  --text2: #94a3b8;
  --text3: #64748b;
  --primary: #f97316;
  --primary-dark: #c2410c;
  --primary-glow: rgba(249,115,22,0.2);
  --success: #22c55e;
  --success-bg: rgba(34,197,94,0.1);
  --danger: #ef4444;
  --danger-bg: rgba(239,68,68,0.1);
  --visa: #818cf8;
  --cash: #22c55e;
  --radius: 18px;
  --radius-sm: 12px;
  --shadow: 0 8px 32px rgba(0,0,0,0.5);
  --nav-h: 68px;
  --header-h: 62px;
}
[data-theme="light"] {
  --bg: #f8fafc;
  --bg2: #ffffff;
  --bg3: #e2e8f0;
  --card: #ffffff;
  --card-border: rgba(0,0,0,0.08);
  --text: #0f172a;
  --text2: #334155;
  --text3: #64748b;
  --primary-glow: rgba(249,115,22,0.12);
  --shadow: 0 4px 20px rgba(0,0,0,0.08);
}
/* Light mode overrides for elements with hardcoded dark colors */
[data-theme="light"] .auth-card { background:#ffffff; box-shadow:0 8px 40px rgba(0,0,0,0.1); }
[data-theme="light"] .pin-dot { background:rgba(0,0,0,0.15); }
[data-theme="light"] .pin-dot.filled { background:var(--primary); }
[data-theme="light"] .mgr-stat-big.s1 { background:linear-gradient(145deg,rgba(34,197,94,0.12),rgba(34,197,94,0.03)); }
[data-theme="light"] .mgr-stat-big.s2 { background:linear-gradient(145deg,rgba(249,115,22,0.12),rgba(249,115,22,0.03)); }
[data-theme="light"] .mgr-stat-big.s3 { background:linear-gradient(145deg,rgba(129,140,248,0.12),rgba(129,140,248,0.03)); }
[data-theme="light"] .mgr-stat-big.s4 { background:linear-gradient(145deg,rgba(245,158,11,0.12),rgba(245,158,11,0.03)); }
[data-theme="light"] .mgr-stat-big-label { color:rgba(0,0,0,0.45); }
[data-theme="light"] .feed-dot { background:#ef4444; }
[data-theme="light"] .user-section-label { color:var(--text3); }

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; user-select:none; -webkit-user-select:none; }
body { font-family:'Cairo',sans-serif; background:var(--bg); color:var(--text); height:100dvh; overflow:hidden; }
input, textarea { user-select:text; -webkit-user-select:text; }
input,textarea,select { font-family:'Cairo',sans-serif; }

/* ============================================================
   SCREEN MANAGEMENT
   ============================================================ */
.screen { display:none; width:100%; height:100dvh; position:fixed; inset:0; z-index:10; }
.screen.active { display:flex; }

/* ============================================================
   OFFLINE SCREEN
   ============================================================ */
#offlineScreen {
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:var(--bg);
  gap:20px;
  padding:40px;
}
.offline-icon {
  width:100px; height:100px;
  background:rgba(239,68,68,0.1);
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:48px;
  animation: pulse-red 2s infinite;
}
@keyframes pulse-red {
  0%,100% { box-shadow:0 0 0 0 rgba(239,68,68,0.3); }
  50% { box-shadow:0 0 0 20px rgba(239,68,68,0); }
}
.offline-title { font-size:22px; font-weight:700; color:var(--text); }
.offline-sub { font-size:14px; color:var(--text2); text-align:center; line-height:1.6; }
.offline-btn {
  background:var(--primary); color:#fff; border:none;
  padding:14px 32px; border-radius:50px; font-size:15px;
  font-weight:700; font-family:'Cairo',sans-serif; cursor:pointer;
  margin-top:10px;
}

/* ============================================================
   LOADING SCREEN
   ============================================================ */
#loadingScreen {
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:var(--bg);
  gap:16px;
}
.loading-logo {
  width:80px; height:80px;
  background:var(--primary-glow);
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:38px;
  animation: spin-glow 2s linear infinite;
}
@keyframes spin-glow {
  0%,100% { box-shadow:0 0 20px var(--primary-glow); transform:scale(1); }
  50% { box-shadow:0 0 40px var(--primary-glow); transform:scale(1.05); }
}
.loading-text { font-size:13px; color:var(--text2); }
.loading-bar {
  width:160px; height:3px;
  background:var(--bg3);
  border-radius:10px;
  overflow:hidden;
}
.loading-bar-fill {
  height:100%;
  background:var(--primary);
  border-radius:10px;
  animation:loading-anim 1.5s ease-in-out infinite;
}
@keyframes loading-anim {
  0% { width:0%; margin-right:100%; }
  50% { width:60%; margin-right:40%; }
  100% { width:0%; margin-right:0%; margin-left:100%; }
}

/* ============================================================
   AUTH SCREEN
   ============================================================ */
#authScreen {
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:var(--bg);
  padding:24px;
}
.auth-card {
  width:100%;
  max-width:380px;
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:24px;
  padding:32px 24px;
  box-shadow:var(--shadow);
}
.auth-logo {
  width:70px; height:70px;
  background:var(--primary-glow);
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:34px;
  margin:0 auto 16px;
}
.auth-title { text-align:center; font-size:22px; font-weight:900; margin-bottom:4px; }
.auth-sub { text-align:center; font-size:13px; color:var(--text2); margin-bottom:28px; }

.auth-step { display:none; flex-direction:column; gap:16px; }
.auth-step.active { display:flex; }

.input-group { display:flex; flex-direction:column; gap:6px; }
.input-label { font-size:13px; font-weight:600; color:var(--text2); }
.input-row {
  display:flex;
  background:var(--bg3);
  border:1px solid var(--card-border);
  border-radius:14px;
  overflow:hidden;
  transition:border-color .2s;
}
.input-row:focus-within { border-color:var(--primary); }
.input-prefix {
  padding:0 14px;
  display:flex; align-items:center;
  font-size:15px; font-weight:600;
  color:var(--text2);
  border-left:1px solid var(--card-border);
}
.input-row input {
  flex:1;
  background:transparent;
  border:none; outline:none;
  padding:14px 16px;
  font-size:16px;
  color:var(--text);
  direction:ltr;
  text-align:right;
}
.otp-input {
  background:var(--bg3);
  border:1px solid var(--card-border);
  border-radius:14px;
  padding:16px;
  font-size:24px;
  font-weight:700;
  text-align:center;
  color:var(--text);
  width:100%;
  letter-spacing:8px;
  direction:ltr;
  outline:none;
  transition:border-color .2s;
}
.otp-input:focus { border-color:var(--primary); }

.auth-btn {
  background:var(--primary);
  color:#fff; border:none;
  padding:16px;
  border-radius:14px;
  font-size:16px; font-weight:700;
  font-family:'Cairo',sans-serif;
  cursor:pointer;
  transition:opacity .2s, transform .1s;
  display:flex; align-items:center; justify-content:center; gap:8px;
}
.auth-btn:active { transform:scale(0.98); }
.auth-btn:disabled { opacity:0.5; cursor:default; }
.auth-btn.secondary {
  background:transparent;
  color:var(--text2);
  border:1px solid var(--card-border);
  font-size:14px;
}

.otp-timer { text-align:center; font-size:13px; color:var(--text3); }
.otp-timer span { color:var(--primary); font-weight:700; }
#recaptcha-container { margin:0 auto; }

/* ============================================================
   DRIVER APP
   ============================================================ */
#driverApp {
  flex-direction:column;
  background:var(--bg);
  overflow:hidden;
}

/* Header */
.header {
  height:var(--header-h);
  background:var(--card);
  border-bottom:1px solid var(--card-border);
  display:flex; align-items:center;
  padding:0 16px;
  gap:10px;
  position:relative;
  z-index:100;
  flex-shrink:0;
}
.header-logo { font-size:26px; }
.header-title { font-size:18px; font-weight:900; color:var(--primary); flex:1; }
.icon-btn {
  width:40px; height:40px;
  background:var(--bg3);
  border:none; border-radius:12px;
  font-size:18px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition:background .2s;
  color:var(--text);
}
.icon-btn:active { background:var(--primary-glow); }

/* Status bar */
.status-bar {
  padding:6px 16px;
  font-size:12px;
  font-weight:600;
  display:flex; align-items:center; gap:6px;
  flex-shrink:0;
}
.status-dot {
  width:7px; height:7px;
  border-radius:50%;
  background:var(--success);
  animation: pulse-dot 2s infinite;
}
.status-dot.error { background:var(--danger); animation:none; }
@keyframes pulse-dot {
  0%,100% { opacity:1; } 50% { opacity:0.4; }
}
.status-bar.ok { background:rgba(34,197,94,0.08); color:var(--success); }
.status-bar.err { background:rgba(239,68,68,0.08); color:var(--danger); }

/* Page system */
.pages-wrapper {
  display:flex;
  flex:1;
  overflow:hidden;
  transition:transform 0.35s cubic-bezier(0.4,0,0.2,1);
  width:400%;
}
.page { width:25%; flex-shrink:0; overflow-y:auto; padding:16px; padding-bottom:calc(var(--nav-h) + 16px); }

/* Bottom Nav */
.bottom-nav {
  height:var(--nav-h);
  background:var(--card);
  border-top:1px solid var(--card-border);
  display:flex;
  position:fixed; bottom:0; left:0; right:0;
  z-index:100;
  padding-bottom:env(safe-area-inset-bottom);
}
.nav-item {
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  gap:3px; border:none; background:transparent;
  cursor:pointer; color:var(--text3);
  font-size:10px; font-weight:600;
  font-family:'Cairo',sans-serif;
  transition:color .2s;
  padding:8px 0;
}
.nav-item.active { color:var(--primary); }
.nav-item .nav-icon { font-size:22px; }
.nav-item .nav-plus {
  width:48px; height:48px;
  background:var(--primary);
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:26px; color:#fff;
  box-shadow:0 4px 16px var(--primary-glow);
  margin-top:-8px;
}

/* Welcome card */
.welcome {
  background:linear-gradient(135deg,#1a0a00,#2d1500);
  border:1px solid rgba(249,115,22,0.2);
  border-radius:var(--radius);
  padding:20px;
  position:relative;
  overflow:hidden;
  margin-bottom:16px;
}
.welcome::before {
  content:'üõµ';
  position:absolute; left:16px; bottom:-8px;
  font-size:72px; opacity:0.08;
}
.welcome-greeting { font-size:13px; color:rgba(249,115,22,0.7); margin-bottom:2px; }
.welcome-name { font-size:20px; font-weight:900; color:#fff; margin-bottom:4px; }
.welcome-time { font-size:28px; font-weight:900; color:var(--primary); }

/* Stats */
.stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
.stat-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  padding:14px;
  position:relative;
  overflow:hidden;
}
.stat-card::after {
  content:'';
  position:absolute; bottom:0; left:0; right:0; height:3px;
}
.stat-card.c1::after { background:var(--success); }
.stat-card.c2::after { background:var(--primary); }
.stat-card.c3::after { background:var(--visa); }
.stat-card.c4::after { background:#f59e0b; }
.stat-icon { font-size:22px; margin-bottom:6px; }
.stat-label { font-size:11px; color:var(--text2); margin-bottom:4px; }
.stat-val { font-size:20px; font-weight:900; }
.stat-card.c1 .stat-val { color:var(--success); }
.stat-card.c2 .stat-val { color:var(--primary); }
.stat-card.c3 .stat-val { color:var(--visa); }
.stat-card.c4 .stat-val { color:#f59e0b; }

/* Section */
.section-title {
  font-size:14px; font-weight:700;
  color:var(--text2); margin-bottom:12px;
  display:flex; align-items:center; gap:6px;
}

/* Report rows */
.report-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  margin-bottom:8px;
  overflow:hidden;
}
.report-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 16px;
  cursor:pointer;
}
.report-rest { font-size:15px; font-weight:700; }
.report-count { font-size:12px; color:var(--text2); }
.report-delivery { font-size:15px; font-weight:700; color:var(--success); }
.report-body { padding:0 16px 14px; display:none; }
.report-body.open { display:block; }
.report-detail { display:flex; justify-content:space-between; font-size:12px; color:var(--text2); padding:3px 0; }

/* Add order page */
.form-section { margin-bottom:16px; }
.form-label {
  font-size:13px; font-weight:600;
  color:var(--text2); margin-bottom:8px;
  display:flex; align-items:center; gap:6px;
}
.form-input {
  width:100%; background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  padding:14px 16px;
  font-size:15px; color:var(--text);
  font-family:'Cairo',sans-serif;
  outline:none;
  transition:border-color .2s;
}
.form-input:focus { border-color:var(--primary); }
.input-with-voice { position:relative; }
.voice-btn {
  position:absolute; left:12px; top:50%; transform:translateY(-50%);
  background:var(--bg3); border:none; border-radius:8px;
  width:32px; height:32px; font-size:16px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
}
.voice-btn.active { background:var(--danger); animation:pulse-red 1s infinite; }

.rest-chips { display:flex; flex-wrap:wrap; gap:8px; }
.rest-chip {
  padding:8px 16px;
  background:var(--bg3);
  border:1px solid var(--card-border);
  border-radius:50px;
  font-size:13px; font-weight:600;
  cursor:pointer; color:var(--text2);
  font-family:'Cairo',sans-serif;
  transition:all .2s;
}
.rest-chip.active {
  background:var(--primary-glow);
  border-color:var(--primary);
  color:var(--primary);
}
.rest-chip.add-chip {
  background:transparent;
  border-style:dashed;
  color:var(--text3);
}

.payment-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.pay-opt {
  padding:14px;
  background:var(--bg3);
  border:2px solid transparent;
  border-radius:var(--radius-sm);
  text-align:center; cursor:pointer;
  transition:all .2s;
}
.pay-opt.active-cash { border-color:var(--cash); background:rgba(34,197,94,0.1); }
.pay-opt.active-visa { border-color:var(--visa); background:rgba(129,140,248,0.1); }
.pay-opt-icon { font-size:24px; margin-bottom:4px; }
.pay-opt-label { font-size:13px; font-weight:700; }
.pay-opt-note { font-size:11px; color:var(--text3); margin-top:2px; }

.submit-btn {
  width:100%; background:var(--primary); color:#fff;
  border:none; padding:18px;
  border-radius:var(--radius-sm);
  font-size:17px; font-weight:900;
  font-family:'Cairo',sans-serif;
  cursor:pointer; margin-top:8px;
  transition:opacity .2s, transform .1s;
}
.submit-btn:active { transform:scale(0.98); }

/* Order cards */
.filter-row { display:flex; gap:8px; margin-bottom:14px; overflow-x:auto; padding-bottom:4px; }
.filter-chip {
  padding:6px 14px;
  background:var(--bg3);
  border:1px solid var(--card-border);
  border-radius:50px;
  font-size:12px; font-weight:600;
  cursor:pointer; color:var(--text2);
  white-space:nowrap;
  font-family:'Cairo',sans-serif;
  transition:all .2s;
}
.filter-chip.active { background:var(--primary-glow); border-color:var(--primary); color:var(--primary); }

.order-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  padding:14px;
  margin-bottom:10px;
  position:relative;
  overflow:hidden;
}
.order-card::before {
  content:'';
  position:absolute; top:0; right:0; bottom:0; width:4px;
}
.order-card.cash::before { background:var(--cash); }
.order-card.visa::before { background:var(--visa); }

.order-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.order-rest { font-size:15px; font-weight:700; }
.order-time { font-size:11px; color:var(--text3); }
.order-body { display:flex; justify-content:space-between; align-items:center; }
.order-details { font-size:12px; color:var(--text2); line-height:1.8; }
.order-amount { text-align:left; }
.order-delivery { font-size:18px; font-weight:900; color:var(--success); }
.order-total { font-size:11px; color:var(--text3); }
.order-actions { display:flex; gap:6px; margin-top:10px; padding-top:10px; border-top:1px solid var(--card-border); }
.action-btn {
  flex:1; padding:8px;
  border-radius:10px; border:none;
  font-size:12px; font-weight:700;
  font-family:'Cairo',sans-serif;
  cursor:pointer;
}
.action-btn.edit { background:rgba(249,115,22,0.1); color:var(--primary); }
.action-btn.delete { background:var(--danger-bg); color:var(--danger); }

/* Settings */
.settings-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  overflow:hidden;
  margin-bottom:16px;
}
.settings-row {
  display:flex; align-items:center; gap:14px;
  padding:16px; border-bottom:1px solid var(--card-border);
  cursor:pointer;
}
.settings-row:last-child { border-bottom:none; }
.settings-icon { font-size:20px; width:32px; text-align:center; }
.settings-label { flex:1; font-size:14px; font-weight:600; }
.settings-val { font-size:13px; color:var(--text2); }
.toggle {
  width:44px; height:24px;
  background:var(--bg3); border-radius:50px;
  position:relative; cursor:pointer; transition:background .2s;
}
.toggle::after {
  content:'';
  position:absolute; top:2px; right:2px;
  width:20px; height:20px;
  background:#fff; border-radius:50%;
  transition:transform .2s;
}
.toggle.on { background:var(--primary); }
.toggle.on::after { transform:translateX(-20px); }

/* Empty state */
.empty-state { text-align:center; padding:48px 16px; color:var(--text3); }
.empty-icon { font-size:48px; margin-bottom:12px; opacity:0.5; }
.empty-text { font-size:14px; }

/* Toast */
.toast {
  position:fixed; bottom:calc(var(--nav-h) + 16px); left:50%;
  transform:translateX(-50%) translateY(20px);
  background:rgba(30,40,60,0.95);
  color:#fff; padding:12px 20px;
  border-radius:50px; font-size:14px; font-weight:600;
  z-index:9999; white-space:nowrap;
  opacity:0; transition:all .3s;
  backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,0.1);
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* Modal */
.modal-overlay {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.7);
  z-index:500; display:none;
  align-items:flex-end; justify-content:center;
  backdrop-filter:blur(4px);
}
.modal-overlay.show { display:flex; }
.modal {
  background:var(--bg2);
  border-radius:24px 24px 0 0;
  padding:24px;
  width:100%; max-height:80dvh;
  overflow-y:auto;
  animation:slide-up .3s ease;
}
@keyframes slide-up { from { transform:translateY(100%); } to { transform:translateY(0); } }
.modal-title { font-size:18px; font-weight:900; margin-bottom:20px; }
.modal-actions { display:flex; gap:10px; margin-top:20px; }
.modal-btn {
  flex:1; padding:14px;
  border-radius:var(--radius-sm);
  border:none; font-size:15px; font-weight:700;
  font-family:'Cairo',sans-serif; cursor:pointer;
}
.modal-btn.confirm { background:var(--primary); color:#fff; }
.modal-btn.cancel { background:var(--bg3); color:var(--text); }
.modal-btn.danger { background:var(--danger); color:#fff; }

/* ============================================================
   MANAGER APP - REDESIGNED
   ============================================================ */
#managerApp {
  flex-direction:column;
  background:var(--bg);
  overflow:hidden;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MANAGER HEADER - Premium Redesign
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.mgr-header {
  background:var(--bg);
  border-bottom:1px solid var(--card-border);
  padding:0 16px;
  height:64px;
  display:flex; align-items:center; gap:10px;
  flex-shrink:0; z-index:100;
  position:relative;
}
.mgr-header::after {
  content:''; position:absolute;
  bottom:0; left:16px; right:16px; height:1px;
  background:linear-gradient(90deg,transparent,var(--primary),transparent);
  opacity:0.3;
}
.mgr-header-title {
  font-size:16px; font-weight:900; flex:1;
  background:linear-gradient(135deg,var(--text),var(--text2));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.mgr-badge {
  background:linear-gradient(135deg, var(--primary), #ea6810);
  color:#fff; padding:4px 12px; border-radius:50px;
  font-size:10px; font-weight:800; letter-spacing:0.5px;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TABS - Bottom Navigation Style
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.mgr-tabs {
  display:flex; background:var(--bg2);
  border-top:1px solid var(--card-border);
  flex-shrink:0; overflow-x:auto; scrollbar-width:none;
  position:sticky; bottom:0; z-index:50;
  order:999;
}
.mgr-tabs::-webkit-scrollbar { display:none; }
.mgr-tab {
  flex:1; padding:10px 4px 8px;
  border:none; background:transparent;
  font-family:'Cairo',sans-serif;
  font-size:10px; font-weight:700;
  color:var(--text3); cursor:pointer;
  border-top:2px solid transparent;
  white-space:nowrap; min-width:64px;
  transition:all .2s;
  display:flex; flex-direction:column;
  align-items:center; gap:2px;
}
.mgr-tab .tab-icon { font-size:20px; }
.mgr-tab.active { color:var(--primary); border-top-color:var(--primary); background:var(--primary-glow); }

.mgr-content {
  flex:1; overflow-y:auto;
  padding:0; padding-bottom:0;
}
.mgr-tab-panel { display:none; padding:16px; animation:fadeUp .2s ease; }
.mgr-tab-panel.active { display:block; }
@keyframes fadeUp { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:none; } }

/* ---- OVERVIEW: Hero stats ---- */
.mgr-hero {
  background:linear-gradient(135deg,#1a0a00 0%,#2d1500 100%);
  border-bottom:1px solid rgba(249,115,22,0.15);
  padding:20px 16px 16px;
  margin:-16px -16px 16px;
}
.mgr-hero-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
.mgr-hero-date { font-size:12px; color:rgba(249,115,22,0.7); }
.mgr-hero-title { font-size:16px; font-weight:900; color:#fff; }

/* ============================================================
   MANAGER DASHBOARD - REDESIGNED
   ============================================================ */

/* Stats Grid */
.mgr-stats-big { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px; }
.mgr-stat-big {
  border-radius:20px; padding:18px 16px;
  position:relative; overflow:hidden;
  cursor:default;
}
.mgr-stat-big::before {
  content:''; position:absolute;
  top:-30px; left:-30px;
  width:100px; height:100px;
  border-radius:50%;
  opacity:0.15;
}
.mgr-stat-big.s1 { background:linear-gradient(145deg,rgba(34,197,94,0.15),rgba(34,197,94,0.04)); border:1px solid rgba(34,197,94,0.2); }
.mgr-stat-big.s2 { background:linear-gradient(145deg,rgba(249,115,22,0.15),rgba(249,115,22,0.04)); border:1px solid rgba(249,115,22,0.2); }
.mgr-stat-big.s3 { background:linear-gradient(145deg,rgba(129,140,248,0.15),rgba(129,140,248,0.04)); border:1px solid rgba(129,140,248,0.2); }
.mgr-stat-big.s4 { background:linear-gradient(145deg,rgba(245,158,11,0.15),rgba(245,158,11,0.04)); border:1px solid rgba(245,158,11,0.2); }
.mgr-stat-big.s1::before { background:radial-gradient(circle,#22c55e,transparent); }
.mgr-stat-big.s2::before { background:radial-gradient(circle,#f97316,transparent); }
.mgr-stat-big.s3::before { background:radial-gradient(circle,#818cf8,transparent); }
.mgr-stat-big.s4::before { background:radial-gradient(circle,#f59e0b,transparent); }

.mgr-stat-big-icon {
  width:40px; height:40px; border-radius:13px;
  display:flex; align-items:center; justify-content:center;
  font-size:20px; margin-bottom:12px;
}
.mgr-stat-big.s1 .mgr-stat-big-icon { background:rgba(34,197,94,0.18); }
.mgr-stat-big.s2 .mgr-stat-big-icon { background:rgba(249,115,22,0.18); }
.mgr-stat-big.s3 .mgr-stat-big-icon { background:rgba(129,140,248,0.18); }
.mgr-stat-big.s4 .mgr-stat-big-icon { background:rgba(245,158,11,0.18); }

.mgr-stat-big-label { font-size:10px; color:rgba(255,255,255,0.45); font-weight:600; letter-spacing:0.4px; margin-bottom:4px; text-transform:uppercase; }
.mgr-stat-big-val { font-size:26px; font-weight:900; letter-spacing:-1px; }
.mgr-stat-big.s1 .mgr-stat-big-val { color:#4ade80; }
.mgr-stat-big.s2 .mgr-stat-big-val { color:var(--primary); }
.mgr-stat-big.s3 .mgr-stat-big-val { color:#a5b4fc; }
.mgr-stat-big.s4 .mgr-stat-big-val { color:#fbbf24; }

/* Recent Orders Feed */
.feed-title {
  font-size:12px; font-weight:800; color:var(--text2);
  text-transform:uppercase; letter-spacing:0.8px;
  display:flex; align-items:center; gap:8px;
  padding:4px 0 12px;
}
.feed-dot {
  width:7px; height:7px; border-radius:50%;
  background:#ef4444;
  box-shadow:0 0 0 3px rgba(239,68,68,0.2);
  animation:pulse 2s infinite;
}

/* Order Feed Card */
.feed-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:16px;
  padding:12px 14px;
  margin-bottom:8px;
  display:flex; align-items:center; gap:12px;
  position:relative; overflow:hidden;
}
.feed-card::before {
  content:''; position:absolute;
  top:0; right:0; bottom:0; width:3px;
}
.feed-card.cash::before { background:var(--success); }
.feed-card.visa::before { background:var(--visa); }
.feed-pay-icon {
  width:38px; height:38px; border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  font-size:18px; flex-shrink:0;
}
.feed-card.cash .feed-pay-icon { background:rgba(34,197,94,0.12); }
.feed-card.visa .feed-pay-icon { background:rgba(129,140,248,0.12); }
.feed-body { flex:1; min-width:0; }
.feed-rest { font-size:13px; font-weight:800; margin-bottom:2px; }
.feed-driver { font-size:11px; color:var(--text3); margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.feed-time { font-size:10px; color:var(--text3); }
.feed-amount { font-size:15px; font-weight:900; color:var(--primary); flex-shrink:0; }

/* Section headers */
.user-section-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 0 10px;
}
.user-section-label {
  font-size:11px; font-weight:800; color:var(--text3);
  text-transform:uppercase; letter-spacing:0.8px;
  display:flex; align-items:center; gap:6px;
}
.user-count-badge {
  background:var(--card); border:1px solid var(--card-border);
  border-radius:20px; padding:2px 8px;
  font-size:11px; font-weight:700; color:var(--text2);
}

/* User cards (drivers + managers) */
.user-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:18px;
  padding:14px 16px;
  margin-bottom:8px;
  display:flex; align-items:center; gap:14px;
  cursor:pointer;
  transition:all .15s;
  position:relative; overflow:hidden;
}
.user-card:active { transform:scale(0.98); border-color:var(--primary); }
.user-card.manager-card { border-color:rgba(129,140,248,0.25); background:linear-gradient(135deg,rgba(129,140,248,0.06),var(--card)); }

.user-avatar {
  width:48px; height:48px; border-radius:15px;
  display:flex; align-items:center; justify-content:center;
  font-size:20px; font-weight:900; flex-shrink:0;
  position:relative;
}
.user-card.driver-card .user-avatar { background:rgba(249,115,22,0.12); color:var(--primary); }
.user-card.manager-card .user-avatar { background:rgba(129,140,248,0.15); color:#a5b4fc; }

.user-status-dot {
  position:absolute; bottom:-1px; left:-1px;
  width:13px; height:13px; border-radius:50%;
  background:var(--bg3); border:2px solid var(--card);
}
.user-status-dot.online { background:var(--success); }

.user-info { flex:1; min-width:0; }
.user-name { font-size:14px; font-weight:800; margin-bottom:2px; }
.user-phone { font-size:11px; color:var(--text3); direction:ltr; margin-bottom:6px; }
.user-stats-row { display:flex; gap:5px; flex-wrap:wrap; }
.user-pill {
  padding:2px 8px; border-radius:20px;
  font-size:10px; font-weight:700;
}
.user-pill.orders { background:rgba(249,115,22,0.1); color:var(--primary); }
.user-pill.earn   { background:rgba(34,197,94,0.1);  color:var(--success); }
.user-pill.role   { background:rgba(129,140,248,0.12); color:#a5b4fc; }

/* Add user button */
.add-user-btn {
  display:flex; align-items:center; justify-content:center; gap:8px;
  width:100%; padding:14px;
  background:transparent;
  border:1.5px dashed rgba(249,115,22,0.35);
  border-radius:18px;
  color:var(--primary); font-size:13px; font-weight:700;
  font-family:'Cairo',sans-serif; cursor:pointer;
  transition:all .2s; margin-bottom:16px;
}
.add-user-btn:active { background:var(--primary-glow); border-style:solid; }

/* Restaurant cards - redesigned */
.rest-item {
  background:var(--card); border:1px solid var(--card-border);
  border-radius:16px; padding:14px 16px;
  display:flex; align-items:center; gap:12px;
  margin-bottom:8px;
}
.rest-item-icon {
  width:40px; height:40px; border-radius:12px;
  background:rgba(249,115,22,0.1);
  display:flex; align-items:center; justify-content:center;
  font-size:20px; flex-shrink:0;
}
.rest-item-name { flex:1; font-size:14px; font-weight:700; }
.rest-item-del {
  padding:6px 14px; border-radius:20px;
  background:rgba(239,68,68,0.1); color:var(--danger);
  border:1px solid rgba(239,68,68,0.2);
  font-size:11px; font-weight:700; font-family:'Cairo',sans-serif; cursor:pointer;
}
.mgr-stat-big {
  border-radius:18px; padding:16px 14px;
  position:relative; overflow:hidden;
  display:flex; flex-direction:column; gap:4px;
}
.mgr-stat-big.s1 { background:linear-gradient(135deg,rgba(34,197,94,0.18),rgba(34,197,94,0.06)); border:1.5px solid rgba(34,197,94,0.25); }
.mgr-stat-big.s2 { background:linear-gradient(135deg,rgba(249,115,22,0.18),rgba(249,115,22,0.06)); border:1.5px solid rgba(249,115,22,0.25); }
.mgr-stat-big.s3 { background:linear-gradient(135deg,rgba(129,140,248,0.18),rgba(129,140,248,0.06)); border:1.5px solid rgba(129,140,248,0.25); }
.mgr-stat-big.s4 { background:linear-gradient(135deg,rgba(245,158,11,0.18),rgba(245,158,11,0.06)); border:1.5px solid rgba(245,158,11,0.25); }
.mgr-stat-big-icon {
  width:38px; height:38px; border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  font-size:20px; margin-bottom:8px;
}
.mgr-stat-big.s1 .mgr-stat-big-icon { background:rgba(34,197,94,0.15); }
.mgr-stat-big.s2 .mgr-stat-big-icon { background:rgba(249,115,22,0.15); }
.mgr-stat-big.s3 .mgr-stat-big-icon { background:rgba(129,140,248,0.15); }
.mgr-stat-big.s4 .mgr-stat-big-icon { background:rgba(245,158,11,0.15); }
.mgr-stat-big-label { font-size:10px; color:rgba(255,255,255,0.5); font-weight:600; letter-spacing:0.3px; }
.mgr-stat-big-val { font-size:24px; font-weight:900; letter-spacing:-0.5px; }
.mgr-stat-big.s1 .mgr-stat-big-val { color:var(--success); }
.mgr-stat-big.s2 .mgr-stat-big-val { color:var(--primary); }
.mgr-stat-big.s3 .mgr-stat-big-val { color:var(--visa); }
.mgr-stat-big.s4 .mgr-stat-big-val { color:#f59e0b; }

/* Manager stats (kept for compatibility) */
.mgr-stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
.mgr-stat {
  background:var(--card); border:1px solid var(--card-border);
  border-radius:var(--radius-sm); padding:14px;
}
.mgr-stat-icon { font-size:22px; margin-bottom:6px; }
.mgr-stat-label { font-size:10px; color:var(--text2); margin-bottom:2px; }
.mgr-stat-val { font-size:20px; font-weight:900; color:var(--primary); }

/* ---- DRIVERS TAB ---- */
.search-bar {
  display:flex;
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:var(--radius-sm);
  overflow:hidden; margin-bottom:12px;
}
.search-bar input {
  flex:1; background:transparent; border:none; outline:none;
  padding:12px 16px; font-size:14px; color:var(--text);
  font-family:'Cairo',sans-serif;
}
.search-bar span { padding:0 14px; display:flex; align-items:center; font-size:18px; color:var(--text3); }

/* Driver card - premium redesign */
.driver-card {
  background:var(--card);
  border:1px solid var(--card-border);
  border-radius:18px;
  padding:14px 16px;
  margin-bottom:10px;
  display:flex; align-items:center; gap:14px;
  cursor:pointer;
  transition:all .2s;
  position:relative; overflow:hidden;
}
.driver-card::before {
  content:'';
  position:absolute; top:0; bottom:0; right:0; width:4px;
  border-radius:0 18px 18px 0;
  background:var(--bg3);
  transition:background .2s;
}
.driver-card.online-card { border-color:rgba(34,197,94,0.2); }
.driver-card.online-card::before { background:linear-gradient(180deg,var(--success),rgba(34,197,94,0.4)); }
.driver-card:active { transform:scale(0.98); border-color:var(--primary); }

.driver-avatar {
  width:52px; height:52px;
  border-radius:16px;
  display:flex; align-items:center; justify-content:center;
  font-size:22px; font-weight:900;
  flex-shrink:0; position:relative;
}
.driver-avatar.av-orange { background:rgba(249,115,22,0.12); color:var(--primary); }
.driver-avatar.av-green  { background:rgba(34,197,94,0.12);  color:var(--success); }
.driver-avatar.av-purple { background:rgba(129,140,248,0.12); color:var(--visa); }
.driver-avatar.av-amber  { background:rgba(245,158,11,0.12);  color:#f59e0b; }

.driver-online-badge {
  position:absolute; bottom:-1px; left:-1px;
  width:14px; height:14px; border-radius:50%;
  background:var(--bg3); border:2px solid var(--card);
  transition:background .2s;
}
.driver-online-badge.online { background:var(--success); }

.driver-info { flex:1; min-width:0; }
.driver-name { font-size:15px; font-weight:800; margin-bottom:1px; }
.driver-phone { font-size:11px; color:var(--text3); direction:ltr; margin-bottom:7px; }

.driver-stats-row { display:flex; gap:5px; flex-wrap:wrap; }
.driver-pill {
  padding:3px 9px; border-radius:20px;
  font-size:10px; font-weight:700; line-height:1.5;
}
.driver-pill.orders   { background:rgba(249,115,22,0.12); color:var(--primary); }
.driver-pill.delivery { background:rgba(34,197,94,0.12);  color:var(--success); }
.driver-pill.role-mgr { background:rgba(129,140,248,0.15); color:var(--visa); }

.driver-arrow { color:var(--text3); font-size:14px; flex-shrink:0; }

/* Add btn */
.add-btn {
  width:100%; padding:14px;
  background:transparent;
  border:2px dashed var(--card-border);
  border-radius:var(--radius-sm);
  color:var(--text2); font-size:14px; font-weight:600;
  font-family:'Cairo',sans-serif; cursor:pointer;
  display:flex; align-items:center; justify-content:center; gap:8px;
  margin-bottom:12px; transition:all .2s;
}
.add-btn:active { border-color:var(--primary); color:var(--primary); }

/* Recent orders - compact */
.mgr-order-card {
  background:var(--card); border:1px solid var(--card-border);
  border-radius:var(--radius-sm); padding:12px;
  margin-bottom:8px;
  display:flex; align-items:center; gap:10px;
}
.mgr-order-body { flex:1; min-width:0; }
.mgr-order-rest { font-size:14px; font-weight:700; }
.mgr-order-driver { font-size:11px; color:var(--text2); margin-top:2px; }
.mgr-order-time { font-size:10px; color:var(--text3); margin-top:2px; }
.mgr-order-amount { font-size:16px; font-weight:900; color:var(--success); flex-shrink:0; }

/* Restaurant */
.rest-card {
  background:var(--card); border:1px solid var(--card-border);
  border-radius:var(--radius-sm); padding:14px;
  margin-bottom:8px; display:flex; align-items:center; gap:12px;
}
.rest-name-big { flex:1; font-size:15px; font-weight:700; }
.rest-delete-btn {
  background:var(--danger-bg); color:var(--danger);
  border:none; border-radius:10px;
  padding:8px 14px; font-size:13px; font-weight:700;
  font-family:'Cairo',sans-serif; cursor:pointer;
}

/* Driver detail */
.driver-detail-overlay {
  position:fixed; inset:0; background:var(--bg);
  z-index:200; display:none; flex-direction:column; overflow:hidden;
}
.driver-detail-overlay.show { display:flex; }
.driver-detail-header {
  padding:16px; background:var(--card);
  border-bottom:1px solid var(--card-border);
  display:flex; align-items:center; gap:10px;
}
.back-btn {
  width:40px; height:40px; background:var(--bg3);
  border:none; border-radius:12px; font-size:20px;
  cursor:pointer; display:flex; align-items:center; justify-content:center; color:var(--text);
}
.driver-detail-content { flex:1; overflow-y:auto; padding:16px; }

/* Detail stats - redesigned */
.driver-detail-stats {
  display:grid; grid-template-columns:repeat(3,1fr);
  gap:8px; margin-bottom:16px;
}
.driver-detail-stat {
  background:var(--card); border:1px solid var(--card-border);
  border-radius:var(--radius-sm); padding:14px; text-align:center;
}
.dds-val { font-size:20px; font-weight:900; color:var(--primary); }
.dds-label { font-size:10px; color:var(--text2); margin-top:3px; }

/* Reports */
.date-filter { display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap; }
.date-btn {
  padding:7px 16px;
  background:var(--bg3); border:1px solid var(--card-border);
  border-radius:50px; font-size:12px; font-weight:700;
  font-family:'Cairo',sans-serif; cursor:pointer; color:var(--text2);
  transition:all .2s;
}
.date-btn.active { background:var(--primary); border-color:var(--primary); color:#fff; }

/* Report leaderboard style */
.report-row {
  background:var(--card); border:1px solid var(--card-border);
  border-radius:var(--radius-sm); padding:14px;
  margin-bottom:8px;
  display:flex; align-items:center; gap:12px;
  position:relative;
}
.report-rank {
  width:28px; height:28px;
  border-radius:50%;
  background:var(--bg3);
  display:flex; align-items:center; justify-content:center;
  font-size:12px; font-weight:900; color:var(--text2);
  flex-shrink:0;
}
.report-rank.gold { background:rgba(245,158,11,0.2); color:#f59e0b; }
.report-rank.silver { background:rgba(148,163,184,0.2); color:#94a3b8; }
.report-rank.bronze { background:rgba(180,120,60,0.2); color:#b47c3c; }
.report-driver-name { font-size:14px; font-weight:700; flex:1; }
.report-driver-orders { font-size:11px; color:var(--text3); margin-top:2px; }
.report-driver-income { font-size:18px; font-weight:900; color:var(--success); }

/* Scrollbar */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--bg3); border-radius:4px; }
</style>
</head>
<body>

<!-- ============================================================
     OFFLINE SCREEN
     ============================================================ -->
<div class="screen" id="offlineScreen">
  <div class="offline-icon">üì°</div>
  <div class="offline-title">ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™</div>
  <div class="offline-sub">ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸäÿπŸÖŸÑ ÿ£ŸàŸÜŸÑÿßŸäŸÜ ŸÅŸÇÿ∑ ŸÑÿ∂ŸÖÿßŸÜ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ŸÅŸä ÿßŸÑŸÉŸÑÿßŸàÿØ</div>
  <button class="offline-btn" onclick="checkOnline()">üîÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©</button>
</div>

<!-- ============================================================
     LOADING SCREEN
     ============================================================ -->
<div class="screen active" id="loadingScreen">
  <div class="loading-logo">üõµ</div>
  <div style="font-size:20px;font-weight:900;color:var(--primary);">Nabil Pro</div>
  <div class="loading-text">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
</div>

<!-- ============================================================
     AUTH SCREEN
     ============================================================ -->
<div class="screen" id="authScreen">
  <div class="auth-card">
    <div class="auth-logo">üõµ</div>
    <div class="auth-title">Nabil Pro</div>
    <div class="auth-sub">ÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ŸàÿµŸäŸÑ</div>

    <!-- Login -->
    <div class="auth-step active" id="authStep1">
      <div class="input-group">
        <div class="input-label">üì± ÿ±ŸÇŸÖ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ</div>
        <div class="input-row">
          <div class="input-prefix">üá™üá¨</div>
          <input type="tel" id="phoneInput" placeholder="01xxxxxxxxx" maxlength="11"
            oninput="this.value=this.value.replace(/\D/g,'')" inputmode="numeric">
        </div>
      </div>
      <div class="input-group">
        <div class="input-label">üîë ŸÉŸàÿØ ÿßŸÑÿØÿÆŸàŸÑ (6 ÿ£ÿ±ŸÇÿßŸÖ)</div>
        <input type="tel" class="otp-input" id="pinInput" placeholder="‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢"
          maxlength="6" inputmode="numeric" oninput="this.value=this.value.replace(/\D/g,'')">
      </div>
      <div style="font-size:12px;color:var(--text3);text-align:center;padding:4px 0;">
        ŸÉŸàÿØ ÿßŸÑÿØÿÆŸàŸÑ ÿ®Ÿäÿ¨ŸäŸÑŸÉ ŸÖŸÜ ÿßŸÑŸÖÿØŸäÿ±
      </div>
      <button class="auth-btn" id="loginBtn" onclick="doLogin()">
        üöÄ ÿØÿÆŸàŸÑ
      </button>
    </div>
  </div>
</div>

<!-- ============================================================
     DRIVER APP
     ============================================================ -->
<div class="screen" id="driverApp">
  <div class="header">
    <span class="header-logo">üõµ</span>
    <span class="header-title">Nabil Pro</span>
    <button class="icon-btn" onclick="toggleTheme()" id="themeBtn">üåô</button>
    <button class="icon-btn" onclick="confirmLogout()">üö™</button>
  </div>

  <div class="status-bar ok" id="driverStatus">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Firebase ŸÖÿ™ÿµŸÑ ‚Ä¢ 0 ÿ£Ÿàÿ±ÿØÿ±</span>
  </div>

  <div class="pages-wrapper" id="pagesWrapper">

    <!-- Page 0: Home -->
    <div class="page" id="homePage">
      <div class="welcome">
        <div class="welcome-greeting" id="greeting">ÿµÿ®ÿßÿ≠ ÿßŸÑÿÆŸäÿ± üëã</div>
        <div class="welcome-name" id="driverNameDisplay">ŸÖŸÜÿØŸàÿ®</div>
        <div class="welcome-time" id="clockDisplay">00:00 ÿµ</div>
      </div>

      <div class="stats-grid">
        <div class="stat-card c1">
          <div class="stat-icon">üì¶</div>
          <div class="stat-label">ÿ£Ÿàÿ±ÿØÿ±ÿßÿ™ ÿßŸÑŸäŸàŸÖ</div>
          <div class="stat-val" id="statOrders">0</div>
        </div>
        <div class="stat-card c2">
          <div class="stat-icon">üí∞</div>
          <div class="stat-label">ÿ£ÿ±ÿ®ÿßÿ≠ ÿßŸÑÿ™ŸàÿµŸäŸÑ</div>
          <div class="stat-val" id="statDelivery">ÿ¨ 0</div>
        </div>
        <div class="stat-card c3">
          <div class="stat-icon">üí≥</div>
          <div class="stat-label">ŸÅŸäÿ≤ÿß (ÿ£ŸÉÿ≥ÿ®)</div>
          <div class="stat-val" id="statVisa">ÿ¨ 0</div>
        </div>
        <div class="stat-card c4">
          <div class="stat-icon">üíµ</div>
          <div class="stat-label">ÿ™ÿ≠ÿµŸäŸÑ ŸÉÿßÿ¥</div>
          <div class="stat-val" id="statCash">ÿ¨ 0</div>
        </div>
      </div>

      <div class="section-title">üìä ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ¥ŸäŸÅÿ™</div>
      <div id="shiftReport"><div class="empty-state"><div class="empty-icon">üïê</div><div class="empty-text">ŸÑÿß ÿ£Ÿàÿ±ÿØÿ±ÿßÿ™ ÿßŸÑŸäŸàŸÖ ÿ®ÿπÿØ</div></div></div>
    </div>

    <!-- Page 1: Records -->
    <div class="page" id="recordsPage">
      <div class="filter-row" id="filterRow">
        <button class="filter-chip active" data-filter="all" onclick="setFilter(this,'all')">ÿßŸÑŸÉŸÑ</button>
        <button class="filter-chip" data-filter="today" onclick="setFilter(this,'today')">ÿßŸÑŸäŸàŸÖ</button>
        <button class="filter-chip" data-filter="week" onclick="setFilter(this,'week')">ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</button>
        <button class="filter-chip" data-filter="cash" onclick="setFilter(this,'cash')">ŸÉÿßÿ¥</button>
        <button class="filter-chip" data-filter="visa" onclick="setFilter(this,'visa')">ŸÅŸäÿ≤ÿß</button>
      </div>
      <div id="ordersList"><div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£Ÿàÿ±ÿØÿ±ÿßÿ™</div></div></div>
    </div>

    <!-- Page 2: Add Order -->
    <div class="page" id="addPage">
      <div class="form-section">
        <div class="form-label">üè™ ÿßŸÑŸÖÿ∑ÿπŸÖ</div>
        <div class="rest-chips" id="restChips"></div>
      </div>
      <div class="form-section">
        <div class="form-label">üìç ÿßŸÑÿπŸÜŸàÿßŸÜ</div>
        <div class="input-with-voice">
          <input class="form-input" id="addressInput" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ ŸÉÿßŸÖŸÑÿßŸã..." style="padding-left:52px;" maxlength="200">
          <button class="voice-btn" id="voiceAddress" onclick="startVoice('addressInput','voiceAddress')">üé§</button>
        </div>
      </div>
      <div class="form-section">
        <div class="form-label">üìû ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸäŸÑ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</div>
        <input class="form-input" id="phoneOrderInput" placeholder="01xxxxxxxxx" type="tel" inputmode="numeric">
      </div>
      <div class="form-section">
        <div class="form-label">üí∞ ŸÇŸäŸÖÿ© ÿßŸÑÿ£Ÿàÿ±ÿØÿ± (ŸÑŸÑŸÖÿ∑ÿπŸÖ)</div>
        <div class="input-with-voice">
          <input class="form-input" id="restAmountInput" type="number" placeholder="0" style="padding-left:52px;" inputmode="decimal">
          <button class="voice-btn" id="voiceAmount" onclick="startVoice('restAmountInput','voiceAmount')">üé§</button>
        </div>
      </div>
      <div class="form-section">
        <div class="form-label">üõµ ÿ™ŸàÿµŸäŸÑ</div>
        <input class="form-input" id="deliveryInput" type="number" placeholder="0" inputmode="decimal">
      </div>
      <div class="form-section">
        <div class="form-label">üí≥ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ</div>
        <div class="payment-row">
          <div class="pay-opt" id="payCash" onclick="selectPayment('cash')">
            <div class="pay-opt-icon">üíµ</div>
            <div class="pay-opt-label">ŸÉÿßÿ¥</div>
            <div class="pay-opt-note">ŸÖŸÜ ÿßŸÑÿπŸÖŸäŸÑ</div>
          </div>
          <div class="pay-opt" id="payVisa" onclick="selectPayment('visa')">
            <div class="pay-opt-icon">üí≥</div>
            <div class="pay-opt-label">ŸÅŸäÿ≤ÿß</div>
            <div class="pay-opt-note">ÿ£ŸÜÿ™ ÿ®ÿ™ŸÉÿ≥ÿ®</div>
          </div>
        </div>
      </div>
      <button class="submit-btn" onclick="addOrder()">‚úÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ£Ÿàÿ±ÿØÿ±</button>
    </div>

    <!-- Page 3: Settings -->
    <div class="page" id="settingsPage">
      <div class="section-title">‚öôÔ∏è ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</div>
      <div class="settings-card">
        <div class="settings-row" onclick="editDriverName()">
          <span class="settings-icon">üë§</span>
          <span class="settings-label">ÿßÿ≥ŸÖ ÿßŸÑÿ≥ÿßÿ¶ŸÇ</span>
          <span class="settings-val" id="settingsNameVal">‚Äî</span>
        </div>
        <div class="settings-row" onclick="cycleTheme()">
          <span class="settings-icon">üé®</span>
          <span class="settings-label">ÿßŸÑŸÖÿ∏Ÿáÿ±</span>
          <span class="settings-val" id="themeVal">ÿØÿßŸÉŸÜ</span>
        </div>
      </div>

      <div class="section-title">üè™ ÿßŸÑŸÖÿ∑ÿßÿπŸÖ</div>
      <div id="restSettingsList"></div>
      <button class="add-btn" onclick="addRestaurant()">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ∑ÿπŸÖ</button>

      <div class="section-title">üì± ŸÖÿπŸÑŸàŸÖÿßÿ™</div>
      <div class="settings-card">
        <div class="settings-row">
          <span class="settings-icon">üìû</span>
          <span class="settings-label">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</span>
          <span class="settings-val" id="settingsPhone" dir="ltr">‚Äî</span>
        </div>
        <div class="settings-row" onclick="confirmLogout()">
          <span class="settings-icon">üö™</span>
          <span class="settings-label" style="color:var(--danger)">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</span>
        </div>
      </div>
    </div>

  </div><!-- end pages-wrapper -->

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <button class="nav-item active" id="nav0" onclick="goPage(0)">
      <span class="nav-icon">üè†</span>
      <span>ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
    </button>
    <button class="nav-item" id="nav1" onclick="goPage(1)">
      <span class="nav-icon">üìã</span>
      <span>ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™</span>
    </button>
    <button class="nav-item" id="nav2" onclick="goPage(2)">
      <div class="nav-plus">Ôºã</div>
    </button>
    <button class="nav-item" id="nav3" onclick="goPage(3)">
      <span class="nav-icon">‚öôÔ∏è</span>
      <span>ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</span>
    </button>
  </div>
</div><!-- end driverApp -->

<!-- ============================================================
     MANAGER APP
     ============================================================ -->
<div class="screen" id="managerApp">
  <div class="mgr-header">
    <div style="flex:1;">
      <div style="font-size:10px;color:var(--text3);font-weight:600;letter-spacing:0.3px;" id="mgrHeroDate">ÿßŸÑŸäŸàŸÖ</div>
      <div class="mgr-header-title">ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ©</div>
    </div>
    <span class="mgr-badge" id="managerBadge">ŸÖÿØŸäÿ±</span>
    <button class="icon-btn" onclick="toggleTheme()" id="mgrThemeBtn">üîÜ</button>
    <button class="icon-btn" onclick="confirmLogout()" style="background:var(--danger-bg);color:var(--danger);">üö™</button>
  </div>

  <div class="mgr-content">

    <!-- Overview Tab -->
    <div class="mgr-tab-panel active" id="mgrPanel0">
      <div class="mgr-stats-big">
        <div class="mgr-stat-big s1">
          <div class="mgr-stat-big-icon">üë•</div>
          <div class="mgr-stat-big-label">ŸÖŸÜÿßÿØŸäÿ® ŸÜÿ¥ÿ∑ŸäŸÜ</div>
          <div class="mgr-stat-big-val" id="mgrStatDrivers">0</div>
        </div>
        <div class="mgr-stat-big s2">
          <div class="mgr-stat-big-icon">üì¶</div>
          <div class="mgr-stat-big-label">ÿ£Ÿàÿ±ÿØÿ±ÿßÿ™ ÿßŸÑŸäŸàŸÖ</div>
          <div class="mgr-stat-big-val" id="mgrStatOrders">0</div>
        </div>
        <div class="mgr-stat-big s3">
          <div class="mgr-stat-big-icon">üõµ</div>
          <div class="mgr-stat-big-label">ÿØÿÆŸÑ ÿßŸÑÿ™ŸàÿµŸäŸÑ</div>
          <div class="mgr-stat-big-val" id="mgrStatDelivery">ÿ¨ 0</div>
        </div>
        <div class="mgr-stat-big s4">
          <div class="mgr-stat-big-icon">üíµ</div>
          <div class="mgr-stat-big-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ŸÉÿßÿ¥</div>
          <div class="mgr-stat-big-val" id="mgrStatCash">ÿ¨ 0</div>
        </div>
      </div>
      <div class="feed-title"><span class="feed-dot"></span> ÿ¢ÿÆÿ± ÿßŸÑÿ£Ÿàÿ±ÿØÿ±ÿßÿ™</div>
      <div id="mgrRecentOrders"><div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">ŸÑÿß ÿ£Ÿàÿ±ÿØÿ±ÿßÿ™ ÿ®ÿπÿØ</div></div></div>
    </div>

    <!-- Drivers Tab -->
    <div class="mgr-tab-panel" id="mgrPanel1">
      <div class="search-bar" style="margin-bottom:12px;">
        <span>üîç</span>
        <input type="text" placeholder="ÿ®ÿ≠ÿ´ ÿ®ÿßÿ≥ŸÖ ÿ£Ÿà ÿ±ŸÇŸÖ..." id="driverSearch" oninput="filterDrivers()">
      </div>
      <div id="driversList"></div>
    </div>

    <!-- Restaurants Tab -->
    <div class="mgr-tab-panel" id="mgrPanel2">
      <button class="add-user-btn" onclick="showAddRestModal()">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ∑ÿπŸÖ ÿ¨ÿØŸäÿØ</button>
      <div id="mgrRestsList"></div>
    </div>

    <!-- Reports Tab -->
    <div class="mgr-tab-panel" id="mgrPanel3">
      <div class="date-filter">
        <button class="date-btn active" onclick="setReportPeriod('today',this)">ÿßŸÑŸäŸàŸÖ</button>
        <button class="date-btn" onclick="setReportPeriod('week',this)">ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</button>
        <button class="date-btn" onclick="setReportPeriod('month',this)">ÿßŸÑÿ¥Ÿáÿ±</button>
      </div>
      <div id="reportsContent"></div>
    </div>

  </div>

  <div class="mgr-tabs">
    <button class="mgr-tab active" onclick="mgrTab(0,this)">
      <span class="tab-icon">üìä</span>ÿπÿßŸÖÿ©
    </button>
    <button class="mgr-tab" onclick="mgrTab(1,this)">
      <span class="tab-icon">üë•</span>ÿßŸÑŸÅÿ±ŸäŸÇ
    </button>
    <button class="mgr-tab" onclick="mgrTab(2,this)">
      <span class="tab-icon">üè™</span>ŸÖÿ∑ÿßÿπŸÖ
    </button>
    <button class="mgr-tab" onclick="mgrTab(3,this)">
      <span class="tab-icon">üìà</span>ÿ™ŸÇÿßÿ±Ÿäÿ±
    </button>
  </div>
</div><!-- end managerApp -->

<!-- Driver Detail (Manager view) -->
<div class="driver-detail-overlay" id="driverDetailOverlay">
  <div class="driver-detail-header">
    <button class="back-btn" onclick="closeDriverDetail()">‚Üê</button>
    <div>
      <div style="font-size:17px;font-weight:900;" id="detailDriverName">‚Äî</div>
      <div style="font-size:12px;color:var(--text2);" id="detailDriverPhone" dir="ltr">‚Äî</div>
    </div>
    <div style="flex:1;"></div>
    <button class="icon-btn" style="background:rgba(249,115,22,0.1);color:var(--primary);" onclick="changeDriverPin()" title="ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÉŸàÿØ">üîë</button>
    <button class="icon-btn" style="background:rgba(129,140,248,0.1);color:#a5b4fc;margin:0 4px;" onclick="toggleDriverRole()" id="roleBtn">üëë</button>
    <button class="icon-btn" style="background:var(--danger-bg);color:var(--danger);" onclick="removeDriver()">üóë</button>
  </div>
  <div class="driver-detail-content">
    <div class="driver-detail-stats">
      <div class="driver-detail-stat">
        <div class="dds-val" id="detailOrders">0</div>
        <div class="dds-label">ÿ£Ÿàÿ±ÿØÿ±ÿßÿ™ ÿßŸÑŸäŸàŸÖ</div>
      </div>
      <div class="driver-detail-stat">
        <div class="dds-val" id="detailDelivery">0</div>
        <div class="dds-label">ÿØÿÆŸÑ ÿßŸÑÿ™ŸàÿµŸäŸÑ</div>
      </div>
      <div class="driver-detail-stat">
        <div class="dds-val" id="detailTotal">0</div>
        <div class="dds-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÉÿßÿ¥</div>
      </div>
    </div>
    <div class="section-title">üìã ÿ£Ÿàÿ±ÿØÿ±ÿßÿ™ ÿßŸÑŸäŸàŸÖ</div>
    <div id="detailOrdersList"></div>
  </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalBox">
    <div class="modal-title" id="modalTitle">ÿ™ÿ£ŸÉŸäÿØ</div>
    <div id="modalBody"></div>
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// SECURITY: Sanitize user input to prevent XSS
// ============================================================
function sanitize(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// ============================================================
// FIREBASE CONFIG
// ============================================================
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyAikfw9vS3PJQgaWl6SrpcOSG34B5vyXPc",
  authDomain:        "nabil-pro.firebaseapp.com",
  projectId:         "nabil-pro",
  storageBucket:     "nabil-pro.firebasestorage.app",
  messagingSenderId: "82099030853",
  appId:             "1:82099030853:web:89de9eabad2cc53817cc2c"
};

let auth, db;

// ============================================================
// STATE
// ============================================================
let currentUser   = null;
let userProfile   = null;
let ordersCache   = [];
let restaurantsCache = [];
let allDrivers    = [];
let allOrders     = [];
let currentFilter = 'all';
let selectedRest  = null;
let selectedPayment = null;
let currentPage   = 0;
let themeMode     = 'dark';
let recognizer    = null;
let editingOrderId = null;
let selectedDriverUid = null;
let reportPeriod  = 'today';
let ordersUnsubscribe = null;
let allOrdersUnsubscribe = null;

// Firestore refs (set after auth)
let ordersRef, restaurantsRef, usersRef, settingsRef;

// ============================================================
// NETWORK
// ============================================================
function checkOnline() {
  if (navigator.onLine) {
    showScreen('loadingScreen');
    initApp();
  } else {
    showScreen('offlineScreen');
  }
}
window.addEventListener('online', () => { if (!currentUser) checkOnline(); });
window.addEventListener('offline', () => {
  if (!currentUser) showScreen('offlineScreen');
});

// ============================================================
// SCREEN
// ============================================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  // Push state ÿπÿ¥ÿßŸÜ ÿ≤ÿ± ÿßŸÑÿ±ÿ¨Ÿàÿπ ÿπŸÑŸâ Android Ÿäÿ¥ÿ™ÿ∫ŸÑ
  const skip = ['loadingScreen', 'offlineScreen'];
  if (!skip.includes(id)) {
    history.pushState({ screen: id }, '', '');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ÿ≤ÿ± ÿßŸÑÿ±ÿ¨Ÿàÿπ ÿπŸÑŸâ Android
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('popstate', function() {
  // 1. Modal ŸÖŸÅÿ™Ÿàÿ≠ÿü
  const modal = document.getElementById('modalOverlay');
  if (modal && modal.classList.contains('show')) {
    closeModal();
    history.pushState({}, '', '');
    return;
  }
  // 2. Driver Detail ŸÖŸÅÿ™Ÿàÿ≠ÿü
  const detail = document.getElementById('driverDetailOverlay');
  if (detail && detail.classList.contains('show')) {
    closeDriverDetail();
    history.pushState({}, '', '');
    return;
  }
  // 3. ÿØÿßÿÆŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿü ‚Üí ÿßÿ≥ÿ£ŸÑ ÿπŸÜ ÿßŸÑÿÆÿ±Ÿàÿ¨
  const inApp = ['driverApp','managerApp'].some(id => {
    const el = document.getElementById(id);
    return el && el.classList.contains('active');
  });
  if (inApp) {
    history.pushState({}, '', '');
    confirmLogout();
    return;
  }
  // 4. ÿ£Ÿä ŸÖŸÉÿßŸÜ ÿ™ÿßŸÜŸä ‚Üí ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÑŸàÿ¨ŸäŸÜ
  history.pushState({}, '', '');
  showScreen('authScreen');
});

// State ÿßÿ®ÿ™ÿØÿßÿ¶Ÿä ÿπÿ¥ÿßŸÜ popstate Ÿäÿ¥ÿ™ÿ∫ŸÑ ŸÖŸÜ ÿ£ŸàŸÑ ŸÑÿ≠ÿ∏ÿ©
history.pushState({}, '', '');

// ============================================================
// INIT
// ============================================================
async function initApp() {
  if (!navigator.onLine) { showScreen('offlineScreen'); return; }
  showScreen('loadingScreen');

  // Init Firebase here so SDKs are guaranteed loaded
  if (!auth) {
    firebase.initializeApp(FIREBASE_CONFIG);
    auth = firebase.auth();
    db   = firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  }

  if (!window.authListenerSet) {
    auth.onAuthStateChanged(async user => {
      if (user) {
        currentUser = user;
        await loadUserProfile(user.uid);
      } else {
        showScreen('authScreen');
      }
    });
    window.authListenerSet = true;
  }
}

async function loadUserProfile(uid) {
  try {
    usersRef = db.collection('users');
    const doc = await usersRef.doc(uid).get();
    if (doc.exists) {
      userProfile = doc.data();
    } else {
      // New user - create as driver
      const email = currentUser.email || '';
      // Extract phone from email (format: 01xxx@nabilpro.app)
      const phone = email.replace('@nabilpro.app','');
      userProfile = {
        uid, phone, email, role: 'driver',
        name: 'ŸÖŸÜÿØŸàÿ® ÿØŸÑŸäŸÅÿ±Ÿä',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await usersRef.doc(uid).set(userProfile);
    }

    if (userProfile.role === 'manager') {
      initManagerApp();
    } else {
      initDriverApp();
    }
  } catch(e) {
    showToast('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
    showScreen('authScreen');
  }
}

// ============================================================
// EMAIL/PIN AUTH
// phone number ‚Üí email: 01012345678@nabilpro.app
// PIN (6 digits) ‚Üí password
// ============================================================
function phoneToEmail(phone) {
  // Normalize: always store with leading 0
  let p = phone.replace(/\D/g,'');
  if (!p.startsWith('0')) p = '0' + p;
  return p + '@nabilpro.app';
}

async function doLogin() {
  const phone = document.getElementById('phoneInput').value.trim();
  const pin   = document.getElementById('pinInput').value.trim();
  if (phone.length < 10) { showToast('ÿßÿØÿÆŸÑ ÿ±ŸÇŸÖ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ'); return; }
  if (pin.length !== 6)  { showToast('ŸÉŸàÿØ ÿßŸÑÿØÿÆŸàŸÑ 6 ÿ£ÿ±ŸÇÿßŸÖ'); return; }

  const btn = document.getElementById('loginBtn');
  btn.disabled = true;
  btn.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿØÿÆŸàŸÑ...';

  const email = phoneToEmail(phone);

  try {
    const result = await auth.signInWithEmailAndPassword(email, pin);
    currentUser = result.user;
    showScreen('loadingScreen');
    loadUserProfile(currentUser.uid);
  } catch(err) {
    btn.disabled = false;
    btn.innerHTML = 'üöÄ ÿØÿÆŸàŸÑ';
    if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password') {
      showToast('‚ùå ÿ±ŸÇŸÖ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ ÿ£Ÿà ÿßŸÑŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');
    } else {
      showToast('ÿÆÿ∑ÿ£: ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ');
    }
  }
}

function confirmLogout() {
  showModal('ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨', '<p style="color:var(--text2);font-size:14px;">ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü</p>',
    [{ label: 'ÿÆÿ±Ÿàÿ¨', cls: 'danger', action: doLogout },
     { label: 'ÿ•ŸÑÿ∫ÿßÿ°', cls: 'cancel', action: closeModal }]);
}

async function doLogout() {
  closeModal();

  if (ordersUnsubscribe) { ordersUnsubscribe(); ordersUnsubscribe = null; }
  if (allOrdersUnsubscribe) { allOrdersUnsubscribe(); allOrdersUnsubscribe = null; }

  try { await auth.signOut(); } catch(e) {}

  // ÿ™ŸÜÿ∏ŸäŸÅ ŸÉÿßŸÖŸÑ ŸÑŸÑÿ≠ÿßŸÑÿ©
  currentUser = null;
  userProfile = null;
  ordersCache = [];
  restaurantsCache = [];
  allDrivers = [];
  allOrders = [];
  selectedRest = null;
  selectedPayment = null;
  editingOrderId = null;
  selectedDriverUid = null;
  window.authListenerSet = false;

  // ÿ™ŸÜÿ∏ŸäŸÅ ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿØÿÆŸàŸÑ
  const ph = document.getElementById('phoneInput');
  const pin = document.getElementById('pinInput');
  if (ph) ph.value = '';
  if (pin) pin.value = '';

  // Reload ÿßŸÑÿµŸÅÿ≠ÿ© ÿπÿ¥ÿßŸÜ ŸÜÿ∂ŸÖŸÜ ÿ™ŸÜÿ∏ŸäŸÅ ŸÉÿßŸÖŸÑ
  window.location.reload();
}

// ============================================================
// DRIVER APP INIT
// ============================================================
function initDriverApp() {
  const uid = currentUser.uid;
  ordersRef = db.collection('orders');
  restaurantsRef = db.collection('restaurants');
  settingsRef = db.collection('users').doc(uid);

  // Update last seen
  db.collection('users').doc(uid).update({
    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
    online: true
  }).catch(() => {});

  // Apply saved theme
  themeMode = userProfile.themeMode || 'auto';
  applyTheme(themeMode);

  // Set name in UI
  const name = userProfile.name || 'ŸÖŸÜÿØŸàÿ® ÿØŸÑŸäŸÅÿ±Ÿä';
  document.getElementById('driverNameDisplay').textContent = name;
  document.getElementById('settingsNameVal').textContent = name;
  document.getElementById('settingsPhone').textContent = userProfile.phone || '‚Äî';

  updateClock();
  setInterval(updateClock, 30000);

  loadRestaurantsDriver();
  listenToDriverOrders();
  showScreen('driverApp');
}

// ============================================================
// DRIVER: RESTAURANTS
// ============================================================
async function loadRestaurantsDriver() {
  const snap = await restaurantsRef.orderBy('name').get();
  restaurantsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderRestChips();
  renderRestSettings();
}

function renderRestChips() {
  const active = restaurantsCache.filter(r => r.active !== false);
  const html = active.map(r =>
    `<button class="rest-chip ${selectedRest === r.id ? 'active' : ''}" onclick="selectRest('${r.id}')">${sanitize(r.name)}</button>`
  ).join('');
  document.getElementById('restChips').innerHTML = html + `<button class="rest-chip add-chip" onclick="addRestaurantFromOrder()">Ôºã ÿ¨ÿØŸäÿØ</button>`;
}

function selectRest(id) {
  selectedRest = selectedRest === id ? null : id;
  renderRestChips();
}

function renderRestSettings() {
  const el = document.getElementById('restSettingsList');
  if (!restaurantsCache.length) { el.innerHTML = '<div class="empty-state"><div class="empty-text">ŸÑÿß ŸÖÿ∑ÿßÿπŸÖ ÿ®ÿπÿØ</div></div>'; return; }
  el.innerHTML = restaurantsCache.map(r => `
    <div class="rest-card">
      <span style="font-size:20px;">üè™</span>
      <span class="rest-name-big">${sanitize(r.name)}</span>
      <button class="rest-delete-btn" onclick="deleteRestaurant('${sanitize(r.id)}','${sanitize(r.name)}')">ÿ≠ÿ∞ŸÅ</button>
    </div>`).join('');
}

async function addRestaurant() {
  const name = prompt('ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ∑ÿπŸÖ ÿßŸÑÿ¨ÿØŸäÿØ:');
  if (!name) return;
  await restaurantsRef.add({ name: name.trim(), active: true, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  showToast('‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ' + name);
  loadRestaurantsDriver();
}

async function addRestaurantFromOrder() {
  const name = prompt('ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ∑ÿπŸÖ:');
  if (!name) return;
  const docRef = await restaurantsRef.add({ name: name.trim(), active: true, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  await loadRestaurantsDriver();
  selectedRest = docRef.id;
  renderRestChips();
}

async function deleteRestaurant(id, name) {
  // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ£Ÿàÿ±ÿØÿ±ÿßÿ™ ŸÑŸÑŸÖÿ∑ÿπŸÖ
  const ordersSnap = await ordersRef.where('restId','==',id).limit(1).get();
  if (!ordersSnap.empty) {
    showModal('ÿ™ŸÜÿ®ŸäŸá', `<p style="color:var(--text2);font-size:14px;">ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ "${sanitize(name)}" ŸÑÿ£ŸÜ ŸÑÿØŸäŸá ÿ£Ÿàÿ±ÿØÿ±ÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ©.</p>`,
      [{ label: 'ÿ≠ÿ≥ŸÜÿßŸã', cls: 'cancel', action: closeModal }]);
    return;
  }
  showModal('ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ∑ÿπŸÖ', `<p style="color:var(--text2);font-size:14px;">ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ "${sanitize(name)}"ÿü</p>`,
    [{ label: 'ÿ≠ÿ∞ŸÅ', cls: 'danger', action: async () => {
        await restaurantsRef.doc(id).delete();
        if (selectedRest === id) selectedRest = null;
        closeModal();
        showToast('ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ');
        loadRestaurantsDriver();
    }},
    { label: 'ÿ•ŸÑÿ∫ÿßÿ°', cls: 'cancel', action: closeModal }]);
}

// ============================================================
// DRIVER: ORDERS
// ============================================================
function listenToDriverOrders() {
  if (ordersUnsubscribe) ordersUnsubscribe();
  ordersUnsubscribe = ordersRef
    .where('driverId', '==', currentUser.uid)
    .orderBy('timestamp', 'desc')
    .onSnapshot(snap => {
      ordersCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      updateDriverStats();
      renderShiftReport();
      renderOrdersList();
      updateStatusBar();
    }, err => {
      document.getElementById('driverStatus').className = 'status-bar err';
      document.getElementById('statusDot').className = 'status-dot error';
      document.getElementById('statusText').textContent = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©';
    });
}

function getTodayOrders() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  return ordersCache.filter(o => {
    if (!o.timestamp) return false;
    const t = o.timestamp.toDate ? o.timestamp.toDate() : new Date(o.timestamp);
    return t >= start;
  });
}

function updateDriverStats() {
  const today = getTodayOrders();
  const totalDelivery = today.reduce((s,o) => s + (o.delivery || 0), 0);
  const visaOrders = today.filter(o => o.payment === 'visa');
  const totalVisa = visaOrders.reduce((s,o) => s + (o.total || 0), 0);
  const cashOrders = today.filter(o => o.payment === 'cash');
  const totalCash = cashOrders.reduce((s,o) => s + (o.total || 0), 0);

  document.getElementById('statOrders').textContent = today.length;
  document.getElementById('statDelivery').textContent = 'ÿ¨ ' + totalDelivery;
  document.getElementById('statVisa').textContent = 'ÿ¨ ' + totalVisa;
  document.getElementById('statCash').textContent = 'ÿ¨ ' + totalCash;
}

function updateStatusBar() {
  const today = getTodayOrders();
  document.getElementById('driverStatus').className = 'status-bar ok';
  document.getElementById('statusDot').className = 'status-dot';
  document.getElementById('statusText').textContent = `Firebase üî• ŸÖÿ™ÿµŸÑ ‚Ä¢ ${today.length} ÿ£Ÿàÿ±ÿØÿ± ÿßŸÑŸäŸàŸÖ`;
}

function renderShiftReport() {
  const today = getTodayOrders();
  if (!today.length) {
    document.getElementById('shiftReport').innerHTML = '<div class="empty-state"><div class="empty-icon">üïê</div><div class="empty-text">ŸÑÿß ÿ£Ÿàÿ±ÿØÿ±ÿßÿ™ ÿßŸÑŸäŸàŸÖ ÿ®ÿπÿØ</div></div>';
    return;
  }
  const byRest = {};
  today.forEach(o => {
    if (!byRest[o.restName]) byRest[o.restName] = { orders:0, delivery:0, cash:0, visa:0 };
    byRest[o.restName].orders++;
    byRest[o.restName].delivery += o.delivery || 0;
    if (o.payment === 'cash') byRest[o.restName].cash += o.total || 0;
    if (o.payment === 'visa') byRest[o.restName].visa += o.total || 0;
  });
  document.getElementById('shiftReport').innerHTML = Object.entries(byRest).map(([name, d]) => `
    <div class="report-card">
      <div class="report-header" onclick="this.nextElementSibling.classList.toggle('open')">
        <div>
          <div class="report-rest">${name}</div>
          <div class="report-count">${d.orders} ÿ£Ÿàÿ±ÿØÿ±</div>
        </div>
        <div class="report-delivery">ÿ¨ ${d.delivery}</div>
      </div>
      <div class="report-body">
        <div class="report-detail"><span>ŸÉÿßÿ¥</span><span>ÿ¨ ${d.cash}</span></div>
        <div class="report-detail"><span>ŸÅŸäÿ≤ÿß</span><span>ÿ¨ ${d.visa}</span></div>
        <div class="report-detail"><span>ÿ™ŸàÿµŸäŸÑ</span><span>ÿ¨ ${d.delivery}</span></div>
      </div>
    </div>`).join('');
}

function renderOrdersList() {
  const now = new Date();
  const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const weekStart = new Date(now); weekStart.setDate(now.getDate() - 7);

  let list = [...ordersCache];
  if (currentFilter === 'today') list = list.filter(o => {
    const t = o.timestamp?.toDate?.() || new Date(o.timestamp);
    return t >= todayStart;
  });
  else if (currentFilter === 'week') list = list.filter(o => {
    const t = o.timestamp?.toDate?.() || new Date(o.timestamp);
    return t >= weekStart;
  });
  else if (currentFilter === 'cash') list = list.filter(o => o.payment === 'cash');
  else if (currentFilter === 'visa') list = list.filter(o => o.payment === 'visa');

  if (!list.length) {
    document.getElementById('ordersList').innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£Ÿàÿ±ÿØÿ±ÿßÿ™</div></div>';
    return;
  }
  document.getElementById('ordersList').innerHTML = list.map(o => {
    const t = o.timestamp?.toDate?.() || (o.timestamp ? new Date(o.timestamp) : new Date());
    const timeStr = t.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
    const dateStr = t.toLocaleDateString('ar-EG', {day:'2-digit', month:'2-digit'});
    return `<div class="order-card ${o.payment || 'cash'}">
      <div class="order-head">
        <span class="order-rest">${sanitize(o.restName || '‚Äî')}</span>
        <span class="order-time">${dateStr} ${timeStr}</span>
      </div>
      <div class="order-body">
        <div class="order-details">
          ${o.address ? 'üìç ' + sanitize(o.address) + '<br>' : ''}
          ${o.phone ? 'üìû ' + o.phone + '<br>' : ''}
          üí≥ ${o.payment === 'visa' ? 'ŸÅŸäÿ≤ÿß' : 'ŸÉÿßÿ¥'}
        </div>
        <div class="order-amount">
          <div class="order-delivery">ÿ¨ ${o.delivery || 0}</div>
          <div class="order-total">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ¨ ${o.total || 0}</div>
        </div>
      </div>
      <div class="order-actions">
        <button class="action-btn edit" onclick="editOrder('${o.id}')">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ</button>
        <button class="action-btn delete" onclick="deleteOrder('${o.id}')">üóë ÿ≠ÿ∞ŸÅ</button>
      </div>
    </div>`;
  }).join('');
}

function setFilter(el, filter) {
  currentFilter = filter;
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderOrdersList();
}

// ============================================================
// ADD ORDER
// ============================================================
function selectPayment(type) {
  selectedPayment = type;
  document.getElementById('payCash').className = 'pay-opt' + (type === 'cash' ? ' active-cash' : '');
  document.getElementById('payVisa').className = 'pay-opt' + (type === 'visa' ? ' active-visa' : '');
}

async function addOrder() {
  if (!selectedRest) { showToast('ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ∑ÿπŸÖ ÿ£ŸàŸÑÿßŸã'); return; }
  const submitBtn = document.querySelector('.submit-btn');
  if (submitBtn) { submitBtn.disabled = true; submitBtn.innerHTML = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...'; }
  const address  = document.getElementById('addressInput').value.trim();
  const phone    = document.getElementById('phoneOrderInput').value.trim();
  const restAmt  = parseFloat(document.getElementById('restAmountInput').value) || 0;
  const delivery = parseFloat(document.getElementById('deliveryInput').value) || 0;
  if (!address)   { showToast('ÿßÿØÿÆŸÑ ÿßŸÑÿπŸÜŸàÿßŸÜ'); return; }
  if (!selectedPayment) { showToast('ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ'); return; }
  if (restAmt < 0) { showToast('ŸÇŸäŸÖÿ© ÿßŸÑÿ£Ÿàÿ±ÿØÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©'); return; }
  if (delivery < 0) { showToast('ŸÇŸäŸÖÿ© ÿßŸÑÿ™ŸàÿµŸäŸÑ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©'); return; }

  const rest = restaurantsCache.find(r => r.id === selectedRest);
  const total = restAmt + delivery;

  const orderData = {
    driverId: currentUser.uid,
    driverName: userProfile.name || 'ŸÖŸÜÿØŸàÿ®',
    restId: selectedRest,
    restName: rest?.name || '‚Äî',
    restAmount: restAmt,
    delivery,
    total,
    payment: selectedPayment,
    address,
    phone,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  if (editingOrderId) {
    await ordersRef.doc(editingOrderId).update(orderData);
    editingOrderId = null;
    showToast('‚úÖ ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ£Ÿàÿ±ÿØÿ±');
  } else {
    await ordersRef.add(orderData);
    showToast('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ£Ÿàÿ±ÿØÿ±');
    // ÿ•ÿ¥ÿπÿßÿ± ŸÅŸàÿ±Ÿä ŸÑŸÉŸÑ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© (ÿßŸÑŸÖÿØŸäÿ± + ÿßŸÑŸÖŸÜÿßÿØŸäÿ®)
    sendPushNotification(
      'ÿ£Ÿàÿ±ÿØÿ± ÿ¨ÿØŸäÿØ üõµ',
      `${orderData.driverName} ‚Äî ${orderData.restName}\nüìç ${orderData.address}\nÿ¨ ${orderData.delivery} ÿ™ŸàÿµŸäŸÑ`,
      'new-order'
    );
  }

  if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = '‚úÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ£Ÿàÿ±ÿØÿ±'; }
  // Reset form
  document.getElementById('addressInput').value = '';
  document.getElementById('phoneOrderInput').value = '';
  document.getElementById('restAmountInput').value = '';
  document.getElementById('deliveryInput').value = '';
  selectedRest = null;
  selectedPayment = null;
  renderRestChips();
  document.getElementById('payCash').className = 'pay-opt';
  document.getElementById('payVisa').className = 'pay-opt';
  goPage(0);
}

async function editOrder(id) {
  const o = ordersCache.find(x => x.id === id);
  if (!o) return;
  editingOrderId = id;
  selectedRest = o.restId;
  selectedPayment = o.payment;
  document.getElementById('addressInput').value = o.address || '';
  document.getElementById('phoneOrderInput').value = o.phone || '';
  document.getElementById('restAmountInput').value = o.restAmount || '';
  document.getElementById('deliveryInput').value = o.delivery || '';
  renderRestChips();
  selectPayment(o.payment);
  goPage(2);
  showToast('üìù ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿπÿØŸäŸÑ...');
}

async function deleteOrder(id) {
  showModal('ÿ≠ÿ∞ŸÅ ÿßŸÑÿ£Ÿàÿ±ÿØÿ±', '<p style="color:var(--text2);font-size:14px;">ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ£Ÿàÿ±ÿØÿ± ŸÜŸáÿßÿ¶ŸäÿßŸãÿü</p>',
    [{ label: 'ÿ≠ÿ∞ŸÅ', cls: 'danger', action: async () => {
        await ordersRef.doc(id).delete();
        closeModal(); showToast('üóë ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ');
    }},
    { label: 'ÿ•ŸÑÿ∫ÿßÿ°', cls: 'cancel', action: closeModal }]);
}

// ============================================================
// NAVIGATION
// ============================================================
function goPage(n) {
  currentPage = n;
  document.getElementById('pagesWrapper').style.transform = `translateX(${n * 25}%)`;
  document.querySelectorAll('.nav-item').forEach((el, i) => el.classList.toggle('active', i === n));
}

// ============================================================
// SETTINGS
// ============================================================
function editDriverName() {
  showModal('ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿßÿ≥ŸÖ', `<input class="form-input" id="newNameInput" value="${userProfile.name || ''}" placeholder="ÿßÿ≥ŸÖŸÉ...">`,
    [{ label: 'ÿ≠ŸÅÿ∏', cls: 'confirm', action: async () => {
        const name = document.getElementById('newNameInput').value.trim() || 'ŸÖŸÜÿØŸàÿ® ÿØŸÑŸäŸÅÿ±Ÿä';
        userProfile.name = name;
        await db.collection('users').doc(currentUser.uid).update({ name });
        document.getElementById('driverNameDisplay').textContent = name;
        document.getElementById('settingsNameVal').textContent = name;
        closeModal(); showToast('‚úÖ ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿßÿ≥ŸÖ');
    }},
    { label: 'ÿ•ŸÑÿ∫ÿßÿ°', cls: 'cancel', action: closeModal }]);
}

function cycleTheme() {
  // ÿØŸàÿ±ÿ©: dark ‚Üí light ‚Üí auto ‚Üí dark
  if (themeMode === 'dark') themeMode = 'light';
  else if (themeMode === 'light') themeMode = 'auto';
  else themeMode = 'dark';
  applyTheme(themeMode);
  db.collection('users').doc(currentUser.uid).update({ themeMode });
}

function toggleTheme() { cycleTheme(); }

function applyTheme(mode) {
  // 'auto' = ÿ≠ÿ≥ÿ® ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ
  let resolved = mode;
  if (mode === 'auto' || !mode) {
    resolved = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
  }
  document.body.dataset.theme = resolved === 'light' ? 'light' : '';
  document.getElementById('themeVal') && (document.getElementById('themeVal').textContent =
    mode === 'auto' ? 'ÿ™ŸÑŸÇÿßÿ¶Ÿä' : resolved === 'light' ? 'ŸÅÿßÿ™ÿ≠' : 'ÿØÿßŸÉŸÜ');
  const btn = document.getElementById('themeBtn');
  const mgrBtn = document.getElementById('mgrThemeBtn');
  const icon = mode === 'auto' ? 'üîÜ' : resolved === 'light' ? 'üåô' : '‚òÄÔ∏è';
  if (btn) btn.textContent = icon;
  if (mgrBtn) mgrBtn.textContent = icon;
}

// Listen for OS theme change
window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', () => {
  if (themeMode === 'auto' || !themeMode) applyTheme('auto');
});

// ============================================================
// CLOCK
// ============================================================
function updateClock() {
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes();
  const isAM = h < 12;
  const h12 = h % 12 || 12;
  const mStr = String(m).padStart(2, '0');
  document.getElementById('clockDisplay').textContent = `${h12}:${mStr} ${isAM ? 'ÿµ' : 'ŸÖ'}`;
  const g = document.getElementById('greeting');
  if (h < 12) g.textContent = 'ÿµÿ®ÿßÿ≠ ÿßŸÑÿÆŸäÿ± üëã';
  else if (h < 17) g.textContent = 'ŸÖÿ≥ÿßÿ° ÿßŸÑŸÜŸàÿ± üí™';
  else g.textContent = 'ÿßŸÑŸÜŸáÿßÿ±ÿØŸá ÿ¥ÿ∫ÿßŸÑ üî•';
}

// ============================================================
// VOICE INPUT
// ============================================================
function startVoice(inputId, btnId) {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    showToast('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑÿµŸàÿ™'); return;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (recognizer) { recognizer.stop(); recognizer = null; document.getElementById(btnId).classList.remove('active'); return; }
  recognizer = new SR();
  recognizer.lang = 'ar-EG';
  recognizer.interimResults = false;
  document.getElementById(btnId).classList.add('active');
  recognizer.onresult = e => { document.getElementById(inputId).value = e.results[0][0].transcript; };
  recognizer.onend = () => { document.getElementById(btnId).classList.remove('active'); recognizer = null; };
  recognizer.start();
}

// ============================================================
// MANAGER APP
// ============================================================
function initManagerApp() {
  themeMode = userProfile.themeMode || 'auto';
  applyTheme(themeMode);
  document.getElementById('managerBadge').textContent = userProfile.name || 'ŸÖÿØŸäÿ±';
  // ÿßÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
  setTimeout(() => {
    if (Notification.permission === 'default') {
      Notification.requestPermission().then(p => {
        if (p === 'granted') {
          showToast('üîî ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
          subscribeFCM();
        }
      });
    } else if (Notification.permission === 'granted') {
      subscribeFCM();
    }
  }, 2000);
  // Set date in header
  const now = new Date();
  const days = ['ÿßŸÑÿ£ÿ≠ÿØ','ÿßŸÑÿßÿ´ŸÜŸäŸÜ','ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°','ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°','ÿßŸÑÿÆŸÖŸäÿ≥','ÿßŸÑÿ¨ŸÖÿπÿ©','ÿßŸÑÿ≥ÿ®ÿ™'];
  const months = ['ŸäŸÜÿßŸäÿ±','ŸÅÿ®ÿ±ÿßŸäÿ±','ŸÖÿßÿ±ÿ≥','ÿ•ÿ®ÿ±ŸäŸÑ','ŸÖÿßŸäŸà','ŸäŸàŸÜŸäŸà','ŸäŸàŸÑŸäŸà','ÿ£ÿ∫ÿ≥ÿ∑ÿ≥','ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±','ÿ£ŸÉÿ™Ÿàÿ®ÿ±','ŸÜŸàŸÅŸÖÿ®ÿ±','ÿØŸäÿ≥ŸÖÿ®ÿ±'];
  document.getElementById('mgrHeroDate').textContent =
    days[now.getDay()] + 'ÿå ' + now.getDate() + ' ' + months[now.getMonth()];
  showScreen('managerApp');
  listenAllOrders();
  loadAllDrivers();
  loadMgrRestaurants();
}

function listenAllOrders() {
  if (allOrdersUnsubscribe) allOrdersUnsubscribe();
  const todayStart = new Date();
  todayStart.setHours(0,0,0,0);

  allOrdersUnsubscribe = db.collection('orders')
    .orderBy('timestamp', 'desc')
    .onSnapshot(snap => {
      allOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      updateMgrOverview();
      renderMgrRecentOrders();
      renderMgrReports();
    }, () => {});
}

function updateMgrOverview() {
  const todayStart = new Date();
  todayStart.setHours(0,0,0,0);
  const today = allOrders.filter(o => {
    if (!o.timestamp) return false;
    const t = o.timestamp.toDate ? o.timestamp.toDate() : new Date(o.timestamp);
    return t >= todayStart;
  });
  const driverIds = [...new Set(today.map(o => o.driverId))];
  const totalDelivery = today.reduce((s,o) => s + (o.delivery||0), 0);
  const totalCash = today.filter(o => o.payment === 'cash').reduce((s,o) => s + (o.total||0), 0);

  document.getElementById('mgrStatDrivers').textContent = driverIds.length;
  document.getElementById('mgrStatOrders').textContent = today.length;
  document.getElementById('mgrStatDelivery').textContent = 'ÿ¨ ' + totalDelivery;
  document.getElementById('mgrStatCash').textContent = 'ÿ¨ ' + totalCash;
}

function renderMgrRecentOrders() {
  const recent = allOrders.slice(0, 20);
  if (!recent.length) {
    document.getElementById('mgrRecentOrders').innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">ŸÑÿß ÿ£Ÿàÿ±ÿØÿ±ÿßÿ™ ÿ®ÿπÿØ</div></div>';
    return;
  }
  document.getElementById('mgrRecentOrders').innerHTML = recent.map(o => {
    const t = o.timestamp?.toDate?.() || new Date();
    const timeStr = t.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
    const isVisa = o.payment === 'visa';
    return `<div class="feed-card ${isVisa ? 'visa' : 'cash'}">
      <div class="feed-pay-icon">${isVisa ? 'üí≥' : 'üíµ'}</div>
      <div class="feed-body">
        <div class="feed-rest">${sanitize(o.restName || '‚Äî')}</div>
        <div class="feed-driver">üë§ ${sanitize(o.driverName || '‚Äî')}  ‚Ä¢  üìç ${sanitize(o.address || '‚Äî')}</div>
        <div class="feed-time">‚è∞ ${timeStr}</div>
      </div>
      <div class="feed-amount">ÿ¨ ${o.delivery || 0}</div>
    </div>`;
  }).join('');
}


// ============================================================
// MANAGER: DRIVERS
// ============================================================
async function loadAllDrivers() {
  // Load both drivers AND managers
  const snap = await db.collection('users').get();
  allDrivers = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
  renderDriversList();
}


function renderDriversList(filter = '') {
  const managers = allDrivers.filter(d => d.role === 'manager');
  const drivers  = allDrivers.filter(d => d.role !== 'manager');

  let mgrsToShow = managers;
  let drvsToShow = drivers;

  if (filter) {
    const q = filter.toLowerCase();
    mgrsToShow = managers.filter(d => (d.name||'').includes(q) || (d.phone||'').includes(q));
    drvsToShow  = drivers.filter(d =>  (d.name||'').includes(q) || (d.phone||'').includes(q));
  }

  const todayStart = new Date(); todayStart.setHours(0,0,0,0);

  function buildCard(d, isManager) {
    const driverOrders = allOrders.filter(o => o.driverId === d.uid);
    const todayOrders  = driverOrders.filter(o => {
      if (!o.timestamp) return false;
      const t = o.timestamp.toDate ? o.timestamp.toDate() : new Date(o.timestamp);
      return t >= todayStart;
    });
    const todayDelivery = todayOrders.reduce((s,o) => s + (o.delivery||0), 0);
    const initials = (d.name||'ŸÖ').charAt(0);
    const isOnline = d.lastSeen && ((Date.now() - (d.lastSeen.toDate ? d.lastSeen.toDate() : new Date(d.lastSeen)).getTime()) < 300000);
    const cardCls = isManager ? 'manager-card' : 'driver-card';

    return `<div class="user-card ${cardCls}" onclick="showDriverDetail('${d.uid}')">
      <div class="user-avatar">
        ${initials}
        <div class="user-status-dot ${isOnline ? 'online' : ''}"></div>
      </div>
      <div class="user-info">
        <div class="user-name">${sanitize(d.name || 'ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ')}</div>
        <div class="user-phone">${sanitize(d.phone || '‚Äî')}</div>
        <div class="user-stats-row">
          ${!isManager ? `<span class="user-pill orders">üì¶ ${todayOrders.length} ÿ£Ÿàÿ±ÿØÿ±</span>
          <span class="user-pill earn">ÿ¨ ${todayDelivery}</span>` : ''}
          ${isManager ? '<span class="user-pill role">üëë ŸÖÿØŸäÿ±</span>' : ''}
        </div>
      </div>
      <span style="color:var(--text3);font-size:14px;">‚Äπ</span>
    </div>`;
  }

  let html = '';

  // Managers section
  if (mgrsToShow.length) {
    html += `<div class="user-section-header">
      <span class="user-section-label">üëë ÿßŸÑŸÖÿØŸäÿ±ŸäŸÜ <span class="user-count-badge">${mgrsToShow.length}</span></span>
      <button class="add-user-btn" style="width:auto;padding:6px 14px;font-size:11px;margin:0;" onclick="showAddUserModal('manager')">+ ŸÖÿØŸäÿ±</button>
    </div>`;
    html += mgrsToShow.map(d => buildCard(d, true)).join('');
  }

  // Drivers section
  html += `<div class="user-section-header">
    <span class="user-section-label">üõµ ÿßŸÑŸÖŸÜÿßÿØŸäÿ® <span class="user-count-badge">${drvsToShow.length}</span></span>
    <button class="add-user-btn" style="width:auto;padding:6px 14px;font-size:11px;margin:0;" onclick="showAddUserModal('driver')">+ ŸÖŸÜÿØŸàÿ®</button>
  </div>`;

  if (drvsToShow.length) {
    html += drvsToShow.map(d => buildCard(d, false)).join('');
  } else {
    html += '<div class="empty-state" style="padding:20px 0;"><div class="empty-text">ŸÑÿß ŸÖŸÜÿßÿØŸäÿ® ÿ®ÿπÿØ</div></div>';
  }

  document.getElementById('driversList').innerHTML = html;
}


function filterDrivers() {
  const q = document.getElementById('driverSearch').value.trim();
  renderDriversList(q);
}

function showAddDriverModal() { showAddUserModal('driver'); }
function showAddUserModal(role = 'driver') {
  const isDriver = role === 'driver';
  const title = isDriver ? '‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿØŸàÿ®' : '‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿØŸäÿ±';
  showModal(title, `
    <div class="input-group" style="margin-bottom:12px;">
      <div class="input-label">üë§ ÿßŸÑÿßÿ≥ŸÖ</div>
      <input class="form-input" id="newUserName" placeholder="${isDriver ? 'ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿØŸàÿ®' : 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿØŸäÿ±'}">
    </div>
    <div class="input-group" style="margin-bottom:12px;">
      <div class="input-label">üì± ÿ±ŸÇŸÖ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ</div>
      <input class="form-input" type="tel" id="newUserPhone" placeholder="01xxxxxxxxx" inputmode="numeric">
    </div>
    <div class="input-group" style="margin-bottom:8px;">
      <div class="input-label">üîë ŸÉŸàÿØ ÿßŸÑÿØÿÆŸàŸÑ (6 ÿ£ÿ±ŸÇÿßŸÖ)</div>
      <input class="form-input" type="tel" id="newUserPin" placeholder="ŸÖÿ´ÿßŸÑ: 123456" maxlength="6" inputmode="numeric">
    </div>
    <div style="font-size:11px;color:var(--text3);padding:4px 0;">ÿßÿ®ÿπÿ™ ÿßŸÑÿ±ŸÇŸÖ ŸàÿßŸÑŸÉŸàÿØ ${isDriver ? 'ŸÑŸÑŸÖŸÜÿØŸàÿ®' : 'ŸÑŸÑŸÖÿØŸäÿ±'} ÿπÿ¥ÿßŸÜ ŸäÿØÿÆŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</div>`,
    [{ label: 'ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®', cls: 'confirm', action: () => addUser(role) },
     { label: 'ÿ•ŸÑÿ∫ÿßÿ°', cls: 'cancel', action: closeModal }]);
}


async function addDriver() { await addUser('driver'); }
async function addUser(role) {
  const name  = document.getElementById('newUserName').value.trim();
  const phone = document.getElementById('newUserPhone').value.trim();
  const pin   = document.getElementById('newUserPin').value.trim();
  if (!name)             { showToast('ÿßÿØÿÆŸÑ ÿßŸÑÿßÿ≥ŸÖ'); return; }
  if (phone.length < 10) { showToast('ÿßÿØÿÆŸÑ ÿ±ŸÇŸÖ ÿµÿ≠Ÿäÿ≠'); return; }
  if (pin.length !== 6)  { showToast('ÿßŸÑŸÉŸàÿØ ŸÑÿßÿ≤ŸÖ 6 ÿ£ÿ±ŸÇÿßŸÖ'); return; }

  const btn = document.getElementById('mBtn0');
  if (btn) { btn.disabled = true; btn.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°...'; }

  let p = phone.replace(/\D/g,'');
  if (!p.startsWith('0')) p = '0' + p;
  const email = p + '@nabilpro.app';

  try {
    let secondaryApp;
    try { secondaryApp = firebase.app('secondary'); }
    catch(e) { secondaryApp = firebase.initializeApp(FIREBASE_CONFIG, 'secondary'); }

    const secondaryAuth = secondaryApp.auth();
    const result = await secondaryAuth.createUserWithEmailAndPassword(email, pin);
    const uid = result.user.uid;
    await secondaryAuth.signOut();

    await db.collection('users').doc(uid).set({
      uid, name, phone: p, email, role,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: currentUser.uid
    });

    allDrivers.push({ uid, name, phone: p, email, role });
    renderDriversList();
    closeModal();
    showToast(`‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ${name}`);
  } catch(err) {
    if (btn) { btn.disabled = false; btn.textContent = 'ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®'; }
    if (err.code === 'auth/email-already-in-use') showToast('‚ùå ÿßŸÑÿ±ŸÇŸÖ ÿØŸá ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅÿπŸÑ');
    else showToast('ÿÆÿ∑ÿ£: ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ');
  }
}


function showDriverDetail(uid) {
  selectedDriverUid = uid;
  const driver = allDrivers.find(d => d.uid === uid);
  if (!driver) return;

  document.getElementById('detailDriverName').textContent = driver.name || '‚Äî';
  document.getElementById('detailDriverPhone').textContent = driver.phone || '‚Äî';

  const todayStart = new Date(); todayStart.setHours(0,0,0,0);
  const dOrders = allOrders.filter(o => o.driverId === uid);
  const todayOrders = dOrders.filter(o => {
    const t = o.timestamp?.toDate?.() || new Date(o.timestamp);
    return t >= todayStart;
  });
  const todayDelivery = todayOrders.reduce((s,o) => s + (o.delivery||0), 0);
  const todayCash = todayOrders.filter(o => o.payment==='cash').reduce((s,o) => s + (o.total||0), 0);

  document.getElementById('detailOrders').textContent = todayOrders.length;
  document.getElementById('detailDelivery').textContent = 'ÿ¨ ' + todayDelivery;
  document.getElementById('detailTotal').textContent = 'ÿ¨ ' + todayCash;

  document.getElementById('detailOrdersList').innerHTML = todayOrders.length
    ? todayOrders.map(o => {
        const t = o.timestamp?.toDate?.() || new Date();
        const timeStr = t.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
        return `<div class="mgr-order-card">
          <span style="font-size:20px;">${o.payment==='visa'?'üí≥':'üíµ'}</span>
          <div class="mgr-order-body">
            <div class="mgr-order-rest">${o.restName||'‚Äî'}</div>
            <div class="mgr-order-driver">üìç ${o.address||'‚Äî'}</div>
            <div class="mgr-order-time">‚è∞ ${timeStr}</div>
          </div>
          <div class="mgr-order-amount">ÿ¨ ${o.delivery||0}</div>
        </div>`;
      }).join('')
    : '<div class="empty-state"><div class="empty-text">ŸÑÿß ÿ£Ÿàÿ±ÿØÿ±ÿßÿ™ ÿßŸÑŸäŸàŸÖ</div></div>';

  document.getElementById('driverDetailOverlay').classList.add('show');
}

function closeDriverDetail() {
  document.getElementById('driverDetailOverlay').classList.remove('show');
  selectedDriverUid = null;
}

async function toggleDriverRole() {
  if (!selectedDriverUid) return;
  const driver = allDrivers.find(d => d.uid === selectedDriverUid);
  if (!driver) return;
  const newRole = driver.role === 'manager' ? 'driver' : 'manager';
  const label = newRole === 'manager' ? 'ÿ™ÿ±ŸÇŸäÿ© ŸÑŸÖÿØŸäÿ±' : 'ÿ™ÿ≠ŸàŸäŸÑ ŸÑŸÖŸÜÿØŸàÿ®';
  showModal(label, `<p style="color:var(--text2);font-size:14px;">${label} "${driver.name}"ÿü</p>`,
    [{ label: label, cls: 'confirm', action: async () => {
        await db.collection('users').doc(selectedDriverUid).update({ role: newRole });
        driver.role = newRole;
        renderDriversList();
        closeModal();
        showToast('‚úÖ ÿ™ŸÖ ' + label);
        document.getElementById('roleBtn').textContent = newRole === 'manager' ? 'üë§' : 'üëë';
    }},
    { label: 'ÿ•ŸÑÿ∫ÿßÿ°', cls: 'cancel', action: closeModal }]);
}

async function changeDriverPin() {
  if (!selectedDriverUid) return;
  const driver = allDrivers.find(d => d.uid === selectedDriverUid);
  showModal('üîë ÿ™ÿ∫ŸäŸäÿ± ŸÉŸàÿØ ÿßŸÑÿØÿÆŸàŸÑ', `
    <div style="font-size:13px;color:var(--text2);margin-bottom:12px;">ÿßŸÑŸÖŸÜÿØŸàÿ®: <strong>${sanitize(driver?.name||'')}</strong></div>
    <div class="input-group">
      <div class="input-label">ŸÉŸàÿØ ÿ¨ÿØŸäÿØ (6 ÿ£ÿ±ŸÇÿßŸÖ)</div>
      <input class="form-input" type="tel" id="newPinInput" placeholder="123456" maxlength="6" inputmode="numeric">
    </div>`,
    [{ label: 'ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÉŸàÿØ', cls: 'confirm', action: async () => {
        const newPin = document.getElementById('newPinInput').value.trim();
        if (newPin.length !== 6) { showToast('ÿßŸÑŸÉŸàÿØ ŸÑÿßÿ≤ŸÖ 6 ÿ£ÿ±ŸÇÿßŸÖ'); return; }

        const btn = document.getElementById('mBtn0');
        if (btn) { btn.disabled = true; btn.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ∫ŸäŸäÿ±...'; }

        try {
          // Login as the driver using secondary app then change password
          let secondaryApp;
          try { secondaryApp = firebase.app('secondary'); }
          catch(e) { secondaryApp = firebase.initializeApp(FIREBASE_CONFIG, 'secondary'); }

          const secondaryAuth = secondaryApp.auth();
          const email = driver.email || (driver.phone + '@nabilpro.app');
          // We don't have old pin, so store new pin in Firestore for driver to update on next login
          await db.collection('users').doc(selectedDriverUid).update({
            pendingPin: newPin,
            pendingPinSetAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          closeModal();
          showToast(`‚úÖ ŸÉŸàÿØ ${driver?.name} ÿßŸÑÿ¨ÿØŸäÿØ: ${newPin} ‚Äî ÿßÿ®ÿπÿ™Ÿá ŸÑŸäŸá`);
        } catch(err) {
          if (btn) { btn.disabled = false; btn.textContent = 'ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÉŸàÿØ'; }
          showToast('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÉŸàÿØ');
        }
    }},
    { label: 'ÿ•ŸÑÿ∫ÿßÿ°', cls: 'cancel', action: closeModal }]);
}


async function removeDriver() {
  if (!selectedDriverUid) return;
  const driver = allDrivers.find(d => d.uid === selectedDriverUid);
  const isManager = driver?.role === 'manager';
  const label = isManager ? 'ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿØŸäÿ±' : 'ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿØŸàÿ®';
  const name = driver?.name || 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ';

  // ŸÖŸÜÿπ ÿßŸÑŸÖÿØŸäÿ± ŸÖŸÜ ÿ≠ÿ∞ŸÅ ŸÜŸÅÿ≥Ÿá
  if (selectedDriverUid === currentUser.uid) {
    showToast('‚ùå ŸÖÿ¥ ÿ™ŸÇÿØÿ± ÿ™ÿ≠ÿ∞ŸÅ ÿ≠ÿ≥ÿßÿ®ŸÉ ÿßŸÑÿÆÿßÿµ');
    return;
  }

  showModal(label, `
    <p style="color:var(--text2);font-size:14px;margin-bottom:8px;">ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ <strong>${sanitize(name)}</strong> ŸÖŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖÿü</p>
    <p style="color:var(--danger);font-size:12px;">‚ö†Ô∏è ÿßŸÑÿ£Ÿàÿ±ÿØÿ±ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© Ÿáÿ™ŸÅÿ∂ŸÑ ŸÖÿ≠ŸÅŸàÿ∏ÿ©</p>`,
    [{ label: 'üóë ÿ≠ÿ∞ŸÅ ŸÜŸáÿßÿ¶Ÿä', cls: 'danger', action: async () => {
        const btn = document.getElementById('mBtn0');
        if (btn) { btn.disabled = true; btn.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ÿ∞ŸÅ...'; }
        try {
          // ÿ≠ÿ∞ŸÅ ŸÖŸÜ Firestore
          await db.collection('users').doc(selectedDriverUid).delete();
          // ÿ≠ÿ∞ŸÅ ŸÖŸÜ Firebase Auth ÿπŸÜ ÿ∑ÿ±ŸäŸÇ Cloud Function (ŸÑŸà ŸÖÿ™ÿßÿ≠ÿ©) ÿ£Ÿà ŸÜÿ≥ÿ¨ŸÑ ŸÖŸÑÿßÿ≠ÿ∏ÿ©
          // Note: ÿ≠ÿ∞ŸÅ Auth account Ÿäÿ≠ÿ™ÿßÿ¨ Admin SDK - ŸÜÿ≠ÿ∞ŸÅ Firestore ŸÅŸÇÿ∑
          // ÿØŸá ŸÉÿßŸÅŸä ÿπÿ¥ÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ¥ ŸáŸäŸÇÿØÿ± ŸäÿØÿÆŸÑ ŸÑÿ£ŸÜ profile ÿ®ÿ™ÿßÿπŸá ÿßÿ™ÿ≠ÿ∞ŸÅ
          allDrivers = allDrivers.filter(d => d.uid !== selectedDriverUid);
          renderDriversList();
          closeModal();
          closeDriverDetail();
          showToast(`‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${name}`);
        } catch(err) {
          if (btn) { btn.disabled = false; btn.textContent = 'üóë ÿ≠ÿ∞ŸÅ ŸÜŸáÿßÿ¶Ÿä'; }
          showToast('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ÿ∞ŸÅ - ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™');
        }
    }},
    { label: 'ÿ•ŸÑÿ∫ÿßÿ°', cls: 'cancel', action: closeModal }]);
}

// ============================================================
// MANAGER: RESTAURANTS
// ============================================================
async function loadMgrRestaurants() {
  const snap = await db.collection('restaurants').orderBy('name').get();
  const rests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  document.getElementById('mgrRestsList').innerHTML = rests.length
    ? rests.map(r => `
      <div class="rest-item">
        <div class="rest-item-icon">üè™</div>
        <span class="rest-item-name">${sanitize(r.name)}</span>
        <button class="rest-item-del" onclick="deleteMgrRest('${sanitize(r.id)}','${sanitize(r.name)}')">ÿ≠ÿ∞ŸÅ</button>
      </div>`).join('')
    : '<div class="empty-state"><div class="empty-text">ŸÑÿß ŸÖÿ∑ÿßÿπŸÖ ÿ®ÿπÿØ</div></div>';
}


function showAddRestModal() {
  showModal('ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ∑ÿπŸÖ', `<input class="form-input" id="newRestName" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ∑ÿπŸÖ">`,
    [{ label: 'ÿ•ÿ∂ÿßŸÅÿ©', cls: 'confirm', action: async () => {
        const name = document.getElementById('newRestName').value.trim();
        if (!name) return;
        await db.collection('restaurants').add({ name, active: true, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        closeModal(); showToast('‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ' + name);
        loadMgrRestaurants();
    }},
    { label: 'ÿ•ŸÑÿ∫ÿßÿ°', cls: 'cancel', action: closeModal }]);
}

async function deleteMgrRest(id, name) {
  showModal('ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ∑ÿπŸÖ', `<p style="color:var(--text2);margin-bottom:8px;">ÿ≠ÿ∞ŸÅ "${sanitize(name)}"ÿü</p><p style="color:var(--text3);font-size:12px;">ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿßŸÑÿ£Ÿàÿ±ÿØÿ±ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®Ÿá ŸÑŸÜ ÿ™Ÿèÿ≠ÿ∞ŸÅ</p>`,
    [{ label: 'ÿ≠ÿ∞ŸÅ', cls: 'danger', action: async () => {
        await db.collection('restaurants').doc(id).delete();
        closeModal(); showToast('‚úÖ ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ');
        loadMgrRestaurants();
    }},
    { label: 'ÿ•ŸÑÿ∫ÿßÿ°', cls: 'cancel', action: closeModal }]);
}

// ============================================================
// MANAGER: REPORTS
// ============================================================
function mgrTab(n, el) {
  document.querySelectorAll('.mgr-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.mgr-tab-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('mgrPanel' + n).classList.add('active');
  if (n === 1) renderDriversList();
  if (n === 2) loadMgrRestaurants();
  if (n === 3) renderMgrReports();
}

function setReportPeriod(p, el) {
  reportPeriod = p;
  document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderMgrReports();
}

function renderMgrReports() {
  const now = new Date();
  let startDate;
  if (reportPeriod === 'today') { startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); }
  else if (reportPeriod === 'week') { startDate = new Date(now); startDate.setDate(now.getDate() - 7); }
  else { startDate = new Date(now.getFullYear(), now.getMonth(), 1); }

  const filtered = allOrders.filter(o => {
    const t = o.timestamp?.toDate?.() || new Date(o.timestamp);
    return t >= startDate;
  });

  // Group by driver
  const byDriver = {};
  filtered.forEach(o => {
    if (!byDriver[o.driverId]) byDriver[o.driverId] = { name: o.driverName || '‚Äî', orders:0, delivery:0, cash:0 };
    byDriver[o.driverId].orders++;
    byDriver[o.driverId].delivery += o.delivery || 0;
    if (o.payment === 'cash') byDriver[o.driverId].cash += o.total || 0;
  });

  const entries = Object.entries(byDriver).sort((a,b) => b[1].delivery - a[1].delivery);
  const totalDelivery = filtered.reduce((s,o) => s + (o.delivery||0), 0);

  document.getElementById('reportsContent').innerHTML = `
    <div class="mgr-stat" style="margin-bottom:14px;">
      <div class="mgr-stat-icon">üìä</div>
      <div class="mgr-stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸàÿµŸäŸÑ</div>
      <div class="mgr-stat-val">ÿ¨ ${totalDelivery}</div>
    </div>
    ${entries.map(([uid, d]) => `
      <div class="report-row">
        <div>
          <div class="report-driver-name">${d.name}</div>
          <div class="report-driver-orders">${d.orders} ÿ£Ÿàÿ±ÿØÿ±</div>
        </div>
        <div class="report-driver-income">ÿ¨ ${d.delivery}</div>
      </div>`).join('') || '<div class="empty-state"><div class="empty-text">ŸÑÿß ÿ®ŸäÿßŸÜÿßÿ™</div></div>'}`;
}

// ============================================================
// MODAL
// ============================================================
function showModal(title, bodyHTML, buttons) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = bodyHTML;
  document.getElementById('modalActions').innerHTML = buttons.map((b,i) =>
    `<button class="modal-btn ${b.cls}" id="mBtn${i}">${b.label}</button>`).join('');
  buttons.forEach((b,i) => document.getElementById('mBtn'+i).onclick = b.action);
  document.getElementById('modalOverlay').classList.add('show');
}
function closeModal() { document.getElementById('modalOverlay').classList.remove('show'); }
document.getElementById('modalOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// ============================================================
// TOAST
// ============================================================
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

// ============================================================
// START
// ============================================================
window.addEventListener("load", initApp);
</script>
</body>
</html>
