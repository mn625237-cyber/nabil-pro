<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0f1e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Nabil Pro">
<title>Nabil Pro ğŸ›µ</title>
<link id="manifest-link" rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">

<!-- ======= FIREBASE SDK ======= -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
/* ==============================
   DESIGN SYSTEM - MOTORSPORT DARK
   ============================== */
:root {
  --bg: #0a0f1e;
  --bg2: #111827;
  --bg3: #1a2236;
  --card: rgba(17,24,39,0.95);
  --card-border: rgba(255,255,255,0.07);
  --text: #f1f5f9;
  --text2: #64748b;
  --text3: #94a3b8;
  --primary: #f97316;
  --primary-dark: #c2410c;
  --primary-glow: rgba(249,115,22,0.15);
  --primary-glow2: rgba(249,115,22,0.08);
  --success: #22c55e;
  --success-glow: rgba(34,197,94,0.15);
  --danger: #ef4444;
  --danger-glow: rgba(239,68,68,0.12);
  --visa: #818cf8;
  --visa-glow: rgba(129,140,248,0.15);
  --cash: #22c55e;
  --radius: 18px;
  --radius-sm: 12px;
  --shadow: 0 8px 32px rgba(0,0,0,0.5);
  --shadow-sm: 0 2px 12px rgba(0,0,0,0.3);
  --glow-primary: 0 0 30px rgba(249,115,22,0.2);
  --nav-h: 68px;
  --header-h: 62px;
}
[data-theme="light"] {
  --bg: #f0f4f8;
  --bg2: #ffffff;
  --bg3: #e8edf3;
  --card: rgba(255,255,255,0.95);
  --card-border: rgba(0,0,0,0.06);
  --text: #0f172a;
  --text2: #64748b;
  --text3: #94a3b8;
  --primary-glow: rgba(249,115,22,0.1);
  --primary-glow2: rgba(249,115,22,0.06);
  --shadow: 0 8px 32px rgba(0,0,0,0.1);
  --shadow-sm: 0 2px 12px rgba(0,0,0,0.06);
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body, .header, .bottom-nav, .card, .stat-card, .order-card, .welcome,
.nav-item, .btn, .icon-btn, .rest-chip, .select-opt, .filter-chip,
.amount-tag, .report-row, .section-title, .modal-title {
  -webkit-user-select: none; user-select: none;
}
input, textarea { -webkit-user-select: text; user-select: text; }

body {
  font-family: 'Cairo', sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
  transition: background 0.3s, color 0.3s;
}

/* === LOADING SCREEN === */
#loadingScreen {
  position: fixed; inset: 0; z-index: 1000;
  background: var(--bg);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 20px;
}
.loading-logo {
  animation: logoPulse 2s ease-in-out infinite;
}
@keyframes logoPulse {
  0%,100% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(249,115,22,0.3)); }
  50% { transform: scale(1.05); filter: drop-shadow(0 0 40px rgba(249,115,22,0.6)); }
}
.loading-bar {
  width: 160px; height: 3px; background: var(--bg3); border-radius: 2px; overflow: hidden;
}
.loading-bar-inner {
  height: 100%; background: linear-gradient(90deg, var(--primary), #fbbf24);
  border-radius: 2px; animation: loadBar 2s ease infinite;
}
@keyframes loadBar {
  0% { width: 0%; } 70% { width: 100%; } 100% { width: 100%; opacity: 0; }
}
.loading-text {
  font-size: 14px; font-weight: 700; color: var(--text2);
}

/* === FIREBASE SETUP MODAL === */
#setupModal {
  position: fixed; inset: 0; z-index: 999;
  background: var(--bg);
  display: none; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 20px;
}
#setupModal.show { display: flex; }
.setup-card {
  width: 100%; max-width: 400px;
  background: var(--bg2); border: 1px solid var(--card-border);
  border-radius: var(--radius); padding: 24px;
  box-shadow: var(--shadow);
}
.setup-logo { text-align: center; margin-bottom: 20px; }
.setup-title { font-size: 20px; font-weight: 900; text-align: center; margin-bottom: 8px; }
.setup-sub { font-size: 13px; color: var(--text2); text-align: center; margin-bottom: 20px; line-height: 1.8; }
.setup-note {
  background: var(--primary-glow); border: 1px solid var(--primary);
  border-radius: 12px; padding: 12px; font-size: 12px;
  color: var(--primary); line-height: 1.8; margin-bottom: 20px;
}

/* === HEADER === */
.header {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  height: var(--header-h);
  background: var(--bg2);
  border-bottom: 1px solid var(--card-border);
  padding: 0 16px;
  display: flex; align-items: center; justify-content: space-between;
  backdrop-filter: blur(10px);
}
.header-logo { display: flex; align-items: center; gap: 10px; }
.header-title {
  font-size: 21px; font-weight: 900;
  background: linear-gradient(135deg, var(--primary) 0%, #fbbf24 60%, var(--primary) 100%);
  background-size: 200% 100%;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: shimmer 3s ease-in-out infinite;
}
@keyframes shimmer {
  0%,100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}
.header-actions { display: flex; gap: 8px; align-items: center; }
.icon-btn {
  width: 38px; height: 38px; border-radius: 10px;
  border: 1px solid var(--card-border);
  background: var(--bg3); color: var(--text);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 18px; transition: all 0.2s;
  position: relative;
}
.icon-btn:active { transform: scale(0.88); }
.online-dot {
  position: absolute; top: 6px; right: 6px;
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--success);
  box-shadow: 0 0 6px var(--success);
}
.offline-dot { background: var(--danger); box-shadow: 0 0 6px var(--danger); }

/* === SWIPE CONTAINER === */
.swipe-container {
  position: fixed;
  top: var(--header-h);
  bottom: var(--nav-h);
  left: 0; right: 0;
  overflow: hidden;
}
.pages-wrapper {
  display: flex;
  width: 400%;
  height: 100%;
  transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  will-change: transform;
}
.pages-wrapper.no-transition { transition: none; }
.page {
  width: 25%;
  height: 100%;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 16px 16px 20px;
  -webkit-overflow-scrolling: touch;
  scroll-behavior: smooth;
}
/* scrollbar hide */
.page::-webkit-scrollbar, body::-webkit-scrollbar { display: none; }
.page { -ms-overflow-style: none; scrollbar-width: none; }

/* === PAGE INDICATOR === */
.page-indicator {
  position: fixed;
  top: calc(var(--header-h) + 8px);
  left: 50%; transform: translateX(-50%);
  display: flex; gap: 6px; z-index: 50;
  pointer-events: none;
}
.dot {
  width: 6px; height: 6px; border-radius: 3px;
  background: var(--text2); transition: all 0.3s;
}
.dot.active { width: 18px; background: var(--primary); }

/* === BOTTOM NAV === */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
  height: var(--nav-h);
  background: var(--bg2);
  border-top: 1px solid var(--card-border);
  display: grid; grid-template-columns: repeat(4, 1fr);
  padding-bottom: max(0px, env(safe-area-inset-bottom));
  backdrop-filter: blur(10px);
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 3px; padding: 8px 4px; cursor: pointer; transition: all 0.2s;
  color: var(--text2); font-size: 10px; font-weight: 700;
  position: relative;
}
.nav-item.active { color: var(--primary); }
.nav-item svg { width: 22px; height: 22px; transition: transform 0.2s; }
.nav-item.active svg { transform: scale(1.15); }
.nav-pip {
  position: absolute; top: 6px;
  width: 4px; height: 4px; border-radius: 2px;
  background: var(--primary); opacity: 0; transition: opacity 0.2s;
}
.nav-item.active .nav-pip { opacity: 1; }

/* === CARDS === */
.card {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: var(--radius); padding: 16px; margin-bottom: 12px;
  box-shadow: var(--shadow-sm);
  backdrop-filter: blur(10px);
}

/* === WELCOME BANNER === */
.welcome {
  border-radius: var(--radius); padding: 20px; margin-bottom: 14px;
  background: linear-gradient(135deg, #1a1008 0%, #2a1505 40%, #1a0f08 100%);
  border: 1px solid rgba(249,115,22,0.3);
  position: relative; overflow: hidden;
}
.welcome::before {
  content: ''; position: absolute; inset: 0;
  background: radial-gradient(circle at 80% 50%, rgba(249,115,22,0.15) 0%, transparent 70%);
}
[data-theme="light"] .welcome {
  background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 40%, #fff7ed 100%);
  border-color: rgba(249,115,22,0.2);
}
.welcome-content { position: relative; }
.welcome-name { font-size: 20px; font-weight: 900; color: var(--text); }
.welcome-sub { font-size: 12px; color: var(--text2); margin-top: 2px; }
.welcome-time {
  font-size: 32px; font-weight: 900; color: var(--primary);
  margin-top: 6px; font-variant-numeric: tabular-nums;
  text-shadow: 0 0 20px rgba(249,115,22,0.4);
}
.welcome-vespa {
  position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
  opacity: 0.15;
}
[data-theme="light"] .welcome-vespa { opacity: 0.1; }

/* === DASH GRID === */
.dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
.stat-card {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: var(--radius); padding: 16px;
  display: flex; flex-direction: column; gap: 6px;
  position: relative; overflow: hidden;
  transition: transform 0.2s;
}
.stat-card:active { transform: scale(0.97); }
.stat-card::before {
  content: ''; position: absolute; bottom: 0; left: 0; right: 0;
  height: 2px; transition: opacity 0.3s;
}
.stat-card.s-orders::before { background: var(--primary); }
.stat-card.s-profit::before { background: var(--success); }
.stat-card.s-cash::before { background: #fbbf24; }
.stat-card.s-visa::before { background: var(--visa); }
.stat-icon { font-size: 22px; }
.stat-label { font-size: 11px; color: var(--text2); font-weight: 600; }
.stat-value {
  font-size: 24px; font-weight: 900;
  animation: countUp 0.4s ease-out;
}
@keyframes countUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.stat-value.orange { color: var(--primary); }
.stat-value.profit { color: var(--success); }
.stat-value.yellow { color: #fbbf24; }
.stat-value.viola { color: var(--visa); }

/* === SECTION TITLE === */
.section-title {
  font-size: 15px; font-weight: 800; margin-bottom: 12px; color: var(--text);
  display: flex; align-items: center; gap: 8px;
}
.section-title::after {
  content: ''; flex: 1; height: 1px; background: var(--card-border);
}
.divider { height: 1px; background: var(--card-border); margin: 12px 0; }

/* === FORM === */
.form-group { margin-bottom: 14px; }
.form-label {
  font-size: 12px; font-weight: 800; color: var(--text2);
  margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.form-input {
  width: 100%; padding: 13px 16px; border-radius: var(--radius-sm);
  border: 1.5px solid var(--card-border); background: var(--bg3);
  color: var(--text); font-family: 'Cairo', sans-serif; font-size: 15px;
  outline: none; transition: all 0.25s;
  -webkit-appearance: none;
}
.form-input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--primary-glow2);
  background: var(--bg2);
}
.form-input::placeholder { color: var(--text2); }
.input-voice-row { display: flex; gap: 8px; align-items: center; }
.input-voice-row .form-input { flex: 1; }
.voice-btn {
  width: 48px; height: 48px; border-radius: var(--radius-sm); border: none;
  background: var(--primary-glow); color: var(--primary);
  font-size: 20px; cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: all 0.2s; flex-shrink: 0;
}
.voice-btn.recording {
  background: var(--danger-glow); color: var(--danger);
  animation: recPulse 1s ease-in-out infinite;
}
@keyframes recPulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(239,68,68,0); }
}

/* === SELECT === */
.select-row { display: flex; gap: 8px; }
.select-opt {
  flex: 1; padding: 13px 8px; border-radius: var(--radius-sm);
  border: 1.5px solid var(--card-border); background: var(--bg3);
  color: var(--text); font-family: 'Cairo', sans-serif; font-size: 13px;
  font-weight: 800; cursor: pointer; text-align: center; transition: all 0.25s;
}
.select-opt.active.cash { border-color: var(--success); background: var(--success-glow); color: var(--success); }
.select-opt.active.visa { border-color: var(--visa); background: var(--visa-glow); color: var(--visa); }
.select-opt.active.orange { border-color: var(--primary); background: var(--primary-glow); color: var(--primary); }

/* === REST CHIPS === */
.rest-chips { display: flex; flex-wrap: wrap; gap: 8px; }
.rest-chip {
  padding: 9px 16px; border-radius: 24px; border: 1.5px solid var(--card-border);
  background: var(--bg3); color: var(--text3); font-family: 'Cairo', sans-serif;
  font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s;
}
.rest-chip.active {
  border-color: var(--primary); background: var(--primary-glow);
  color: var(--primary); box-shadow: 0 0 12px var(--primary-glow);
}

/* === BUTTONS === */
.btn {
  width: 100%; padding: 14px; border-radius: var(--radius-sm); border: none;
  font-family: 'Cairo', sans-serif; font-size: 15px; font-weight: 800;
  cursor: pointer; transition: all 0.2s; display: flex; align-items: center;
  justify-content: center; gap: 8px; letter-spacing: 0.3px;
}
.btn:active { transform: scale(0.96); }
.btn-primary {
  background: linear-gradient(135deg, var(--primary) 0%, #fb923c 100%);
  color: white; box-shadow: 0 4px 20px rgba(249,115,22,0.3);
}
.btn-primary:active { box-shadow: 0 2px 10px rgba(249,115,22,0.2); }
.btn-whatsapp {
  background: linear-gradient(135deg, #25d366 0%, #1da851 100%);
  color: white; box-shadow: 0 4px 20px rgba(37,211,102,0.25);
}
.btn-outline {
  background: transparent; border: 1.5px solid var(--card-border); color: var(--text);
}
.btn-danger {
  background: var(--danger-glow); color: var(--danger);
  border: 1.5px solid rgba(239,68,68,0.3);
}
.btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }

/* === ORDER CARDS === */
.order-card {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: var(--radius); padding: 14px; margin-bottom: 10px;
  border-right: 3px solid var(--primary);
  animation: slideIn 0.3s ease;
}
.order-card.visa-card { border-right-color: var(--visa); }
@keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
.order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.order-rest { font-size: 14px; font-weight: 800; color: var(--primary); }
.order-time { font-size: 10px; color: var(--text2); font-weight: 600; }
.order-address { font-size: 13px; color: var(--text); margin-bottom: 4px; line-height: 1.5; }
.order-phone { font-size: 12px; color: var(--text2); margin-bottom: 10px; }
.order-amounts { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
.amount-tag {
  padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; white-space: nowrap;
}
.tag-total { background: var(--primary-glow); color: var(--primary); }
.tag-delivery { background: var(--success-glow); color: var(--success); }
.tag-rest { background: rgba(148,163,184,0.1); color: var(--text2); }
.tag-visa { background: var(--visa-glow); color: var(--visa); }
.tag-cash { background: var(--success-glow); color: var(--success); }
.order-actions { display: flex; gap: 8px; }
.small-btn {
  flex: 1; padding: 8px 4px; border-radius: 10px; border: none;
  font-family: 'Cairo', sans-serif; font-size: 12px; font-weight: 700;
  cursor: pointer; transition: all 0.2s;
}
.small-btn:active { transform: scale(0.93); }
.small-btn.edit { background: var(--primary-glow); color: var(--primary); }
.small-btn.del { background: var(--danger-glow); color: var(--danger); }
.small-btn.wa { background: rgba(37,211,102,0.1); color: #25d366; }

/* === FILTER === */
.filter-row {
  display: flex; gap: 8px; margin-bottom: 14px;
  overflow-x: auto; padding-bottom: 4px;
}
.filter-row::-webkit-scrollbar { display: none; }
.filter-chip {
  padding: 7px 16px; border-radius: 24px; white-space: nowrap;
  border: 1.5px solid var(--card-border); background: var(--bg3);
  color: var(--text2); font-family: 'Cairo', sans-serif;
  font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s;
}
.filter-chip.active {
  border-color: var(--primary); background: var(--primary-glow);
  color: var(--primary);
}

/* === MODAL === */
.modal-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.75);
  display: none; align-items: flex-end; justify-content: center;
  backdrop-filter: blur(4px);
}
.modal-overlay.open { display: flex; }
.modal {
  width: 100%; background: var(--bg2);
  border-radius: 24px 24px 0 0;
  padding: 20px 16px max(24px, env(safe-area-inset-bottom));
  max-height: 90vh; overflow-y: auto;
  animation: slideUp 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  border-top: 1px solid var(--card-border);
}
@keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-handle {
  width: 40px; height: 4px; border-radius: 2px;
  background: var(--card-border); margin: 0 auto 18px;
}
.modal-title { font-size: 18px; font-weight: 900; margin-bottom: 16px; }

/* === TOAST === */
.toast {
  position: fixed; bottom: calc(var(--nav-h) + 10px); left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--text); color: var(--bg);
  padding: 10px 22px; border-radius: 24px;
  font-size: 13px; font-weight: 800; z-index: 300;
  opacity: 0; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  pointer-events: none; white-space: nowrap; max-width: 90vw;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* === REPORT === */
.report-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 9px 0; border-bottom: 1px solid var(--card-border);
}
.report-row:last-child { border-bottom: none; }
.report-key { font-size: 13px; color: var(--text2); }
.report-val { font-size: 14px; font-weight: 800; }
.report-val.green { color: var(--success); }
.report-val.orange { color: var(--primary); }
.report-val.purple { color: var(--visa); }

/* === SETTINGS === */
.rest-item {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: var(--radius-sm); padding: 14px; margin-bottom: 8px;
  display: flex; align-items: center; justify-content: space-between;
  transition: all 0.2s;
}
.rest-name { font-size: 14px; font-weight: 700; }
.rest-toggle {
  width: 48px; height: 27px; border-radius: 14px; background: var(--bg3);
  border: none; cursor: pointer; position: relative; transition: background 0.3s;
  flex-shrink: 0;
}
.rest-toggle.on { background: var(--primary); }
.rest-toggle::after {
  content: ''; position: absolute; width: 21px; height: 21px;
  border-radius: 50%; background: white;
  top: 3px; right: 3px; transition: transform 0.3s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}
.rest-toggle.on::after { transform: translateX(-21px); }
.add-rest-form { display: flex; gap: 8px; margin-bottom: 14px; }
.add-rest-form .form-input { flex: 1; }
.add-btn {
  padding: 12px 18px; border-radius: var(--radius-sm); border: none;
  background: var(--primary); color: white;
  font-family: 'Cairo', sans-serif; font-size: 14px; font-weight: 800;
  cursor: pointer; white-space: nowrap;
  box-shadow: 0 4px 14px rgba(249,115,22,0.3);
  transition: all 0.2s;
}
.add-btn:active { transform: scale(0.95); }
.trash-btn {
  width: 36px; height: 36px; border-radius: 9px; border: none;
  background: var(--danger-glow); color: var(--danger);
  font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.trash-btn:active { transform: scale(0.9); }

/* === EMPTY STATE === */
.empty {
  text-align: center; padding: 50px 20px; color: var(--text2);
}
.empty-icon { font-size: 52px; margin-bottom: 14px; }
.empty-text { font-size: 15px; font-weight: 700; }
.empty-sub { font-size: 13px; margin-top: 6px; opacity: 0.7; }

/* === FIREBASE STATUS === */
.firebase-status {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px; border-radius: 12px;
  background: var(--success-glow); border: 1px solid rgba(34,197,94,0.3);
  font-size: 12px; font-weight: 700; color: var(--success);
  margin-bottom: 12px;
}
.firebase-status.offline {
  background: var(--danger-glow); border-color: rgba(239,68,68,0.3); color: var(--danger);
}
.firebase-status.syncing {
  background: var(--primary-glow); border-color: rgba(249,115,22,0.3); color: var(--primary);
}
.status-dot {
  width: 8px; height: 8px; border-radius: 50%; background: currentColor;
  flex-shrink: 0;
}
.status-dot.pulse { animation: dotPulse 1.5s ease-in-out infinite; }
@keyframes dotPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

/* === PAYMENT NOTE === */
.payment-note {
  background: var(--visa-glow); border: 1px solid rgba(129,140,248,0.3);
  border-radius: var(--radius-sm); padding: 12px;
  font-size: 13px; color: var(--visa); line-height: 1.7;
}

/* === PROGRESS BAR === */
.shift-progress {
  height: 6px; background: var(--bg3); border-radius: 3px; margin-top: 8px; overflow: hidden;
}
.shift-bar {
  height: 100%; border-radius: 3px;
  background: linear-gradient(90deg, var(--primary), #fbbf24);
  transition: width 0.5s ease;
}

/* === SYNC INDICATOR === */
.sync-badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 8px; border-radius: 8px;
  background: var(--primary-glow); color: var(--primary);
  font-size: 10px; font-weight: 700; animation: syncSpin 1s linear infinite;
}
@keyframes syncSpin { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

/* === DRIVER CHIP === */
.driver-chip {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px; border-radius: 14px;
  background: var(--bg3); border: 1px solid var(--card-border);
  margin-bottom: 12px;
}
.driver-avatar {
  width: 36px; height: 36px; border-radius: 50%;
  background: var(--primary-glow); border: 2px solid var(--primary);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
}
.driver-info { flex: 1; }
.driver-name { font-size: 14px; font-weight: 800; }
.driver-sub { font-size: 11px; color: var(--text2); }

/* === ANIMATIONS === */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}
.fade-in { animation: fadeInUp 0.35s ease both; }
.fade-in-1 { animation-delay: 0.05s; }
.fade-in-2 { animation-delay: 0.1s; }
.fade-in-3 { animation-delay: 0.15s; }
.fade-in-4 { animation-delay: 0.2s; }
</style>
</head>

<body data-theme="dark">

<!-- ========================= LOADING SCREEN ========================= -->
<div id="loadingScreen">
  <div class="loading-logo">
    <svg width="80" height="80" viewBox="0 0 80 80">
      <!-- Vespa/Scooter Logo SVG -->
      <circle cx="40" cy="40" r="38" fill="none" stroke="rgba(249,115,22,0.2)" stroke-width="1.5"/>
      <circle cx="40" cy="40" r="30" fill="none" stroke="rgba(249,115,22,0.1)" stroke-width="1"/>
      <!-- Scooter body -->
      <ellipse cx="42" cy="38" rx="18" ry="10" fill="none" stroke="#f97316" stroke-width="2.5" stroke-linecap="round"/>
      <!-- Handlebars -->
      <path d="M52 30 L58 26" stroke="#f97316" stroke-width="2.5" stroke-linecap="round"/>
      <path d="M56 24 L62 24" stroke="#f97316" stroke-width="2.5" stroke-linecap="round"/>
      <!-- Seat -->
      <path d="M36 30 Q40 27 48 30" stroke="#fbbf24" stroke-width="2" fill="none" stroke-linecap="round"/>
      <!-- Front wheel -->
      <circle cx="58" cy="48" r="8" fill="none" stroke="#f97316" stroke-width="2.5"/>
      <circle cx="58" cy="48" r="3" fill="#f97316" opacity="0.5"/>
      <!-- Rear wheel -->
      <circle cx="24" cy="48" r="8" fill="none" stroke="#f97316" stroke-width="2.5"/>
      <circle cx="24" cy="48" r="3" fill="#f97316" opacity="0.5"/>
      <!-- Exhaust -->
      <path d="M24 44 L18 46 L14 44" stroke="#f97316" stroke-width="1.5" fill="none" stroke-linecap="round"/>
      <!-- Delivery box -->
      <rect x="26" y="32" width="12" height="9" rx="2" fill="none" stroke="#fbbf24" stroke-width="2"/>
      <path d="M26 36 L38 36" stroke="#fbbf24" stroke-width="1" opacity="0.6"/>
    </svg>
  </div>
  <div class="loading-bar"><div class="loading-bar-inner"></div></div>
  <div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<!-- ========================= FIREBASE SETUP ========================= -->
<div id="setupModal">
  <div class="setup-card">
    <div class="setup-logo">
      <svg width="60" height="60" viewBox="0 0 80 80">
        <circle cx="40" cy="40" r="38" fill="rgba(249,115,22,0.1)" stroke="rgba(249,115,22,0.3)" stroke-width="1.5"/>
        <ellipse cx="42" cy="38" rx="18" ry="10" fill="none" stroke="#f97316" stroke-width="2.5" stroke-linecap="round"/>
        <path d="M52 30 L58 26" stroke="#f97316" stroke-width="2.5" stroke-linecap="round"/>
        <path d="M56 24 L62 24" stroke="#f97316" stroke-width="2.5" stroke-linecap="round"/>
        <circle cx="58" cy="48" r="8" fill="none" stroke="#f97316" stroke-width="2.5"/>
        <circle cx="24" cy="48" r="8" fill="none" stroke="#f97316" stroke-width="2.5"/>
        <rect x="26" y="32" width="12" height="9" rx="2" fill="none" stroke="#fbbf24" stroke-width="2"/>
      </svg>
    </div>
    <div class="setup-title">ğŸ”¥ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase</div>
    <div class="setup-sub">Ù„Ø§Ø²Ù… ØªØ¶ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙŠÙƒ Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ´ØªØºÙ„ ÙˆÙŠØ­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙÙŠ Ø§Ù„ÙƒÙ„Ø§ÙˆØ¯</div>
    <div class="setup-note">
      ğŸ“‹ Ø§Ù„Ø®Ø·ÙˆØ§Øª:<br>
      1. Ø±ÙˆØ­ console.firebase.google.com<br>
      2. Ø£Ù†Ø´Ø¦ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø§ÙØªØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ<br>
      3. Project Settings â†’ Your Apps â†’ Add Web App<br>
      4. Ø§Ù†Ø³Ø® Ø§Ù„Ù€ config ÙˆØ­Ø·Ù‡ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ (Ù…ÙƒØ§Ù†Ù‡ Ù…Ø´Ø§Ø± Ø¥Ù„ÙŠÙ‡ Ø¨Ù€ YOUR_)<br>
      5. ÙØ¹Ù‘Ù„ Firestore Database Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Build
    </div>
    <div class="form-group">
      <label class="form-label">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</label>
      <input type="text" class="form-input" id="setupDriverName" placeholder="Ù†Ø§Ø¨Ù„ - Ù…Ù†Ø¯ÙˆØ¨ Ø¯Ù„ÙŠÙØ±ÙŠ">
    </div>
    <button class="btn btn-primary" onclick="saveSetup()">ğŸš€ Ø§Ø¨Ø¯Ø£</button>
  </div>
</div>

<!-- ========================= HEADER ========================= -->
<div class="header">
  <div class="header-logo">
    <!-- Vespa Logo Mini -->
    <svg width="32" height="32" viewBox="0 0 80 80" style="flex-shrink:0">
      <circle cx="40" cy="40" r="38" fill="rgba(249,115,22,0.12)" stroke="rgba(249,115,22,0.3)" stroke-width="1.5"/>
      <ellipse cx="42" cy="38" rx="18" ry="10" fill="none" stroke="#f97316" stroke-width="2.5" stroke-linecap="round"/>
      <path d="M52 30 L58 26" stroke="#f97316" stroke-width="2.5" stroke-linecap="round"/>
      <path d="M56 24 L62 24" stroke="#f97316" stroke-width="2.5" stroke-linecap="round"/>
      <circle cx="58" cy="48" r="8" fill="none" stroke="#f97316" stroke-width="2.5"/>
      <circle cx="24" cy="48" r="8" fill="none" stroke="#f97316" stroke-width="2.5"/>
      <rect x="26" y="32" width="12" height="9" rx="2" fill="none" stroke="#fbbf24" stroke-width="2"/>
    </svg>
    <div class="header-title">Nabil Pro</div>
  </div>
  <div class="header-actions">
    <button class="icon-btn" id="installBtn" onclick="showInstallGuide()" title="ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" style="display:none">ğŸ“²</button>
    <button class="icon-btn" onclick="toggleTheme()" id="themeBtn" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø«ÙŠÙ…">ğŸŒ™</button>
    <button class="icon-btn" id="syncBtn" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„" style="position:relative">
      ğŸ”¥
      <span class="online-dot" id="onlineDot"></span>
    </button>
  </div>
</div>

<!-- ========================= PAGE INDICATOR ========================= -->
<div class="page-indicator">
  <div class="dot active" id="dot-0"></div>
  <div class="dot" id="dot-1"></div>
  <div class="dot" id="dot-2"></div>
  <div class="dot" id="dot-3"></div>
</div>

<!-- ========================= SWIPE PAGES ========================= -->
<div class="swipe-container" id="swipeContainer">
  <div class="pages-wrapper" id="pagesWrapper">

    <!-- PAGE 0: HOME -->
    <div class="page" id="page-home">
      <div class="welcome fade-in">
        <!-- Background Vespa -->
        <svg class="welcome-vespa" width="120" height="80" viewBox="0 0 80 80">
          <ellipse cx="42" cy="38" rx="18" ry="10" fill="none" stroke="white" stroke-width="3" stroke-linecap="round"/>
          <path d="M52 30 L58 26" stroke="white" stroke-width="3" stroke-linecap="round"/>
          <path d="M56 24 L62 24" stroke="white" stroke-width="3" stroke-linecap="round"/>
          <circle cx="58" cy="48" r="8" fill="none" stroke="white" stroke-width="3"/>
          <circle cx="24" cy="48" r="8" fill="none" stroke="white" stroke-width="3"/>
          <rect x="26" y="32" width="12" height="9" rx="2" fill="none" stroke="white" stroke-width="2.5"/>
        </svg>
        <div class="welcome-content">
          <div class="welcome-name" id="welcomeGreet">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
          <div class="welcome-sub" id="driverNameDisplay">Ù…Ù†Ø¯ÙˆØ¨ Ø¯Ù„ÙŠÙØ±ÙŠ</div>
          <div class="welcome-time" id="welcomeTime">00:00</div>
        </div>
      </div>

      <!-- Firebase Status -->
      <div class="firebase-status syncing fade-in fade-in-1" id="fbStatus">
        <div class="status-dot pulse"></div>
        <span id="fbStatusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase...</span>
      </div>

      <div class="dash-grid">
        <div class="stat-card s-orders fade-in fade-in-1">
          <div class="stat-icon">ğŸ“¦</div>
          <div class="stat-label">Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="stat-value orange" id="stat-orders">0</div>
        </div>
        <div class="stat-card s-profit fade-in fade-in-2">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-label">Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØªÙˆØµÙŠÙ„</div>
          <div class="stat-value profit" id="stat-profit">0 Ø¬</div>
        </div>
        <div class="stat-card s-cash fade-in fade-in-3">
          <div class="stat-icon">ğŸ’µ</div>
          <div class="stat-label">ØªØ­ØµÙŠÙ„ ÙƒØ§Ø´</div>
          <div class="stat-value yellow" id="stat-cash">0 Ø¬</div>
        </div>
        <div class="stat-card s-visa fade-in fade-in-4">
          <div class="stat-icon">ğŸ’³</div>
          <div class="stat-label">ÙÙŠØ²Ø§ (Ø£ÙƒØ³Ø¨)</div>
          <div class="stat-value viola" id="stat-visa-earn">0 Ø¬</div>
        </div>
      </div>

      <div class="card fade-in">
        <div class="section-title">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´ÙŠÙØª</div>
        <div id="shiftReport">
          <div style="color:var(--text2);font-size:13px;text-align:center;padding:10px;">
            Ù„Ø§ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯
          </div>
        </div>
      </div>

      <div class="card fade-in">
        <div class="section-title">âš¡ Ø¢Ø®Ø± Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</div>
        <div id="recentOrders">
          <div class="empty" style="padding:20px">
            <div class="empty-icon">ğŸ›µ</div>
            <div class="empty-text">Ø§Ø³ØªÙ†Ù‰ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø§Ù„Ø£ÙˆÙ„</div>
          </div>
        </div>
      </div>
    </div>

    <!-- PAGE 1: ADD ORDER -->
    <div class="page" id="page-add">
      <div class="section-title">â• Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯</div>

      <div class="card">
        <div class="form-group">
          <label class="form-label">ğŸª Ø§Ù„Ù…Ø·Ø¹Ù…</label>
          <div class="rest-chips" id="restChips"></div>
        </div>

        <div class="form-group">
          <label class="form-label">ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <div class="input-voice-row">
            <input type="text" class="form-input" id="inp-address" placeholder="Ø­ÙŠ / Ø´Ø§Ø±Ø¹ / Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©">
            <button class="voice-btn" onclick="startVoice('inp-address', this)">ğŸ™ï¸</button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">ğŸ“± Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
          <div class="input-voice-row">
            <input type="tel" class="form-input" id="inp-phone" placeholder="01xxxxxxxxx">
            <button class="voice-btn" onclick="startVoice('inp-phone', this)">ğŸ™ï¸</button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">ğŸ’° Ø«Ù…Ù† Ø§Ù„Ø£ÙˆØ±Ø¯Ø± (Ø´Ø§Ù…Ù„ Ø§Ù„ØªÙˆØµÙŠÙ„)</label>
          <div class="input-voice-row">
            <input type="number" class="form-input" id="inp-total" placeholder="500" inputmode="numeric">
            <button class="voice-btn" onclick="startVoice('inp-total', this)">ğŸ™ï¸</button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">ğŸ›µ Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø£Ø±Ø¨Ø§Ø­Ùƒ)</label>
          <div class="input-voice-row">
            <input type="number" class="form-input" id="inp-delivery" placeholder="100" inputmode="numeric">
            <button class="voice-btn" onclick="startVoice('inp-delivery', this)">ğŸ™ï¸</button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
          <div class="select-row">
            <button class="select-opt active cash" id="opt-cash" onclick="selectPayment('cash')">ğŸ’µ ÙƒØ§Ø´</button>
            <button class="select-opt" id="opt-visa" onclick="selectPayment('visa')">ğŸ’³ ÙÙŠØ²Ø§ Ù…Ø³Ø¨Ù‚</button>
          </div>
        </div>

        <div id="paymentNote" style="display:none;margin-bottom:14px;"></div>
      </div>

      <button class="btn btn-primary" id="saveOrderBtn" onclick="saveOrder()" style="margin-bottom:10px">
        ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±
      </button>
      <button class="btn btn-whatsapp" onclick="sendWhatsapp()" style="margin-bottom:10px">
        ğŸ“² Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨
      </button>
      <button class="btn btn-outline" onclick="clearForm()">
        ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙÙˆØ±Ù…
      </button>
    </div>

    <!-- PAGE 2: RECORDS -->
    <div class="page" id="page-records">
      <div class="section-title">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
      <div class="filter-row">
        <button class="filter-chip active" onclick="filterOrders('all', this)">Ø§Ù„ÙƒÙ„</button>
        <button class="filter-chip" onclick="filterOrders('today', this)">Ø§Ù„ÙŠÙˆÙ…</button>
        <button class="filter-chip" onclick="filterOrders('week', this)">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
        <button class="filter-chip" onclick="filterOrders('cash', this)">ÙƒØ§Ø´</button>
        <button class="filter-chip" onclick="filterOrders('visa', this)">ÙÙŠØ²Ø§</button>
      </div>
      <div id="ordersList"></div>
    </div>

    <!-- PAGE 3: SETTINGS -->
    <div class="page" id="page-settings">
      <div class="section-title">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>

      <!-- Driver Info -->
      <div class="driver-chip card" id="driverChip" style="margin-bottom:12px;">
        <div class="driver-avatar">ğŸ›µ</div>
        <div class="driver-info">
          <div class="driver-name" id="settingsDriverName">â€”</div>
          <div class="driver-sub">Ù…Ù†Ø¯ÙˆØ¨ Ø¯Ù„ÙŠÙØ±ÙŠ Ù†Ø´Ø·</div>
        </div>
      </div>

      <!-- Restaurants -->
      <div class="card">
        <div class="section-title">ğŸª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</div>
        <div class="add-rest-form">
          <input type="text" class="form-input" id="newRestName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
          <button class="add-btn" onclick="addRestaurant()">+ Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div id="restList"></div>
      </div>

      <!-- Theme -->
      <div class="card">
        <div class="section-title">ğŸ¨ Ø§Ù„Ù…Ø¸Ù‡Ø±</div>
        <div class="select-row">
          <button class="select-opt" id="theme-auto" onclick="setThemeMode('auto')">ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
          <button class="select-opt active orange" id="theme-dark" onclick="setThemeMode('dark')">Ø¯Ø§ÙƒÙ†</button>
          <button class="select-opt" id="theme-light" onclick="setThemeMode('light')">ÙØ§ØªØ­</button>
        </div>
      </div>

      <!-- Firebase Info -->
      <div class="card">
        <div class="section-title">ğŸ”¥ Firebase</div>
        <div id="fbInfo" style="font-size:13px;color:var(--text2);line-height:2;"></div>
      </div>

      <!-- Data Management -->
      <div class="card">
        <div class="section-title">ğŸ—‘ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
        <button class="btn btn-danger" onclick="clearTodayOrders()" style="margin-bottom:10px">
          Ø­Ø°Ù Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…
        </button>
        <button class="btn btn-outline" onclick="clearAllOrders()">
          Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª
        </button>
      </div>
    </div>

  </div><!-- /pages-wrapper -->
</div><!-- /swipe-container -->

<!-- ========================= TOAST ========================= -->
<div class="toast" id="toast"></div>

<!-- ========================= BOTTOM NAV ========================= -->
<nav class="bottom-nav">
  <div class="nav-item active" id="nav-0" onclick="goPage(0)">
    <div class="nav-pip"></div>
    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6"/>
    </svg>
    Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  </div>
  <div class="nav-item" id="nav-1" onclick="goPage(1)">
    <div class="nav-pip"></div>
    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path d="M12 4v16m8-8H4"/>
    </svg>
    Ø£ÙˆØ±Ø¯Ø±
  </div>
  <div class="nav-item" id="nav-2" onclick="goPage(2)">
    <div class="nav-pip"></div>
    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
    </svg>
    Ø§Ù„Ø³Ø¬Ù„Ø§Øª
  </div>
  <div class="nav-item" id="nav-3" onclick="goPage(3)">
    <div class="nav-pip"></div>
    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
      <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
    </svg>
    Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  </div>
</nav>

<!-- ========================= EDIT MODAL ========================= -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</div>
    <input type="hidden" id="edit-id">
    <div class="form-group">
      <label class="form-label">ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
      <input type="text" class="form-input" id="edit-address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
    </div>
    <div class="form-group">
      <label class="form-label">ğŸ“± Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
      <input type="tel" class="form-input" id="edit-phone" placeholder="Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„">
    </div>
    <div class="form-group">
      <label class="form-label">ğŸ’° Ø«Ù…Ù† Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø§Ù„ÙƒÙ„ÙŠ</label>
      <input type="number" class="form-input" id="edit-total" inputmode="numeric">
    </div>
    <div class="form-group">
      <label class="form-label">ğŸ›µ Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</label>
      <input type="number" class="form-input" id="edit-delivery" inputmode="numeric">
    </div>
    <div class="form-group">
      <label class="form-label">ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
      <div class="select-row">
        <button class="select-opt active cash" id="edit-opt-cash" onclick="selectEditPayment('cash')">ğŸ’µ ÙƒØ§Ø´</button>
        <button class="select-opt" id="edit-opt-visa" onclick="selectEditPayment('visa')">ğŸ’³ ÙÙŠØ²Ø§</button>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="saveEdit()">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="btn btn-outline" onclick="closeModal('editModal')">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- ========================= CONFIRM MODAL ========================= -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div style="text-align:center;padding:10px 0 20px;">
      <div style="font-size:52px;margin-bottom:12px;" id="confirmIcon">âš ï¸</div>
      <div class="modal-title" id="confirmTitle" style="text-align:center;"></div>
      <div style="font-size:13px;color:var(--text2);margin-top:4px;" id="confirmMsg"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-danger" id="confirmOkBtn">ØªØ£ÙƒÙŠØ¯</button>
      <button class="btn btn-outline" onclick="closeModal('confirmModal')">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- ========================= INSTALL MODAL ========================= -->
<div class="modal-overlay" id="installModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ“² ØªØ«Ø¨ÙŠØª Nabil Pro</div>
    <div id="installContent"></div>
    <div style="margin-top:14px;">
      <button class="btn btn-outline" onclick="closeModal('installModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// âš ï¸  FIREBASE CONFIG - Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§
// ============================================================
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyAikfw9vS3PJQgaWl6SrpcOSG34B5vyXPc",
  authDomain:        "nabil-pro.firebaseapp.com",
  projectId:         "nabil-pro",
  storageBucket:     "nabil-pro.firebasestorage.app",
  messagingSenderId: "82099030853",
  appId:             "1:82099030853:web:89de9eabad2cc53817cc2c"
};

// Check if Firebase is configured
const FB_CONFIGURED = !Object.values(FIREBASE_CONFIG).some(v => v.includes('YOUR_'));

// ============================================================
// DEVICE ID - Ù‡ÙˆÙŠØ© Ø§Ù„Ø¬Ù‡Ø§Ø² (Ù…Ø¤Ù‚ØªØ© Ø­ØªÙ‰ Ø¥Ø¶Ø§ÙØ© Auth)
// ============================================================
// Ù†Ø³ØªØ®Ø¯Ù… sessionStorage ÙÙ‚Ø· Ù„Ù€ device ID Ù…Ø´ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
let DRIVER_ID = sessionStorage.getItem('nabil_driver_id');
if (!DRIVER_ID) {
  DRIVER_ID = 'driver_' + Math.random().toString(36).substr(2, 9);
  sessionStorage.setItem('nabil_driver_id', DRIVER_ID);
}

// ============================================================
// FIREBASE INIT
// ============================================================
let db = null;
let appState = { online: false, driverName: 'Ù…Ù†Ø¯ÙˆØ¨ Ø¯Ù„ÙŠÙØ±ÙŠ', themeMode: 'dark' };
let ordersCache = [];
let restaurantsCache = [];

// Firestore references
let ordersRef, restaurantsRef, settingsRef;

function initFirebase() {
  if (!FB_CONFIGURED) return false;
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.firestore();
    // Enable offline persistence
    db.enablePersistence({ synchronizeTabs: true }).catch(err => {
      console.log('Persistence error:', err.code);
    });
    ordersRef = db.collection('orders').where('driverId', '==', DRIVER_ID);
    restaurantsRef = db.collection('restaurants').where('driverId', '==', DRIVER_ID);
    settingsRef = db.collection('settings').doc(DRIVER_ID);
    return true;
  } catch (e) {
    console.error('Firebase init error:', e);
    return false;
  }
}

// ============================================================
// SETTINGS - Firestore
// ============================================================
async function loadSettings() {
  if (!db) return;
  try {
    const doc = await settingsRef.get();
    if (doc.exists) {
      const data = doc.data();
      appState.driverName = data.driverName || 'Ù…Ù†Ø¯ÙˆØ¨ Ø¯Ù„ÙŠÙØ±ÙŠ';
      appState.themeMode = data.themeMode || 'dark';
    }
    updateDriverUI();
    applyTheme(appState.themeMode);
  } catch (e) { console.log('Settings load error:', e); }
}

async function saveSettings(updates) {
  if (!db) return;
  Object.assign(appState, updates);
  try {
    await settingsRef.set(appState, { merge: true });
  } catch (e) { console.log('Settings save error:', e); }
}

function updateDriverUI() {
  const name = appState.driverName;
  const el1 = document.getElementById('driverNameDisplay');
  const el2 = document.getElementById('settingsDriverName');
  if (el1) el1.textContent = name;
  if (el2) el2.textContent = name;
}

// ============================================================
// RESTAURANTS - Firestore
// ============================================================
const DEFAULT_RESTAURANTS = [
  { name: 'Ù…Ø§ÙƒØ¯ÙˆÙ†Ø§Ù„Ø¯Ø²', active: true },
  { name: 'KFC', active: true },
  { name: 'Ø¨ÙŠØªØ²Ø§ Ù‡Øª', active: true },
  { name: 'Ø³ÙˆØ´ÙŠ Ø³ÙˆØ´ÙŠ', active: true },
];

async function loadRestaurants() {
  if (!db) return;
  try {
    setFbStatus('syncing', 'ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…...');
    const snap = await restaurantsRef.get();
    if (snap.empty) {
      // First time: seed defaults
      await seedDefaultRestaurants();
    } else {
      restaurantsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }
    renderRestChips();
    renderSettings();
  } catch (e) {
    console.log('Restaurants load error:', e);
    setFbStatus('offline', 'ğŸ“´ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…');
  }
}

async function seedDefaultRestaurants() {
  const batch = db.batch();
  DEFAULT_RESTAURANTS.forEach(r => {
    const ref = db.collection('restaurants').doc();
    batch.set(ref, { ...r, driverId: DRIVER_ID, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  });
  await batch.commit();
  // Reload
  const snap = await restaurantsRef.get();
  restaurantsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

async function addRestaurant() {
  const name = document.getElementById('newRestName').value.trim();
  if (!name) { showToast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…!'); return; }
  if (!db) { showToast('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØµÙ„'); return; }
  try {
    const docRef = await db.collection('restaurants').add({
      name, active: true, driverId: DRIVER_ID,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    restaurantsCache.push({ id: docRef.id, name, active: true, driverId: DRIVER_ID });
    document.getElementById('newRestName').value = '';
    renderRestChips();
    renderSettings();
    showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ' + name);
  } catch (e) {
    showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
    console.log(e);
  }
}

async function toggleRest(id) {
  const r = restaurantsCache.find(x => x.id === id);
  if (!r) return;
  r.active = !r.active;
  try {
    await db.collection('restaurants').doc(id).update({ active: r.active });
    renderSettings();
    renderRestChips();
  } catch (e) { showToast('âŒ Ø®Ø·Ø£'); }
}

async function deleteRest(id) {
  customConfirm('ğŸª', 'Ø­Ø°Ù Ø§Ù„Ù…Ø·Ø¹Ù…', 'Ù‡ÙŠØªØ­Ø°Ù Ø§Ù„Ù…Ø·Ø¹Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ù…ØªØ£ÙƒØ¯ØŸ', async () => {
    try {
      await db.collection('restaurants').doc(id).delete();
      restaurantsCache = restaurantsCache.filter(r => r.id !== id);
      renderSettings();
      renderRestChips();
      showToast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø·Ø¹Ù…');
    } catch (e) { showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù'); }
  });
}

function getActiveRestaurants() {
  return restaurantsCache.filter(r => r.active);
}

// ============================================================
// ORDERS - Firestore
// ============================================================
function listenToOrders() {
  if (!db) return;
  setFbStatus('syncing', 'ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');
  // Listen to all orders for this driver, ordered by timestamp
  db.collection('orders')
    .where('driverId', '==', DRIVER_ID)
    .orderBy('timestamp', 'desc')
    .onSnapshot(snap => {
      ordersCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setFbStatus('online', 'ğŸ”¥ Firebase Ù…ØªØµÙ„ â€¢ ' + ordersCache.length + ' Ø£ÙˆØ±Ø¯Ø±');
      renderDashboard();
      if (currentPage === 2) renderOrders(currentFilter);
    }, err => {
      console.log('Orders listener error:', err);
      setFbStatus('offline', 'ğŸ“´ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
    });
}

async function saveOrder() {
  const address = document.getElementById('inp-address').value.trim();
  const phone = document.getElementById('inp-phone').value.trim();
  const total = parseFloat(document.getElementById('inp-total').value);
  const delivery = parseFloat(document.getElementById('inp-delivery').value);

  if (!selectedRest) { showToast('Ø§Ø®ØªØ§Ø± Ù…Ø·Ø¹Ù… Ø£ÙˆÙ„!'); return; }
  if (!address) { showToast('Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†!'); return; }
  if (!phone) { showToast('Ø§ÙƒØªØ¨ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„!'); return; }
  if (!total || total <= 0) { showToast('Ø§ÙƒØªØ¨ Ø«Ù…Ù† Ø§Ù„Ø£ÙˆØ±Ø¯Ø±!'); return; }
  if (!delivery || delivery < 0) { showToast('Ø§ÙƒØªØ¨ Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„!'); return; }
  if (delivery > total) { showToast('Ø§Ù„ØªÙˆØµÙŠÙ„ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø£ÙˆØ±Ø¯Ø±!'); return; }
  if (!db) { showToast('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØµÙ„'); return; }

  const rest = restaurantsCache.find(r => r.id === selectedRest);
  const btn = document.getElementById('saveOrderBtn');
  btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
  btn.disabled = true;

  try {
    await db.collection('orders').add({
      restId: selectedRest,
      restName: rest ? rest.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
      address, phone, total, delivery,
      restAmount: total - delivery,
      payment: selectedPayment,
      driverId: DRIVER_ID,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ÙÙŠ Firebase!');
    clearForm();
    // Go to home to see update
    goPage(0);
  } catch (e) {
    showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + e.message);
    console.log(e);
  } finally {
    btn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±';
    btn.disabled = false;
  }
}

async function saveEdit() {
  const id = document.getElementById('edit-id').value;
  const address = document.getElementById('edit-address').value.trim();
  const phone = document.getElementById('edit-phone').value.trim();
  const total = parseFloat(document.getElementById('edit-total').value);
  const delivery = parseFloat(document.getElementById('edit-delivery').value);

  if (!address || !phone || !total || !delivery) { showToast('Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!'); return; }
  if (!db) return;

  try {
    await db.collection('orders').doc(id).update({
      address, phone, total, delivery,
      restAmount: total - delivery,
      payment: editPayment
    });
    closeModal('editModal');
    showToast('âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„!');
  } catch (e) {
    showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
  }
}

async function deleteOrder(id) {
  customConfirm('ğŸ—‘ï¸', 'Ø­Ø°Ù Ø§Ù„Ø£ÙˆØ±Ø¯Ø±', 'Ù…Ø´ Ù‡ØªØ±Ø¬Ø¹ ØªØ§Ù†ÙŠØŒ Ù…ØªØ£ÙƒØ¯ØŸ', async () => {
    try {
      await db.collection('orders').doc(id).delete();
      showToast('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù');
    } catch (e) { showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù'); }
  });
}

async function clearTodayOrders() {
  const today = new Date().toDateString();
  const todayOrders = ordersCache.filter(o => {
    const ts = o.timestamp?.toDate ? o.timestamp.toDate() : new Date(o.timestamp);
    return ts.toDateString() === today;
  });
  customConfirm('âš ï¸', 'Ø­Ø°Ù Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…', `Ù‡ØªØªØ­Ø°Ù ${todayOrders.length} Ø£ÙˆØ±Ø¯Ø±ØŒ Ù…ØªØ£ÙƒØ¯ØŸ`, async () => {
    try {
      const batch = db.batch();
      todayOrders.forEach(o => batch.delete(db.collection('orders').doc(o.id)));
      await batch.commit();
      showToast('âœ… ØªÙ… Ø­Ø°Ù Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…');
    } catch (e) { showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù'); }
  });
}

async function clearAllOrders() {
  customConfirm('ğŸš¨', 'Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª', 'Ù‡ØªØªÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!', async () => {
    try {
      const batch = db.batch();
      ordersCache.forEach(o => batch.delete(db.collection('orders').doc(o.id)));
      await batch.commit();
      showToast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª');
    } catch (e) { showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù'); }
  });
}

// ============================================================
// FIREBASE STATUS UI
// ============================================================
function setFbStatus(type, text) {
  const el = document.getElementById('fbStatus');
  const dot = document.getElementById('onlineDot');
  if (!el) return;
  el.className = 'firebase-status ' + type;
  el.querySelector('.status-dot').className = 'status-dot' + (type === 'syncing' ? ' pulse' : '');
  document.getElementById('fbStatusText').textContent = text;
  if (dot) {
    dot.className = type === 'online' ? 'online-dot' : type === 'offline' ? 'online-dot offline-dot' : 'online-dot';
  }
  appState.online = type === 'online';
}

// ============================================================
// DASHBOARD RENDER
// ============================================================
function renderDashboard() {
  const today = new Date().toDateString();
  const todayOrders = ordersCache.filter(o => {
    const ts = o.timestamp?.toDate ? o.timestamp.toDate() : new Date(o.timestamp || Date.now());
    return ts.toDateString() === today;
  });

  const cashOrders = todayOrders.filter(o => o.payment === 'cash');
  const visaOrders = todayOrders.filter(o => o.payment === 'visa');

  const totalProfit = todayOrders.reduce((s, o) => s + (o.delivery || 0), 0);
  const totalCashCollected = cashOrders.reduce((s, o) => s + (o.total || 0), 0);
  const visaEarnings = visaOrders.reduce((s, o) => s + (o.delivery || 0), 0);

  animateNumber('stat-orders', todayOrders.length, '', 500);
  animateNumber('stat-profit', totalProfit, ' Ø¬', 600);
  animateNumber('stat-cash', totalCashCollected, ' Ø¬', 700);
  animateNumber('stat-visa-earn', visaEarnings, ' Ø¬', 800);

  // Shift report
  const rests = {};
  todayOrders.forEach(o => {
    if (!rests[o.restName]) rests[o.restName] = { cash: 0, visa: 0, delivery: 0, orders: 0 };
    rests[o.restName].orders++;
    rests[o.restName].delivery += (o.delivery || 0);
    if (o.payment === 'cash') rests[o.restName].cash += (o.restAmount || 0);
    else rests[o.restName].visa += (o.delivery || 0);
  });

  const cashToRestaurant = cashOrders.reduce((s, o) => s + (o.restAmount || 0), 0);

  let report = '';
  Object.entries(rests).forEach(([name, data]) => {
    const netToRest = data.cash - data.visa;
    report += `
      <div class="report-row">
        <span class="report-key">ğŸª ${name} <span style="color:var(--primary);font-size:11px;">(${data.orders} Ø£ÙˆØ±Ø¯Ø±)</span></span>
        <span class="report-val ${netToRest >= 0 ? 'orange' : 'green'}">
          ${netToRest >= 0 ? 'ØªÙˆØ±ÙŠØ¯ ' + netToRest : 'ÙŠÙƒØ³Ø¨ ' + Math.abs(netToRest)} Ø¬
        </span>
      </div>`;
  });

  if (!report) {
    document.getElementById('shiftReport').innerHTML =
      '<div style="color:var(--text2);font-size:13px;text-align:center;padding:10px;">Ù„Ø§ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯ ğŸ•</div>';
  } else {
    report += `
      <div class="report-row" style="margin-top:8px;border-top:2px solid var(--primary);padding-top:8px;">
        <span class="report-key" style="font-weight:800;color:var(--text)">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø±Ø¨Ø§Ø­Ùƒ</span>
        <span class="report-val green" style="font-size:18px;">${totalProfit} Ø¬</span>
      </div>
      <div class="report-row">
        <span class="report-key" style="font-weight:800;color:var(--text)">ğŸª ØªÙˆØ±ÙŠØ¯ ØµØ§ÙÙŠ Ù„Ù„Ù…Ø·Ø§Ø¹Ù…</span>
        <span class="report-val orange">${Math.max(0, cashToRestaurant - visaEarnings)} Ø¬</span>
      </div>`;
    document.getElementById('shiftReport').innerHTML = report;
  }

  // Recent orders (last 3 today)
  const recent = todayOrders.slice(0, 3);
  document.getElementById('recentOrders').innerHTML = recent.length
    ? recent.map(o => renderOrderCard(o, true)).join('')
    : '<div class="empty" style="padding:20px"><div class="empty-icon">ğŸ›µ</div><div class="empty-text">Ø§Ø³ØªÙ†Ù‰ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø§Ù„Ø£ÙˆÙ„</div></div>';
}

// Animate number change
function animateNumber(id, target, suffix, delay) {
  const el = document.getElementById(id);
  if (!el) return;
  setTimeout(() => {
    el.textContent = target + suffix;
  }, delay);
}

// ============================================================
// ORDERS LIST
// ============================================================
let currentFilter = 'all';

function filterOrders(type, el) {
  currentFilter = type;
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderOrders(type);
}

function renderOrders(filter) {
  let orders = [...ordersCache];
  const today = new Date().toDateString();
  const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);

  if (filter === 'today') orders = orders.filter(o => {
    const ts = o.timestamp?.toDate ? o.timestamp.toDate() : new Date(o.timestamp || 0);
    return ts.toDateString() === today;
  });
  else if (filter === 'week') orders = orders.filter(o => {
    const ts = o.timestamp?.toDate ? o.timestamp.toDate() : new Date(o.timestamp || 0);
    return ts >= weekAgo;
  });
  else if (filter === 'cash') orders = orders.filter(o => o.payment === 'cash');
  else if (filter === 'visa') orders = orders.filter(o => o.payment === 'visa');

  const container = document.getElementById('ordersList');
  if (!container) return;
  if (!orders.length) {
    container.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Ù„Ø§ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ù‡Ù†Ø§</div><div class="empty-sub">Ø¬Ø±Ø¨ ÙÙ„ØªØ± ØªØ§Ù†ÙŠ</div></div>`;
    return;
  }
  container.innerHTML = orders.map(o => renderOrderCard(o, false)).join('');
}

function renderOrderCard(o, mini) {
  const ts = o.timestamp?.toDate ? o.timestamp.toDate() : new Date(o.timestamp || Date.now());
  const timeStr = ts.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
  const dateStr = ts.toLocaleDateString('ar-EG');
  const isVisa = o.payment === 'visa';

  return `<div class="order-card ${isVisa ? 'visa-card' : ''}">
    <div class="order-header">
      <span class="order-rest">ğŸª ${o.restName}</span>
      <span class="order-time">${dateStr} ${timeStr}</span>
    </div>
    <div class="order-address">ğŸ“ ${o.address}</div>
    <div class="order-phone">ğŸ“± ${o.phone}</div>
    <div class="order-amounts">
      <span class="amount-tag tag-total">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${o.total} Ø¬</span>
      <span class="amount-tag tag-delivery">ØªÙˆØµÙŠÙ„: ${o.delivery} Ø¬</span>
      <span class="amount-tag tag-rest">Ù…Ø·Ø¹Ù…: ${o.restAmount} Ø¬</span>
      <span class="amount-tag ${isVisa ? 'tag-visa' : 'tag-cash'}">${isVisa ? 'ğŸ’³ ÙÙŠØ²Ø§' : 'ğŸ’µ ÙƒØ§Ø´'}</span>
    </div>
    ${!mini ? `<div class="order-actions">
      <button class="small-btn wa" onclick="sendWhatsappForOrder(${JSON.stringify(o).replace(/"/g,'&quot;')})">ğŸ“² ÙˆØ§ØªØ³Ø§Ø¨</button>
      <button class="small-btn edit" onclick="openEdit('${o.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      <button class="small-btn del" onclick="deleteOrder('${o.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    </div>` : ''}
  </div>`;
}

// ============================================================
// EDIT ORDER
// ============================================================
function openEdit(id) {
  const o = ordersCache.find(x => x.id === id);
  if (!o) return;
  document.getElementById('edit-id').value = id;
  document.getElementById('edit-address').value = o.address || '';
  document.getElementById('edit-phone').value = o.phone || '';
  document.getElementById('edit-total').value = o.total || '';
  document.getElementById('edit-delivery').value = o.delivery || '';
  editPayment = o.payment || 'cash';
  selectEditPayment(editPayment);
  document.getElementById('editModal').classList.add('open');
}

// ============================================================
// SETTINGS RENDER
// ============================================================
function renderSettings() {
  // Restaurants
  const restListEl = document.getElementById('restList');
  if (restListEl) {
    restListEl.innerHTML = restaurantsCache.map(r => `
      <div class="rest-item">
        <span class="rest-name">${r.name}</span>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="rest-toggle ${r.active ? 'on' : ''}" onclick="toggleRest('${r.id}')"></button>
          <button class="trash-btn" onclick="deleteRest('${r.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>
    `).join('') || '<p style="color:var(--text2);font-size:13px;text-align:center;padding:10px;">Ù„Ø§ Ù…Ø·Ø§Ø¹Ù…. Ø£Ø¶Ù Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰.</p>';
  }

  // Firebase info
  const fbInfoEl = document.getElementById('fbInfo');
  if (fbInfoEl) {
    const today = new Date().toDateString();
    const todayCount = ordersCache.filter(o => {
      const ts = o.timestamp?.toDate ? o.timestamp.toDate() : new Date(o.timestamp || 0);
      return ts.toDateString() === today;
    }).length;
    fbInfoEl.innerHTML = `
      ğŸ”¥ Ø­Ø§Ù„Ø©: <strong style="color:${appState.online ? 'var(--success)' : 'var(--danger)'}">
        ${appState.online ? 'Ù…ØªØµÙ„ âœ…' : 'ØºÙŠØ± Ù…ØªØµÙ„ âŒ'}
      </strong><br>
      ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª: <strong style="color:var(--text)">${ordersCache.length}</strong><br>
      ğŸ“… Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ù‡: <strong style="color:var(--primary)">${todayCount}</strong><br>
      ğŸ—„ï¸ Ø§Ù„ØªØ®Ø²ÙŠÙ†: <strong style="color:var(--text)">Firebase Firestore</strong><br>
      ğŸ‘¤ Driver ID: <strong style="color:var(--text2);font-size:11px;">${DRIVER_ID}</strong>
    `;
  }

  // Theme buttons
  ['auto','dark','light'].forEach(m => {
    const el = document.getElementById('theme-' + m);
    if (el) el.className = 'select-opt' + (m === appState.themeMode ? ' active orange' : '');
  });
}

// ============================================================
// RESTAURANT CHIPS
// ============================================================
let selectedRest = null;

function renderRestChips() {
  const active = getActiveRestaurants();
  const container = document.getElementById('restChips');
  if (!container) return;
  if (!active.length) {
    container.innerHTML = '<p style="color:var(--text2);font-size:13px;">Ù„Ø§ Ù…Ø·Ø§Ø¹Ù… Ù†Ø´Ø·Ø©. Ø£Ø¶Ù Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</p>';
    return;
  }
  if (!selectedRest || !active.find(r => r.id === selectedRest)) {
    selectedRest = active[0].id;
  }
  container.innerHTML = active.map(r => `
    <button class="rest-chip ${r.id === selectedRest ? 'active' : ''}" onclick="selectRest('${r.id}')">${r.name}</button>
  `).join('');
}

function selectRest(id) {
  selectedRest = id;
  renderRestChips();
}

// ============================================================
// PAYMENT
// ============================================================
let selectedPayment = 'cash';

function selectPayment(type) {
  selectedPayment = type;
  document.getElementById('opt-cash').className = 'select-opt' + (type === 'cash' ? ' active cash' : '');
  document.getElementById('opt-visa').className = 'select-opt' + (type === 'visa' ? ' active visa' : '');
  const note = document.getElementById('paymentNote');
  if (type === 'visa') {
    note.style.display = 'block';
    note.innerHTML = `<div class="payment-note">ğŸ’³ <strong>Ø¯ÙØ¹ Ù…Ø³Ø¨Ù‚:</strong> Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¯ÙØ¹ Ù„Ù„Ù…Ø·Ø¹Ù… Ù…Ø¨Ø§Ø´Ø±Ø©. Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø·Ø¹Ù… ÙˆÙŠØ®ØµÙ…Ù‡ Ù…Ù† Ø§Ù„ÙƒØ§Ø´.</div>`;
  } else {
    note.style.display = 'none';
  }
}

let editPayment = 'cash';
function selectEditPayment(type) {
  editPayment = type;
  document.getElementById('edit-opt-cash').className = 'select-opt' + (type === 'cash' ? ' active cash' : '');
  document.getElementById('edit-opt-visa').className = 'select-opt' + (type === 'visa' ? ' active visa' : '');
}

// ============================================================
// WHATSAPP
// ============================================================
function getGreeting() {
  const h = new Date().getHours();
  return h >= 5 && h < 12 ? 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±' : 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±';
}

function sendWhatsapp() {
  const phone = document.getElementById('inp-phone').value.trim();
  if (!phone) { showToast('Ø§ÙƒØªØ¨ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„!'); return; }
  const rest = restaurantsCache.find(r => r.id === selectedRest);
  const restName = rest ? rest.name : 'Ø§Ù„Ù…Ø·Ø¹Ù…';
  sendWaMessage(phone, restName);
}

function sendWhatsappForOrder(o) {
  sendWaMessage(o.phone, o.restName);
}

function sendWaMessage(phone, restName) {
  const greeting = getGreeting();
  const msg = `${greeting} ÙŠØ§ ÙÙ†Ø¯Ù… ğŸ™\nØ£Ù†Ø§ Ù…Ù†Ø¯ÙˆØ¨ ${restName} ğŸ›µ\nÙ…Ù…ÙƒÙ† Ø¨Ø³ Ù„ÙˆÙƒÙŠØ´Ù† ÙˆØ£Ù†Ø§ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù† Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡ âœ¨`;
  let cleanPhone = phone.replace(/[^0-9]/g, '');
  if (cleanPhone.startsWith('0')) cleanPhone = '20' + cleanPhone.substring(1);
  window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
}

function clearForm() {
  ['inp-address', 'inp-phone', 'inp-total', 'inp-delivery'].forEach(id => {
    document.getElementById(id).value = '';
  });
  selectPayment('cash');
}

// ============================================================
// SETUP FIRST TIME
// ============================================================
function saveSetup() {
  const name = document.getElementById('setupDriverName').value.trim() || 'Ù…Ù†Ø¯ÙˆØ¨ Ø¯Ù„ÙŠÙØ±ÙŠ';
  appState.driverName = name;
  if (db) saveSettings({ driverName: name, themeMode: 'dark' });
  document.getElementById('setupModal').classList.remove('show');
  updateDriverUI();
  showToast('ğŸ‰ Ø£Ù‡Ù„Ø§Ù‹ ' + name + '!');
  loadRestaurants();
  listenToOrders();
}

// ============================================================
// THEME
// ============================================================
function applyTheme(mode) {
  appState.themeMode = mode;
  let theme = mode;
  if (mode === 'auto') {
    theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }
  document.body.dataset.theme = theme;
  const btn = document.getElementById('themeBtn');
  if (btn) btn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
  const meta = document.querySelector('meta[name="theme-color"]');
  if (meta) meta.content = theme === 'dark' ? '#0a0f1e' : '#f0f4f8';
}

function toggleTheme() {
  const newMode = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
  setThemeMode(newMode);
}

function setThemeMode(mode) {
  applyTheme(mode);
  saveSettings({ themeMode: mode });
  ['auto','dark','light'].forEach(m => {
    const el = document.getElementById('theme-' + m);
    if (el) el.className = 'select-opt' + (m === mode ? ' active orange' : '');
  });
}

window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
  if (appState.themeMode === 'auto') applyTheme('auto');
});

// ============================================================
// SWIPE NAVIGATION
// ============================================================
let currentPage = 0;
const totalPages = 4;
let touchStartX = 0, touchStartY = 0, touchStartTime = 0;
let isDragging = false, dragDeltaX = 0;

const wrapper = document.getElementById('pagesWrapper');

function goPage(page) {
  currentPage = Math.max(0, Math.min(totalPages - 1, page));
  wrapper.style.transform = `translateX(${currentPage * 25}%)`;

  // Update nav
  document.querySelectorAll('.nav-item').forEach((n, i) => {
    n.classList.toggle('active', i === currentPage);
  });

  // Update dots
  document.querySelectorAll('.dot').forEach((d, i) => {
    d.classList.toggle('active', i === currentPage);
  });

  // Refresh content on visit
  if (currentPage === 0) renderDashboard();
  if (currentPage === 2) renderOrders(currentFilter);
  if (currentPage === 3) { renderSettings(); }
  if (currentPage === 1) renderRestChips();
}

// Touch swipe
const swipeContainer = document.getElementById('swipeContainer');
swipeContainer.addEventListener('touchstart', e => {
  const touch = e.touches[0];
  touchStartX = touch.clientX;
  touchStartY = touch.clientY;
  touchStartTime = Date.now();
  isDragging = false;
  dragDeltaX = 0;
}, { passive: true });

swipeContainer.addEventListener('touchmove', e => {
  if (!e.touches[0]) return;
  const dx = e.touches[0].clientX - touchStartX;
  const dy = e.touches[0].clientY - touchStartY;

  // Only start dragging if horizontal
  if (!isDragging && Math.abs(dx) < Math.abs(dy) * 1.2) return;
  isDragging = true;

  // Prevent vertical scroll during horizontal swipe
  e.preventDefault();

  dragDeltaX = dx;
  const basePct = currentPage * 25;
  const offsetPct = (dx / window.innerWidth) * 25;
  wrapper.classList.add('no-transition');
  wrapper.style.transform = `translateX(${basePct - offsetPct}%)`;
}, { passive: false });

swipeContainer.addEventListener('touchend', e => {
  if (!isDragging) return;
  wrapper.classList.remove('no-transition');

  const elapsed = Date.now() - touchStartTime;
  const velocity = Math.abs(dragDeltaX) / elapsed;
  const threshold = window.innerWidth * 0.25;

  if (dragDeltaX < -threshold || velocity > 0.4 && dragDeltaX < 0) {
    goPage(currentPage + 1);
  } else if (dragDeltaX > threshold || velocity > 0.4 && dragDeltaX > 0) {
    goPage(currentPage - 1);
  } else {
    goPage(currentPage); // snap back
  }
  isDragging = false;
  dragDeltaX = 0;
});

// ============================================================
// CUSTOM CONFIRM
// ============================================================
function customConfirm(icon, title, msg, onOk) {
  document.getElementById('confirmIcon').textContent = icon;
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMsg').textContent = msg;
  document.getElementById('confirmOkBtn').onclick = () => { closeModal('confirmModal'); onOk(); };
  document.getElementById('confirmModal').classList.add('open');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

document.getElementById('editModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal('editModal');
});
document.getElementById('confirmModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal('confirmModal');
});

// ============================================================
// TOAST
// ============================================================
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

// ============================================================
// CLOCK
// ============================================================
function updateClock() {
  const now = new Date();
  const h = now.getHours();
  const greeting = h >= 5 && h < 12 ? 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ğŸ‘‹' : h < 17 ? 'Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ù‡ Ø´ØºØ§Ù„ ğŸ’ª' : 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ğŸ‘‹';
  const el = document.getElementById('welcomeGreet');
  if (el) el.textContent = greeting;
  const timeEl = document.getElementById('welcomeTime');
  if (timeEl) timeEl.textContent = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
}
setInterval(updateClock, 1000);
updateClock();

// ============================================================
// VOICE INPUT
// ============================================================
let recognition = null, activeVoiceBtn = null;

function startVoice(inputId, btn) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) { showToast('âš ï¸ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØµÙˆØªÙŠ Ù…Ø´ Ù…ØªØ§Ø­'); return; }
  if (recognition) {
    recognition.stop();
    if (activeVoiceBtn) { activeVoiceBtn.classList.remove('recording'); activeVoiceBtn.textContent = 'ğŸ™ï¸'; }
    if (activeVoiceBtn === btn) { recognition = null; activeVoiceBtn = null; return; }
  }
  recognition = new SpeechRecognition();
  recognition.lang = 'ar-EG';
  recognition.continuous = false;
  recognition.interimResults = false;
  btn.classList.add('recording'); btn.textContent = 'ğŸ”´';
  activeVoiceBtn = btn;
  recognition.onresult = (e) => {
    document.getElementById(inputId).value = e.results[0][0].transcript;
    btn.classList.remove('recording'); btn.textContent = 'ğŸ™ï¸';
    activeVoiceBtn = null; recognition = null;
  };
  recognition.onerror = () => {
    btn.classList.remove('recording'); btn.textContent = 'ğŸ™ï¸';
    activeVoiceBtn = null; recognition = null;
    showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙˆØª');
  };
  recognition.onend = () => {
    btn.classList.remove('recording'); btn.textContent = 'ğŸ™ï¸';
    activeVoiceBtn = null; recognition = null;
  };
  recognition.start();
}

// ============================================================
// PWA INSTALL
// ============================================================
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  document.getElementById('installBtn').style.display = 'flex';
});
window.addEventListener('appinstalled', () => {
  deferredPrompt = null;
  document.getElementById('installBtn').style.display = 'none';
  showToast('âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚!');
});

function showInstallGuide() {
  const content = document.getElementById('installContent');
  if (deferredPrompt) {
    content.innerHTML = `<p style="font-size:14px;color:var(--text2);margin-bottom:14px;">Ø§Ø¶ØºØ· ØªØ«Ø¨ÙŠØª ÙˆÙ‡ÙŠØªØ¶Ø§Ù Ù„Ø´Ø§Ø´ØªÙƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ğŸ‰</p>
      <button class="btn btn-primary" onclick="triggerInstall()">ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¢Ù†</button>`;
  } else {
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    content.innerHTML = isIOS ? `
      <div style="font-size:13px;color:var(--text2);line-height:2;">
        <div style="background:var(--bg3);border-radius:12px;padding:12px;margin-bottom:10px;">
          <strong style="color:var(--text)">ØªØ«Ø¨ÙŠØª Ø¹Ù„Ù‰ iPhone:</strong><br>
          1ï¸âƒ£ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ğŸ“¤ ÙÙŠ Safari<br>
          2ï¸âƒ£ Ø§Ø®ØªØ± "Add to Home Screen"<br>
          3ï¸âƒ£ Ø§Ø¶ØºØ· Add âœ…
        </div>
      </div>` : `
      <div style="font-size:13px;color:var(--text2);line-height:2;">
        <div style="background:var(--bg3);border-radius:12px;padding:12px;">
          <strong style="color:var(--text)">ØªØ«Ø¨ÙŠØª Ø¹Ù„Ù‰ Android:</strong><br>
          1ï¸âƒ£ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø« â‹® ÙÙŠ Chrome<br>
          2ï¸âƒ£ "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"<br>
          3ï¸âƒ£ Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ© âœ…
        </div>
      </div>`;
  }
  document.getElementById('installModal').classList.add('open');
}

async function triggerInstall() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  if (outcome === 'accepted') showToast('âœ… ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª!');
  deferredPrompt = null;
  document.getElementById('installBtn').style.display = 'none';
  closeModal('installModal');
}

// ============================================================
// ONLINE / OFFLINE DETECTION
// ============================================================
window.addEventListener('online', () => {
  if (appState.online) return;
  showToast('âœ… Ø±Ø¬Ø¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª!');
});
window.addEventListener('offline', () => {
  setFbStatus('offline', 'ğŸ“´ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ù†ØªØ±Ù†Øª - Firebase Offline Mode');
  showToast('ğŸ“´ Ù„Ø§ Ø¥Ù†ØªØ±Ù†Øª - Firebase Ù‡ÙŠØ´ØªØºÙ„ Offline');
});

// ============================================================
// APP INIT
// ============================================================
async function initApp() {
  applyTheme('dark');

  const fbOk = initFirebase();

  if (!fbOk) {
    // Show setup
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('setupModal').classList.add('show');
    return;
  }

  // Load settings first
  await loadSettings();

  // Check if driver has a name
  if (!appState.driverName || appState.driverName === 'Ù…Ù†Ø¯ÙˆØ¨ Ø¯Ù„ÙŠÙØ±ÙŠ') {
    // Check Firestore for existing settings
    const docExists = await settingsRef.get().then(d => d.exists).catch(() => false);
    if (!docExists) {
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('setupModal').classList.add('show');
      return;
    }
  }

  // Load data
  await loadRestaurants();
  listenToOrders();

  // Hide loading
  setTimeout(() => {
    document.getElementById('loadingScreen').style.display = 'none';
  }, 800);

  // Initial render
  goPage(0);
  updateDriverUI();
}

// ============================================================
// SERVICE WORKER
// ============================================================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(e => console.log('SW error:', e));
}

// Start!
initApp();
</script>Ø²
</body>
   </html>Ø§Ù„Ù„Ù‡ 
